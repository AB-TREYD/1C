## Функция СоздатьПроизводствоБезЗаказа(Номенклатура,Количество,Автор,Дата,Признак,ЗаказКлиента="",Склад="",Комментарий = "",Idzak = "") Экспорт      

Создает запрос в ERP (без файлика)

Возвращает структура (внутри "ПБЗ", "Сборка") - тип строки

<details>
  <summary>Код</summary>


          	Если нрег(НСтр(СтрокаСоединенияИнформационнойБазы(), "Ref")) = "stavtzev_ev"  тогда 

            		БазаЕРП = "Stavtzev_erp";
          			#Область Обмен_баз
          			//ОбменБаз = ОрганизацияОбменаМеждуБазами();  
          			//БазаЕРП = ОбменБаз.БазаЕРП;
          			#КонецОбласти 
          			Соединение = Новый HTTPСоединение("1s-1", 80, "admin","21179");
          			УстановитьПривилегированныйРежим(Истина);	
          			Текст = "/"+БазаЕРП+"/ru/hs/auto_pbz?a="+Номенклатура
          			+"&b="+Количество
          			+"&c="+Строка(Автор)
          			+"&d="+Строка(Дата)
          			+"&e="+Строка(Признак)
          			+"&f="+Врег(Строка(ЗаказКлиента))
          			+"&g="+Строка("")  	// Колво в метрах
          			+"&h="+Строка("")	// Колво в штуках   //если потом понадобятся...
          			+"&j="+Строка("")	// Единица измерения заказанного
          			+"&k="+Строка(Склад)	// Единица измерения заказанного
          			+"&l="+Строка(Комментарий)	// комментарий
          			+"&m="+Строка(idzak);	// idzak
          
          			Запрос = Новый HTTPЗапрос(Текст);
          			Результат = Соединение.Получить(Запрос);					
          			УстановитьПривилегированныйРежим(Ложь);
          			//500 - нет номенклатуры или колво = 0
          			//400 - нет спецификации 
          			//300 - ошибка внутри функции
          			//200 - топчик, возвращает номер и дату ПБЗ
          			Если 		Число(Результат.КодСостояния) = 500 тогда 
          				Удачно = Новый Структура("ПБЗ, Сборка","", "");		
          			ИначеЕсли 	Число(Результат.КодСостояния) = 400 тогда     
          				Удачно = Новый Структура("ПБЗ, Сборка","", "");		
          			ИначеЕсли 	Число(Результат.КодСостояния) = 300 тогда
          				Удачно = Новый Структура("ПБЗ, Сборка","", "");		
          			ИначеЕсли 	Число(Результат.КодСостояния) = 200 тогда
          				ПБЗ = СтрЗаменить(Результат.Заголовки.Получить("PBZ"),"?"," ");    
          				ПБЗ = "Производство без заказа "+ Лев(ПБЗ,11)+" от " + Сред(ПБЗ,13);
          				ПБЗ = ?(СтрЗаменить(ПБЗ,"Производство без заказа  от ","")="","",ПБЗ);
          				Сборка= СтрЗаменить(Результат.Заголовки.Получить("SBORKA"),"?"," ");
          				Сборка = "Сборка товаров "+ Лев(Сборка,11)+" от " + Сред(Сборка,13);
          				Сборка = ?(СтрЗаменить(Сборка,"Сборка товаров  от ","")="","",Сборка);
          				Удачно = Новый Структура("ПБЗ, Сборка",ПБЗ, Сборка);
          			Иначе
          				Удачно = Новый Структура("ПБЗ, Сборка","", "");		
          			КонецЕсли;          
          			Возврат Удачно
          	КонецЕсли;


</details>







## #Область Новье_ИДЗАКИ
<details>
  <summary>Код</summary>

## Функция Получить_ТЗ_спецификации(Заказ,ПризнакСпецификации) экспорт

 <details>
          <summary>Код</summary>
      
        Признаки = Перечисления.н_ПризнакСпецификации;
      	
      	Запрос   =  Новый Запрос();
      	Запрос.Текст = 
      	"ВЫБРАТЬ
      	|	Спецификация.НаименованиеМатериала.ПривязкаКERPНовая КАК ПривязкаКERP,
      	|	Спецификация.НормаНа1КМ * &МножительСпецификации КАК НормаНа1КМ,
      	|	Спецификация.НомерЭтапа КАК НомерЭтапа,
      	|	Спецификация.ВидОперации КАК ВидОперации,
      	|	&Отходы КАК Отходы,
      	|	&БЗ КАК БЗ,
      	|	&IDZAKAZA КАК IDZAKAZA,
      	|	&ПризнакСпецификации КАК ПризнакСпецификации
      	|ИЗ
      	|	РегистрСведений.н_Спецификация КАК Спецификация
      	|ГДЕ
      	|	Спецификация.НомерЭтапа <> ""Расчётный""
      	|	И Спецификация.ВидОперации <> ЗНАЧЕНИЕ(Перечисление.ВидОперации.ВолочениеМультивайер)
      	|	И Спецификация.ПризнакСпецификации = &Признак
      	|	И Спецификация.СсылкаНаЗаказ = &Заказ
      	|
      	|УПОРЯДОЧИТЬ ПО
      	|	НомерЭтапа";	
      	
      	Если ПризнакСпецификации="Эталон" тогда //Почему именно так - потеряно и забыто...
      		Признак = ?(Заказ.н_РучнойВводСпецификации = истина,Признаки.НовыйЭталон,Признаки.Эталон)			
      	Иначе
      		Признак = Признаки.Производственная;
      	КонецЕсли; 	                
      	
      	Запрос.УстановитьПараметр("Заказ", Заказ);
      	Запрос.УстановитьПараметр("IDZAKAZA", Заказ.IDZAKAZA);
      	Запрос.УстановитьПараметр("МножительСпецификации", ?(Заказ.КоэффициентСпецификации<>0,Заказ.КоэффициентСпецификации,1));
      	Запрос.УстановитьПараметр("Признак",Признак);
      	Запрос.УстановитьПараметр("ПризнакСпецификации",ПризнакСпецификации);
      	Запрос.УстановитьПараметр("Отходы", ?(Строка(Заказ.Тип)="Отходы",Истина,Ложь));
      	Запрос.УстановитьПараметр("БЗ",		?(СтрНайти(Заказ.НомерСчета,"БЗ")>0,Истина,Ложь));
      	
      	Возврат Запрос.Выполнить().Выгрузить();
  </details>

## Функция ЗаписатьСпецификациюВФайл(ТЗ,ПризнакСпецификации)        

 <details>
      <summary>Код</summary>

    
    	Признак = ?(ПризнакСпецификации = "Производственная", 1,2);
    	ЗаписьXML = Новый ЗаписьXML;
    	ЗаписьXML.ОткрытьФайл("\\dataserv1c\IT-отдел\Obmen\erp_ev\new_spec_"+Признак+".xml");       //\\192.168.99.2\obmen\ExpertV
    	ЗаписьXML.ЗаписатьОбъявлениеXML();
    	ЗаписьXML.ЗаписатьНачалоЭлемента("Материалы");
    	Для каждого СтрокаСпецухи из ТЗ цикл    
    		Индекс = ТЗ.Индекс(СтрокаСпецухи);	
    		ЗаписьXML.ЗаписатьНачалоЭлемента("Значения");    
    		Для каждого Колонка из ТЗ.Колонки Цикл    	
    			ЗаписьXML.ЗаписатьАтрибут(Колонка.Имя, Строка(ТЗ[Индекс][Колонка.Имя]));
    		КонецЦикла;	  
    		ЗаписьXML.ЗаписатьКонецЭлемента();
    	КонецЦикла;	
    	ЗаписьXML.ЗаписатьКонецЭлемента();
    	СтрXML = ЗаписьXML.Закрыть();	
	
</details>

## Функция Проверить_ТЗ_Спецификации(ТЗ_Спецификации) экспорт
	
 <details>
    <summary>Код</summary>

    Возврат ?(ТЗ_Спецификации.Найти(0,"НормаНа1КМ")=Неопределено,Истина,Ложь);
</details>

## Функция Спецификация_Запись_и_Отправка_в_ЕРП(IDZAKAZA,АтрибутыКТекстуЗапроса= "?a=Нет",ТолькоЗаписать = Ложь)  экспорт //Новая

 <details> <summary>Код</summary>

          
                 УстановитьПривилегированныйРежим(Истина);										
                
                	Если не нрег(НСтр(СтрокаСоединенияИнформационнойБазы(), "Ref")) = "danilova_test"  тогда Возврат Неопределено КонецЕсли;	
                	//Атрибут A служит признаком в ЕРП ДЛЯ ПБЗ о дополнении ТЧ материалы и работы или нет! Если = нет тогда не будет дополнять, если истина тогда будет. Дополнение сопровождается с записью ПБЗ
                		
                	
                	Заказы = НайтиНеПомеченныйНаУдалениеЗаказВПроизводство(,IDZAKaza); //копия функции    
                	Если Заказы.Количество() = 1 тогда  
                		Заказ = Заказы[0].СсылкаНаЗаказ;
                		Если нрег(Заказ.НомерСчета) <> "тест" тогда
                			
                			ТЗ_Спецификации_1 = Получить_ТЗ_спецификации(Заказ,"Производственная");
                			ТЗ_Спецификации_2 = Получить_ТЗ_спецификации(Заказ,"Эталон");			
                			
                			Отправлять_1 	= Проверить_ТЗ_Спецификации(ТЗ_Спецификации_1);  
                			Отправлять_2 	= Проверить_ТЗ_Спецификации(ТЗ_Спецификации_2);
                			
                			ЗаписатьСпецификациюВФайл(ТЗ_Спецификации_1,"Производственная");
                			ЗаписатьСпецификациюВФайл(ТЗ_Спецификации_2,"Эталон");
                			
                			Если Отправлять_1 и Отправлять_2 и не ТолькоЗаписать  тогда
                				
                				
                				Соединение = Новый HTTPСоединение("1s-1", 80, "admin","21179");
                				Текст = "/"+ЕрпОбмен.ВернутьБазуЕРП()+"/ru/hs/new_spec"+АтрибутыКТекстуЗапроса;   	
                				
                				Запрос = Новый HTTPЗапрос(Текст);
                				СервисОтвет= Соединение.Получить(Запрос);					
                				
                			Иначе СервисОтвет = Новый структура("КодСостояния",0);
                			КонецЕсли;	                 
                		КонецЕсли;	
                	Иначе 
                		СервисОтвет = Новый структура("КодСостояния",0);
                	КонецЕсли;
                	
                	
                	
                	
                	Возврат ?(СервисОтвет.КодСостояния = 200, Истина, ложь);
                	
                	УстановитьПривилегированныйРежим(Ложь);   
</details>



## Функция НайтиНеПомеченныйНаУдалениеЗаказВПроизводство(ЦПМ=ложь,IDZAKaza) экспорт //копия функции

 <details> <summary>Код</summary>

      
      	
      	Запрос = Новый Запрос;  
      	Запрос.УстановитьПараметр("IDZAKaza", IDZAKaza); 
      	Запрос.Текст = 
      	"ВЫБРАТЬ
      	|	ЗаказыВПроизводство.IDZAKaza КАК IDZAKaza,
      	|	ЗаказыВПроизводство.Ссылка КАК СсылкаНаЗаказ
      	|ИЗ
      	|	Документ.ЗаказыВПроизводство КАК ЗаказыВПроизводство
      	|ГДЕ
      	|	ЗаказыВПроизводство.ПометкаУдаления = ЛОЖЬ
      	|	И ЗаказыВПроизводство.IDZAKaza = &IDZAKaza"; 
      	Если ЦПМ тогда Запрос.Текст = СтрЗаменить(Запрос.Текст,"ЗаказыВПроизводство","ЗаказыВПроизводствоЦПМ") КонецЕсли;
      	Возврат Запрос.Выполнить().Выгрузить();
      	
      	
</details>
</details>
</details>





           
          
          

  
</details>
