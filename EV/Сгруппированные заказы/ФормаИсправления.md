# ФормаИсправления

## ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)

Происходит заполнение данных таблицы на основе элементов массива (переданного из файла и залитого в параметры) и списка заказов из Expert V через две вложенные процедуры: ЗаполнитьТаблицу(...) и СинхронизацияСExcelНаСервере(...)  
Происходит условное оформление полей табличной части

```
ЗаполнитьТаблицу(СинхронизацияСExcelНаСервере(Параметры.МассивИзЭксель).Итог);   
ЭлементУсловногоОформления = УсловноеОформление.Элементы.Добавить();
ЭлементОтбора = ЭлементУсловногоОформления.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
ЭлементОтбора.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Список.Исправлено"); 
ЭлементОтбора.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно; 
ЭлементОтбора.ПравоеЗначение = Истина;
ЭлементОтбора.Использование = Истина;
ЭлементУсловногоОформления.Оформление.УстановитьЗначениеПараметра("ЦветФона",  WebЦвета.ЗеленаяЛужайка);
ЭлементУсловногоОформления.Использование = Истина;
ПолеДляОформления="Список";
ПолеОформления = ЭлементУсловногоОформления.Поля.Элементы.Добавить();
ПолеОформления.Поле = Новый ПолеКомпоновкиДанных(ПолеДляОформления);
ПолеОформления.Использование = Истина;
Если РольДоступна("Администратор") тогда
	Элементы.СписокИсправлено.Видимость = истина;
	Элементы.СписокСсылкаСгруп.Видимость = истина;
	Элементы.СписокПризнак.Видимость = истина;
	Элементы.ТехнологическаяЦепочкаСсылкаЗаказВПроизводство.Видимость = истина;
	Элементы.ТехнологическаяЦепочкаНомерСтроки.Видимость = истина;
КонецЕсли;
```
## ЗаполнитьТаблицу(СписокКЗагрузкеАтрибут)

Заполняет признаками ТЧ из сформированного списка к загрузке, полученного из функции СинхронизацияСExcelНаСервере(...) 
4 признака записи в ТЧ (только те, в которых присутствуют какие-то ошибки:   
- Оборудование не совпадает между EV и Excel (признак 1)
- Заказ Excel отсутствует в EV (признак 2)
- Заказ EV отсутствует в Excel (признак 3)
- Заказ EV ещё на проверке (признак 4)
```
СписокКЗагрузке = СписокКЗагрузкеАтрибут;
СписокКЗагрузке.Колонки.Добавить("ОписаниеОшибки");
СписокКЗагрузке.Колонки.Добавить("Исправлено");    
НайденныеСтроки = СписокКЗагрузке.НайтиСтроки(Новый Структура("Признак",1));
Для каждого Строка из НайденныеСтроки цикл
Строка.ОписаниеОшибки = "Оборудование не совпадает между EV и Excel";
КонецЦикла;
НайденныеСтроки = СписокКЗагрузке.НайтиСтроки(Новый Структура("Признак",2));
Для каждого Строка из НайденныеСтроки цикл
	Строка.ОписаниеОшибки = "Заказ Excel отсутствует в EV";
КонецЦикла;
НайденныеСтроки = СписокКЗагрузке.НайтиСтроки(Новый Структура("Признак",3));
Для каждого Строка из НайденныеСтроки цикл
	Строка.ОписаниеОшибки = "Заказ EV отсутствует в Excel";
КонецЦикла;
НайденныеСтроки = СписокКЗагрузке.НайтиСтроки(Новый Структура("Признак",4));
Для каждого Строка из НайденныеСтроки цикл
	Строка.ОписаниеОшибки = "Заказ EV ещё на проверке";
КонецЦикла;
Список.Загрузить(СписокКЗагрузке );
```
## СинхронизацияСExcelНаСервере(МассивИзЭксель)

Возвращает результат сравнения двух списков: из Excel (загруженный ранее из файла в параметры формы) и из Expert V (который уже в наличии в программе)	
- Первая таблица формируется в функции ПолучитьТаблицуExcel(МассивИзЭксель)	
- Вторая таблица формируется в функции ПолучитьТаблицуEV()	
- Основной код выполняется в функции СравнениеСписковExcelИEV(...), куда передаются оба массива

```
ТаблицаExcel = ПолучитьТаблицуExcel(МассивИзЭксель); 
ТаблицаEV = ПолучитьТаблицуEV();	
РезультатСравнения = СравнениеСписковExcelИEV(ТаблицаExcel, ТаблицаEV);
Возврат РезультатСравнения
```
## ПолучитьТаблицуExcel(МассивИзЭксель)
Фармируем таблицу значений из полученного ранее массива, заменяя строковые значения оборудования в EV на значения ссылочного типа,	
Исключение дублирующих записей в функции ПроверитьВхождение(...) 
```
ТаблицаСоответствия = Новый ТаблицаЗначений;
ТаблицаExcel = Новый ТаблицаЗначений;
ТаблицаСоответствия = ПолучитьТаблицуСоответствия();
ТаблицаExcel.Колонки.Добавить("НаименованиеОборудования");
ТаблицаExcel.Колонки.Добавить("НомерСчёта");
ТаблицаExcel.Индексы.Добавить("НомерСчёта,НаименованиеОборудования");
Счетчик = 0;	
Пока Не МассивИзЭксель[0][Счетчик]=Неопределено Цикл
	ОборудованиеСсылка = ТаблицаСоответствия.НайтиСтроки(Новый Структура("НаименованиеВExcel",МассивИзЭксель[1][Счетчик]))[0].СсылкаВEV;
	Вхождение = ПроверитьВхождение(МассивИзЭксель[0][Счетчик], ОборудованиеСсылка, ТаблицаExcel);
	//Ложь - можно добавить, совпадений нет, Истина - уже есть в ТЗ
	Если не Вхождение Тогда
		//Добавляем
		Стр = ТаблицаExcel.Добавить();
		Стр.НомерСчёта = МассивИзЭксель[0][Счетчик];
		Стр.НаименованиеОБорудования = ОборудованиеСсылка; 
	КонецЕсли;		
	Счетчик = Счетчик + 1;	
КонецЦикла;
Возврат ТаблицаExcel;
```
## ПолучитьТаблицуСоответствия()
Сопоставляем названия оборудования из Excel с названиями в Expert V и заполняем соответствубщую ТЗ

<details>
<summary>Код</summary>
	
	ТЗОборудования = Новый ТаблицаЗначений;
	ТЗОборудования.Колонки.Добавить("НаименованиеВExcel");
	ТЗОборудования.Колонки.Добавить("СсылкаВEV");
	
	Стр = ТЗОборудования.Добавить();	
	Стр.НаименованиеВExcel = "Линия изоляции ХМ 90/25";
	Стр.СсылкаВEV = Справочники.НоменклатураОборудований.НайтиПоКоду("000000024"); //+1
	
	Стр = ТЗОборудования.Добавить();
	Стр.НаименованиеВExcel = "Линия изоляции ХМ 70/25";
	Стр.СсылкаВEV = Справочники.НоменклатураОборудований.НайтиПоКоду("000000021");//+9
	
	Стр = ТЗОборудования.Добавить();	
	Стр.НаименованиеВExcel = "Линия изоляции ХМ 120/25 (изоляция) старый пресс";
	Стр.СсылкаВEV = Справочники.НоменклатураОборудований.НайтиПоКоду("000000017");//+2
	
	Стр = ТЗОборудования.Добавить();
	Стр.НаименованиеВExcel = "Линия изоляции ХМ 120/25 (изоляция) новый пресс";//НОВАЯ
	Стр.СсылкаВEV = Справочники.НоменклатураОборудований.НайтиПоКоду("000000040");//+41
	
	Стр = ТЗОборудования.Добавить();	
	Стр.НаименованиеВExcel = "Линия  ХМ 120/25 +  90/25  Тандем_1";
	Стр.СсылкаВEV = Справочники.НоменклатураОборудований.НайтиПоКоду("000000011");//+21
	
	Стр = ТЗОборудования.Добавить();
	Стр.НаименованиеВExcel = "Линия  ХМ 120/25 + ХМ 120/25  Тандем_2";
	Стр.СсылкаВEV = Справочники.НоменклатураОборудований.НайтиПоКоду("000000013");//+22
	
	Стр = ТЗОборудования.Добавить();	
	Стр.НаименованиеВExcel = "Линия winlong  3х120 - 3 тандем";//НОВАЯ ТРЕХСЛОЙКА
	Стр.СсылкаВEV = Справочники.НоменклатураОборудований.НайтиПоКоду("000000039");//+36
	
	Стр = ТЗОборудования.Добавить();
	Стр.НаименованиеВExcel = "Линия изоляции ХМ 150/25";
	Стр.СсылкаВEV = Справочники.НоменклатураОборудований.НайтиПоКоду("000000019");//+8
	
	Стр = ТЗОборудования.Добавить();	
	Стр.НаименованиеВExcel = "НОВАЯ ЖР";
	Стр.СсылкаВEV = Справочники.НоменклатураОборудований.НайтиПоКоду("000000033");//+26  
	
	Стр = ТЗОборудования.Добавить();
	Стр.НаименованиеВExcel = "СТАРАЯ ЖР"; //Линия скрутки рамочного типа ХМК-500/6+12+18
	Стр.СсылкаВEV = Справочники.НоменклатураОборудований.НайтиПоКоду("000000025"); //+4
	
	Стр = ТЗОборудования.Добавить();	
	Стр.НаименованиеВExcel = "БУГЕЛЬ 1000";
	Стр.СсылкаВEV = Справочники.НоменклатураОборудований.НайтиПоКоду("000000002");//+6
	
	Стр = ТЗОборудования.Добавить();
	Стр.НаименованиеВExcel = "БУГЕЛЬ 1600";
	Стр.СсылкаВEV = Справочники.НоменклатураОборудований.НайтиПоКоду("000000003");//+7
	
	Стр = ТЗОборудования.Добавить();	
	Стр.НаименованиеВExcel = "Драмтвистер";
	Стр.СсылкаВEV = Справочники.НоменклатураОборудований.НайтиПоКоду("000000008");//+17
	
	Стр = ТЗОборудования.Добавить();
	Стр.НаименованиеВExcel = "Сигара";
	Стр.СсылкаВEV = Справочники.НоменклатураОборудований.НайтиПоКоду("000000036");//+3
	
	Стр = ТЗОборудования.Добавить();	
	Стр.НаименованиеВExcel = "Двойная скрутка";
	Стр.СсылкаВEV = Справочники.НоменклатураОборудований.НайтиПоКоду("000000006");//+18
	
	Стр = ТЗОборудования.Добавить();
	Стр.НаименованиеВExcel = "НОВАЯ Двойная скрутка";//ПРОВЕРИТЬ, ВОЗМОЖНО НЕ ЗАВЕДЕНА
	Стр.СсылкаВEV = Справочники.НоменклатураОборудований.НайтиПоКоду("000000041");//+40
	
	Стр = ТЗОборудования.Добавить();
	Стр.НаименованиеВExcel = "Скрутка стренги";
	Стр.СсылкаВEV = Справочники.НоменклатураОборудований.НайтиПоКоду("000000031");//+25
	
	Стр = ТЗОборудования.Добавить();	
	Стр.НаименованиеВExcel = "Лентообмотка вертикальная ";
	Стр.СсылкаВEV = Справочники.НоменклатураОборудований.НайтиПоКоду("000000009");//+19
	
	Стр = ТЗОборудования.Добавить();
	Стр.НаименованиеВExcel = "Лентообмотка горизонтальная";
	Стр.СсылкаВEV = Справочники.НоменклатураОборудований.НайтиПоКоду("000000038");//+20
	
	Стр = ТЗОборудования.Добавить();
	Стр.НаименованиеВExcel = "Бронеобмотчик";
	Стр.СсылкаВEV = Справочники.НоменклатураОборудований.НайтиПоКоду("000000001");//+10
	
	Стр = ТЗОборудования.Добавить();	
	Стр.НаименованиеВExcel = "НОВЫЙ Бронеобмотчик";//ПРОВЕРИТЬ, ВОЗМОЖНО НЕ ЗАВЕДЕН
	Стр.СсылкаВEV = Справочники.НоменклатураОборудований.НайтиПоКоду("000000043");//+12
	
	Стр = ТЗОборудования.Добавить();
	Стр.НаименованиеВExcel = "Волочилка";
	Стр.СсылкаВEV = Справочники.НоменклатураОборудований.НайтиПоКоду("000000032");//+5
	
	Стр = ТЗОборудования.Добавить();
	Стр.НаименованиеВExcel = "НОВАЯ ВОЛОЧИЛКА";
	Стр.СсылкаВEV = Справочники.НоменклатураОборудований.НайтиПоКоду("000000028");//+23
	
	Стр = ТЗОборудования.Добавить();	
	Стр.НаименованиеВExcel = "Мультиваер  ВОЛОЧИЛКА";
	Стр.СсылкаВEV = Справочники.НоменклатураОборудований.НайтиПоКоду("000000027");//+24
	
	Стр = ТЗОборудования.Добавить();
	Стр.НаименованиеВExcel = "Алюминиевая волочилка";
	Стр.СсылкаВEV = Справочники.НоменклатураОборудований.НайтиПоКоду("000000035");//+27
	
	Возврат ТЗОборудования;
</details>

## ПроверитьВхождение(Номер, Оборудование, ТЗ)
Проверяет, есть ли строка с данным счетом и оборудованием в существующей таблице значений
```
Если Не ТЗ.Количество() = 0 Тогда
	Если ТЗ.НайтиСтроки(Новый Структура("НомерСчёта,НаименованиеОборудования",Номер,Оборудование)).Количество()>0 Тогда
		Возврат Истина;
	Иначе
		Возврат Ложь;
	КонецЕсли;			
Иначе     
	Возврат Ложь;
КонецЕсли;
```

## ПолучитьТаблицуEV()
Запросом получает список и выгружает его в таблицу значений из сгруппированнных заказов, где позиция не изготовлена, не на испытании и неБратьВРаботу = Ложь
```
Запрос = Новый Запрос;        	
Запрос.Текст = "ВЫБРАТЬ
|	ДокументСгруппированныеЗаказы.Ссылка КАК Ссылка,
|	ДокументСгруппированныеЗаказы.НомерПриоритета КАК НомерПриоритета,
|	ДокументСгруппированныеЗаказы.НомерСчёта КАК НомерСчёта,
|	ЛОЖЬ КАК ОтметкаВыполнения
|ИЗ
|	Документ.СгруппированныеЗаказы КАК ДокументСгруппированныеЗаказы
|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗаказыВПроизводство КАК ЗаказыВПроизводство
|		ПО ДокументСгруппированныеЗаказы.НомерСчёта = ЗаказыВПроизводство.НомерСчета
|ГДЕ
|	ЗаказыВПроизводство.СтатусЗаказа <> &Изготовлен
|	И ЗаказыВПроизводство.СтатусЗаказа <> &НаИспытании
| 	И ДокументСгруппированныеЗаказы.НеБратьВРаботу = Ложь";

Запрос.УстановитьПараметр("Изготовлен",Перечисления.СтатусыПроизводства.Изготовлен);
Запрос.УстановитьПараметр("НаИспытании",Перечисления.СтатусыПроизводства.НаИспытании); 

РезультатЗапроса = Запрос.Выполнить();
Возврат РезультатЗапроса.Выгрузить();	    
```

## СравнениеСписковExcelИEV(ТаблицаExcel, ТаблицаEV)
//Добавить описание функции//
```
ТаблицаExcel.Колонки.НаименованиеОборудования.Имя = "Оборудование";
Список1 = ТаблицаExcel;
Список2 = ТаблицаEV;
#Область Обрабатываем_ексельный_список
Список3 = Новый таблицаЗначений;
Список3.Колонки.Добавить("НомерСчёта");
Список3.Колонки.Добавить("Оборудование");
Список3.Колонки.Добавить("Признак"); //0,1,2,3: 1 - Не то оборуд, 2 - Нет заказа в EV, 3 - нет заказа в Excel
Для каждого Строка1 из Список1 цикл
	НайденныеСтроки = Список2.НайтиСтроки(Новый Структура("НомерСчёта",Строка1.НомерСчёта)); 
	Если НайденныеСтроки.Количество() тогда
		//Заказа ЕХ есть в ЕВ
		Если НайденныеСтроки[0].Ссылка.ОбщегрупповыеЭтапы.НайтиСтроки(Новый Структура("НаименованиеОборудования",Строка1.Оборудование)).Количество() тогда
			//Оборудование заказа ЕВ совпадает с  ЕХ 
			НайденныеСтроки[0].ОтметкаВыполнения = Истина; 
		Иначе
			//Оборудование заказа ЕВ не совпадает с  ЕХ 
			НовСтрСписок3 						= Список3.Добавить();				 
			НовСтрСписок3.НомерСчёта 			= Строка1.НомерСчёта;
			НовСтрСписок3.Оборудование 			= Строка1.Оборудование;       
			НовСтрСписок3.Признак = 1;
			НайденныеСтроки[0].ОтметкаВыполнения = Истина;							
		КонецЕсли;
	Иначе                       
		Запрос = Новый Запрос;
		Запрос.Текст = 
		"ВЫБРАТЬ ПЕРВЫЕ 1
		|	ЗаказыВПроизводство.Ссылка КАК Ссылка
		|ИЗ
		|	Документ.ЗаказыВПроизводство КАК ЗаказыВПроизводство
		|ГДЕ
		|	ЗаказыВПроизводство.НомерСчета = &НомерСчёта
		|
		|УПОРЯДОЧИТЬ ПО
		|	ЗаказыВПроизводство.Дата УБЫВ";	
		Запрос.УстановитьПараметр("НомерСчёта",Строка1.НомерСчёта);
		РезультатЗапроса = Запрос.Выполнить();
		Если РезультатЗапроса.Выгрузить().Количество() тогда        
			//Заказ ЕХ есть в ЕВ, но он еще не проведён
			НовСтрСписок3 						= Список3.Добавить();				 
			НовСтрСписок3.НомерСчёта 			= Строка1.НомерСчёта;
			НовСтрСписок3.Оборудование 			= Строка1.Оборудование;       
			НовСтрСписок3.Признак = 4;
			//8,11,23
			Список1.Удалить(Строка1); // удаляем строку списка ексель т.к. такой заказ нам не нужен				
		Иначе
			//Заказа ЕХ нет в ЕВ    
			НовСтрСписок3 						= Список3.Добавить();				 
			НовСтрСписок3.НомерСчёта 			= Строка1.НомерСчёта;
			НовСтрСписок3.Оборудование 			= Строка1.Оборудование;       
			НовСтрСписок3.Признак = 2;
		КонецЕсли;
	КонецЕсли;
КонецЦикла;    
#КонецОбласти
#Область Обработка_ев_списка   
Список2отбор = Список2.НайтиСтроки(Новый структура("ОтметкаВыполнения",Ложь));
Для каждого Строка2 из Список2отбор цикл
	НайденныеСтроки = Список1.НайтиСтроки(Новый Структура("НомерСчёта",Строка2.НомерСчёта)); 
	Если НайденныеСтроки.Количество() тогда
		//Заказ ЕВ(Из необработанных заказов) есть в Екселе
		Для каждого строка2тч из строка2.Ссылка.ОбщегрупповыеЭтапы цикл
			Если Строка2ТЧ.НаименованиеОборудования = НайденныеСтроки[0].Оборудование тогда
				//Оборудование одного из этапов заказа ЕВ(из необработанных) совпадает с найденным заказом ЕХ
				Строка2.ОтметкаВыполнения = Истина;
			Иначе
				//Оборудование ни одного из этапов заказа ЕВ(из необработанных) не совпадает с найденным заказом ЕХ
				НовСтрСписок3 						= Список3.Добавить();				 
				НовСтрСписок3.НомерСчёта 			= Строка2.НомерСчёта;
				//Оборудование добавить не можем т.к. оно неизвестно
				НовСтрСписок3.Признак = 1;
			КонецЕсли;
		КонецЦикла;	
	Иначе      
		//Заказа ЕВ(Из необработанных заказов) нет в Екселе
		НовСтрСписок3 						= Список3.Добавить();				 
		НовСтрСписок3.НомерСчёта 			= Строка2.НомерСчёта;			
		//Оборудование добавить не можем т.к. оно неизвестно
		НовСтрСписок3.Признак = 3;
	КонецЕсли;
КонецЦикла;
#КонецОбласти	
Возврат Новый структура("ТаблицаExcel,ТаблицаEV,Итог",Список1,Список2,Список3);
```
