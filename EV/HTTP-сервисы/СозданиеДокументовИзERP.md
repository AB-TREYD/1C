//1. Добавить ИДЗАКАЗА в ЗВП

//2. Добавить ИДЗАКАЗА в ЗВПЦПМ

//3. Добавить этот ХТТП-сервис 

//4. Добавить Администрирование -> Региональные настройки -> Число, Группировка = 0

//5. Добавить в СозданиеДокументаЦПМ и СозданиеДокумента вписание ИДЗАКАЗА     

//6. Отредачить отправку спецификации в ЕРП

 ## Функция   СозданиеДокументовИзERP(Запрос)

 <details> 
   <summary> 
     Код  </summary>
	
	СервисОтвет = Новый HTTPСервисОтвет(200);   
	ПутьКФайлу = СокрЛП(Запрос.ПараметрыЗапроса.Получить("a"));
	
	ЧтениеXML = Новый ЧтениеXML;
	ЧтениеXML.ОткрытьФайл(ПутьКФайлу);
	//Открываем файл	      
	ев_результат = "";  
	
	Пока ЧтениеXML.Прочитать() Цикл  //Цикл по структуре				
		Если ЧтениеXML.ТипУзла = ТипУзлаXML.НачалоЭлемента Тогда  //Определяем начало элемента			
			Если ЧтениеXML.Имя = "Список" или ЧтениеXML.ТипУзла=ТипУзлаXML.КонецЭлемента Тогда	
				Продолжить; 
			ИначеЕсли СтрНайти(ЧтениеXML.Имя,"IDZAKaza_") тогда    
				Попытка  //ЕСЛИ ВОЗНИКАЕТ ОШИБКА, ТО ЧТОБЫ НЕ БЫЛО СЕРВИС-ОТВЕТ=500 ТОГДА ВОЗВРАЩАЕМ НЕУДАЧУ
					НачинкаДокумента = ФормированиеСтруктуры(ЧтениеXML);			
					НачинкаДокумента.Вставить("IDZAKaza",Число(СтрЗаменить(ЧтениеXML.Имя,"IDZAKaza_",""))); //Строка или число, куда конвертировать? 					
					Если ЧтениеXML.ЗначениеАтрибута(11) = "ПерезаполнитьЗаказЕВ" тогда 
						Ответ = ПерезаполнитьЗаказЦКПП(НачинкаДокумента);	
					Иначе	
						Если ЧтениеXML.ЗначениеАтрибута(11) = "ПересоздатьЗаказЕВ" тогда 
							СоздаватьДок = ПометитьНаУдалениеУжеИмеющийсяЗаказЦКПП(НачинкаДокумента.IDZAKaza);	
						Иначе
							СоздаватьДок = Истина;
						КонецЕсли;
						
						Если СоздаватьДок тогда 
							Ответ = СоздатьЗаказВПроизводство(НачинкаДокумента,Если_ЦПМ_то_Истина(НачинкаДокумента.Заказ));  
							//////////////////////////////////ПБЗ - ОТХОДЫ/////////////////////////////////////////////////
							Если НачинкаДокумента.Тип = Перечисления.ТипПродукции.Отходы тогда 
								//ЕрпОбмен.Спецификация_Запись_и_Отправка_в_ЕРП("Производственная",НачинкаДокумента.IDZAKAZA,,Истина);
								ЕрпОбмен.Спецификация_Запись_и_Отправка_в_ЕРП(НачинкаДокумента.IDZAKAZA,,Истина); 							
							КонецЕсли;                                                                                               
							///////////////////////////////////////////////////////////////////////////////////////////////
							//ДОБАВИТЬ ОБЯЗАТЕЛЬНО IDZAKaza в EV
						КонецЕсли;                                          
						//нужно вписать в ответ Идзак + истина/ложь, а на стороне ЕРП забрать и записать в регистр					
					КонецЕсли;
				Исключение
					Ответ = ложь;
				КонецПопытки;
				ев_результат = ев_результат + СтрЗаменить(ЧтениеXML.Имя,"IDZAKaza_","") + "_" + ?(Ответ = истина,"y","n");
			КонецЕсли;
		КонецЕсли;  
	КонецЦикла;   
	ЧтениеXML.Закрыть();  
	СервисОтвет.Заголовки.Вставить("ev_result",ев_результат);
	Возврат СервисОтвет;

</details> 

 ## Функция   Если_ЦПМ_то_Истина(Номенкл)

 <details> 
   <summary> 
     Код  </summary>
	Возврат СтрНайти(НРег(Номенкл), "шина")
	ИЛИ СтрНайти(НРег(Номенкл), "пруток") 
	ИЛИ СтрНайти(НРег(Номенкл), "катанка");
	

</details>

 ## Функция   ПометитьНаУдалениеУжеИмеющийсяЗаказЦКПП(IDZAKaza)           

 <details> 
   <summary> 
     Код  </summary>
	Заказы = ЕрпОбмен.НайтиНеПомеченныйНаУдалениеЗаказВПроизводство(,IDZAKaza);
	Если Заказы.Количество() тогда    
		Заказ = Заказы[0].СсылкаНаЗаказ.ПолучитьОбъект();	              
		Если СтрНайти(Заказ.НомерСчета,"--БЗ") тогда                     
			Заказ.Удалить();			
		Иначе
		//Заказ = Заказы[0].СсылкаНаЗаказ.ПолучитьОбъект();	              
		Заказ.Записать(РежимЗаписиДокумента.ОтменаПроведения);	
		Заказ.ПометкаУдаления=Истина;
		Заказ.Записать();
		КонецЕсли;
	КонецЕсли;
	Возврат ?(ЕрпОбмен.НайтиНеПомеченныйНаУдалениеЗаказВПроизводство(,IDZAKaza).Количество() = 0, Истина,Ложь);

</details>

 ## Функция   ПерезаполнитьЗаказЦКПП(НачинкаДокумента)

 <details> 
   <summary> 
     Код  </summary>
	Заказы = ЕрпОбмен.НайтиНеПомеченныйНаУдалениеЗаказВПроизводство(,НачинкаДокумента.IDZAKaza);
	Если Заказы.Количество() тогда
		Заказ = Заказы[0].СсылкаНаЗаказ.ПолучитьОбъект();
		Заказ.КоличествоКилометровПоЗаказу = НачинкаДокумента.КоличествоКилометровПоЗаказу;   
		Заказ.КоэффициентКонвертации = НачинкаДокумента.КоэффициентКонвертации;   		
		Заказ.н_ПровереноПлановымОтделом = ложь;                    
		Заказ.н_ПринудительныйПересчет = истина;
		Заказ.Записать();
	КонецЕсли;
	Возврат Заказ.Ссылка.КоличествоКилометровПоЗаказу = Число(НачинкаДокумента.КоличествоКилометровПоЗаказу);	
	

</details>


 ## Функция   СоздатьЗаказВПроизводство(Структ,ЦПМ = ложь) экспорт

 <details> 
   <summary> 
     Код  </summary>
	
	РезультатЗапроса = ЕрпОбмен.НайтиНеПомеченныйНаУдалениеЗаказВПроизводство(ЦПМ,Структ.IDZAKaza);
	
	Если РезультатЗапроса.Количество() тогда
		Возврат Истина;	
	Иначе	  
		Если ЦПМ тогда
			ФормированиеРабочихМассивов.СозданиеДокументаЦПМ(Структ);  				
		Иначе			
			ФормированиеРабочихМассивов.СозданиеДокумента(Структ);			
		КонецЕсли;
		ЗаказСоздался = ЕрпОбмен.НайтиНеПомеченныйНаУдалениеЗаказВПроизводство(ЦПМ,Структ.IDZAKaza).Количество();
		Возврат ЗаказСоздался>0;
	КонецЕсли;
	

</details>    

 ## Функция   ФормированиеСтруктуры(XMLФайл)	

 <details> 
   <summary> 
     Код  </summary>
	Номенклатура 			= 	XMLФайл.ЗначениеАтрибута(0);
	ЕдиницаИзмерения 	=		XMLФайл.ЗначениеАтрибута(8); 	
	
	Если не ЕдиницаИзмерения = Неопределено 
		и  (Нрег(сокрЛП(ЕдиницаИзмерения)) = "кг" 
		или Нрег(сокрЛП(ЕдиницаИзмерения)) = "км" 
		или Нрег(сокрЛП(ЕдиницаИзмерения)) = "шт" 
		или Нрег(сокрЛП(ЕдиницаИзмерения)) = "м") Тогда 	
		ЕдиницаИзмерения = Перечисления.ЕдиницаИзмеренияЗаказа[СокрЛП(ЕдиницаИзмерения)];	
	Иначе
		ЕдиницаИзмерения = Перечисления.ЕдиницаИзмеренияЗаказа.ПустаяСсылка();	
	КонецЕсли;
	
	Если Строка(ЕдиницаИзмерения) = "" Тогда
		Если СтрНайти(Нрег(Номенклатура),"(кг)") > 0 Тогда
			
			ЕдиницаИзмерения = Перечисления.ЕдиницаИзмеренияЗаказа.Кг;
			Номенклатура     = СтрЗаменить(Номенклатура,"(Кг)","");
			
		ИначеЕсли СтрНайти(Нрег(Номенклатура),"(шт)")>0 Тогда 
			
			ЕдиницаИзмерения = Перечисления.ЕдиницаИзмеренияЗаказа.Шт;
			Номенклатура     = СтрЗаменить(Номенклатура,"(Шт)",""); 
			
		Иначе 	
			ЕдиницаИзмерения = Перечисления.ЕдиницаИзмеренияЗаказа.Км;
		КонецЕсли; 
	КонецЕсли;                                                 
	
	//-23,08,23 Власов
	
	Структ = Новый Структура;
	Структ.Вставить("Заказ", Номенклатура);
	Структ.Вставить("Марка",                  XMLФайл.ЗначениеАтрибута(15));   
	Структ.Вставить("ЕдиницаИзмеренияЗаказа", ЕдиницаИзмерения); // Кг,Шт,Км      
	Структ.Вставить("КоличествоЖил",          ?(XMLФайл.ЗначениеАтрибута(16)="",0,XMLФайл.ЗначениеАтрибута(16)));
	Структ.Вставить("Сечение",                ?(XMLФайл.ЗначениеАтрибута(17)="",0,XMLФайл.ЗначениеАтрибута(17))); 	
	Тип = СтрЗаменить(XMLФайл.ЗначениеАтрибута(14), " ", "");
	Структ.Вставить("Тип",                    ?(ПустаяСтрока(Тип), Перечисления.ТипПродукции.ПустаяСсылка(), Перечисления.ТипПродукции[Тип])); //+09,11,22
	Структ.Вставить("СечениеЭкрана",          XMLФайл.ЗначениеАтрибута(22));
	Структ.Вставить("Исполнение",             XMLФайл.ЗначениеАтрибута(19));
	Структ.Вставить("npe",                    XMLФайл.ЗначениеАтрибута(21));
	Структ.Вставить("Напряжение",             XMLФайл.ЗначениеАтрибута(18));
	Структ.Вставить("ВариантИсполнения",      ?(ПустаяСтрока(XMLФайл.ЗначениеАтрибута(20)), Справочники.ВидИсполнения.ПустаяСсылка(), Справочники.ВидИсполнения.НайтиПоНаименованию(XMLФайл.ЗначениеАтрибута(20))));
	Структ.Вставить("ПлюсовойКабель",         Булево(?(ПустаяСтрока(XMLФайл.ЗначениеАтрибута(24)), 0, XMLФайл.ЗначениеАтрибута(24))));
	Структ.Вставить("КоличествоЖилПлюсовой",  XMLФайл.ЗначениеАтрибута(26));
	Структ.Вставить("СечениеПлюсовой",        XMLФайл.ЗначениеАтрибута(27));
	Структ.Вставить("Комментарий",            XMLФайл.ЗначениеАтрибута(5));
	Структ.Вставить("Примечание",             XMLФайл.ЗначениеАтрибута(6));
	Структ.Вставить("Намотка",                XMLФайл.ЗначениеАтрибута(7));
	
	Структ.Вставить("ИсполнениеЖилыПлюсовой", ?(ПустаяСтрока(XMLФайл.ЗначениеАтрибута(25)),Справочники.ИсполнениеЖилы.ПустаяСсылка(), Справочники.ИсполнениеЖилы.НайтиПоНаименованию(XMLФайл.ЗначениеАтрибута(25))));
	Структ.Вставить("ИсполнениеЖилы",         ?(Структ.Исполнение<>"",Справочники.ИсполнениеЖилы.НайтиПоНаименованию(Структ.Исполнение),Справочники.ИсполнениеЖилы.ПустаяСсылка()));
	Структ.Вставить("NPE",                    ?(Структ.NPE<>"",Справочники.СправочникNPE.НайтиПоНаименованию(Структ.NPE),Справочники.СправочникNPE.ПустаяСсылка()));
	Структ.Вставить("ПроцентСкидки",          XMLФайл.ЗначениеАтрибута(1));
	Структ.Вставить("РасширениеМарки",        "");
	
	Структ.Вставить("НомерСчёта",                  XMLФайл.ЗначениеАтрибута(2));
	Структ.Вставить("ДатаВыходаПоЗаказу",           XMLФайл.ЗначениеАтрибута(10));  
	Структ.Вставить("Толеранс",                     XMLФайл.ЗначениеАтрибута(9));
	Структ.Вставить("ДобавленИзЕРП",                Истина);
	Структ.Вставить("КомментНеСтандарт",            XMLФайл.ЗначениеАтрибута(12)); 
	Структ.Вставить("БулевоНеСтандарт",             XMLФайл.ЗначениеАтрибута(13));
	Структ.Вставить("ДлинаЗаказа",  XMLФайл.ЗначениеАтрибута(3));
	
	КоэфКонвертации_и_НоваяДлинаЗаказа = ЕрпОбмен.ПоискКоэфициентаКонвертации(Структ);			
	ДлинаЗаказа 	= КоэфКонвертации_и_НоваяДлинаЗаказа.ДлинаЗаказа;
	КоэфКонвертации	= КоэфКонвертации_и_НоваяДлинаЗаказа.КоэфКонвертации;  
	
	Структ.Вставить("КоличествоКилометровПоЗаказу", Строка(ДлинаЗаказа));
	Структ.Вставить("КоэффициентКонвертации", КоэфКонвертации);
	Структ.Вставить("Менеджер",          XMLФайл.ЗначениеАтрибута(28));
	Структ.Вставить("Цвет",         	 XMLФайл.ЗначениеАтрибута(20));
	Структ.Вставить("Контрагент",        XMLФайл.ЗначениеАтрибута(30));
	Возврат Структ;
	//всего 0-28

</details>


