# Процедуры

## Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
```
    ЗаказКлиента                = Параметры.НомерСчета; 
	ТекущаяКоробка              = Параметры.СсылкаНаКоробку;
	ТекущийСгруппированныйЗаказ = Параметры.СсылкаНаСгруппированныйЗаказ;
	ОбъектСменногоЗадания       = Параметры.СсылкаНаСменноеЗадание;
	
	ДатаОбъекта = ТекущаяДата();

	ЗаполнениеТаблицы();   
	Элементы.ТаблицаДокумент_В_ERP.ТолькоПросмотр = Не РольДоступна("Администратор");
``` 

## Процедура ЗаполнениеТаблицы() 

```	
	Для каждого Позиция из Параметры.СсылкаНаКоробку.НоменклатураВКоробке Цикл
		НоваяСтрока = Таблица.Добавить();
		
		НоваяСтрока.Номенклатура     = Позиция.Номенклатура;
		НоваяСтрока.БылоУпаковано_шт = Позиция.КоличествоУпакованного;
		НоваяСтрока.БылоУпаковано_кг = ПодтянутьКоличествоШин(Позиция.КоличествоУпакованного);
	КонецЦикла;  
```  

## Процедура Записать(Команда) 
```
	ЗаписатьКоличествоЗаполненногоВКоробку();
	
	ЗаполнитьРегистрСменногоЗаданиеЦПМФактомУпаковкиНаСервере();
	
	ЗаполнитьУпаковкуВСгруппированныхЗаказаСклада();
	
	ИзменитьСтатусыКоробкиСменногоЗадания();

	ОтправкаТаблицы_Перемещения();
	
	//ЭтаФорма.Закрыть(); Потом мейби закрывать
```

## Процедура ОтправкаТаблицы_Перемещения()

```
	Для каждого Строка из Таблица Цикл 
		
		Если СтрНайти(Строка.Номенклатура, "(м)")>0 тогда 
			Шина=СтрЗаменить(Строка.Номенклатура, " (м)", "");
			Продукция=Справочники.ШиныЦПМ.НайтиПоНаименованию(Шина);		
		КонецЕсли;	                                                              
		Если СтрНайти(Строка.Номенклатура, "(кг)")>0 тогда 
			Шина=СтрЗаменить(Строка.Номенклатура, " (кг)","");
			Продукция=Справочники.ШиныЦПМ.НайтиПоНаименованию(Шина);		
		КонецЕсли;  
		
		//Строка.Документ_В_ERP = ЕРПОбмен.СоздатьПеремещение_В_ERP(Продукция.Код_В_ERP,Строка.Количество_КГ,ДатаОбъекта,ЗаказКлиента,МастерСмены);		
	КонецЦикла;
```

## Процедура ЗаписатьКоличествоЗаполненногоВКоробку()

```
	ОбъектКоробки = ТекущаяКоробка.Ссылка.ПолучитьОбъект();
	
	Для каждого КоробкаОбъекта из ОбъектКоробки.НоменклатураВКоробке Цикл
		Для каждого КоробкаНаФорме из Таблица Цикл
			Если КоробкаОбъекта.Номенклатура = КоробкаНаФорме.Номенклатура Тогда
				КоробкаОбъекта.КоличествоУпакованного = КоробкаНаФорме.БылоУпаковано_шт + КоробкаНаФорме.Количество_шт;
			КонецЕсли;
		КонецЦикла;
	КонецЦикла;
	
	КоробкаУпакована = Ложь;
	Для каждого Шина из ОбъектКоробки.НоменклатураВКоробке Цикл 
		Если Шина.КоличествоУпакованного >= Шина.НужноУпаковать Тогда
			КоробкаУпакована = Истина;   
			Прервать;
		КонецЕсли;
	КонецЦикла;	
	
	ОбъектКоробки.КоробкаУпакованаФакт = КоробкаУпакована; 
	
	ОбъектКоробки.Записать();
```

## Функция ПодтянутьКоличествоШин(КоличествоУпакованного)

```
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ЗаказыВПроизводствоЦПМ.Ссылка КАК Ссылка,
		|	ЗаказыВПроизводствоЦПМ.Высота КАК Высота,
		|	ЗаказыВПроизводствоЦПМ.Ширина КАК Ширина,
		|	ЗаказыВПроизводствоЦПМ.Длина КАК Длина,
		|	ЗаказыВПроизводствоЦПМ.НоменклатураERP КАК НоменклатураERP
		|ИЗ
		|	Документ.ЗаказыВПроизводствоЦПМ КАК ЗаказыВПроизводствоЦПМ
		|ГДЕ
		|	ЗаказыВПроизводствоЦПМ.НомерСчета ПОДОБНО &НомерСчета
		|	И ЗаказыВПроизводствоЦПМ.НоменклатураERP ПОДОБНО &НоменклатураERP";
	
	Запрос.УстановитьПараметр("НоменклатураERP", ТекущийСгруппированныйЗаказ.Номеклатура);
	Запрос.УстановитьПараметр("НомерСчета",      ТекущийСгруппированныйЗаказ.НомерСчета + "%");
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		ДлиннаВКГ = КоличествоУпакованного * (ВыборкаДетальныеЗаписи.Длина * 0.008989 * (ВыборкаДетальныеЗаписи.Высота * ВыборкаДетальныеЗаписи.Ширина));
		Возврат ДлиннаВКГ; 
	КонецЦикла;
	
	Возврат 0;
```

## Процедура ЗаполнитьРегистрСменногоЗаданиеЦПМФактомУпаковкиНаСервере()
```	
	НаборЗаписей = РегистрыНакопления.СменноеЗаданиеЦПМ.СоздатьНаборЗаписей(); 
	
	НаборЗаписей.Отбор.Регистратор.Установить(ОбъектСменногоЗадания);
	
	НаборЗаписей.Записывать = Истина;	
	Для каждого ТекСтрока из Таблица Цикл 
		
		Запись = НаборЗаписей.Добавить(); 
		
		НоменклатураИНомерСчета = ПолучениеНоменклатурыИНомераСчёта(ТекущийСгруппированныйЗаказ);
		
		Запись.Регистратор    = ОбъектСменногоЗадания;
		Запись.Период         = ТекущаяДата();  
		Запись.Дата           = ТекущаяДата();
		Запись.Номенклатура   = НоменклатураИНомерСчета.Номенклатура;
		Запись.НомерСчета     = НоменклатураИНомерСчета.НомерСчета; 
		Запись.УпакованоКГ    = ТекСтрока.Количество_кг;
		Запись.УпакованоКМ    = ТекСтрока.Количество_шт * НоменклатураИНомерСчета.Длина;
		Запись.УпакованоШт    = ТекСтрока.Количество_шт; 
		Запись.ПризнакИзделия = Перечисления.ПризнакПродукции.ГотоваяПродукция; 
	КонецЦикла;
	
	НаборЗаписей.Записать();
```

## Функция ПолучениеНоменклатурыИНомераСчёта(ТекущийСгруппированныйЗаказ)

```
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ЗаказыВПроизводствоЦПМ.Ссылка КАК Ссылка,
		|	ЗаказыВПроизводствоЦПМ.Продукция КАК Продукция,
		|	ЗаказыВПроизводствоЦПМ.НомерСчета КАК НомерСчета,
		|	ЗаказыВПроизводствоЦПМ.Длина КАК Длина
		|ИЗ
		|	Документ.ЗаказыВПроизводствоЦПМ КАК ЗаказыВПроизводствоЦПМ
		|ГДЕ
		|	ЗаказыВПроизводствоЦПМ.НоменклатураERP ПОДОБНО &НоменклатураERP
		|	И ЗаказыВПроизводствоЦПМ.НомерСчета ПОДОБНО &НомерСчета";
	
	Запрос.УстановитьПараметр("НоменклатураERP", ТекущийСгруппированныйЗаказ.Номеклатура);
	Запрос.УстановитьПараметр("НомерСчета",      ТекущийСгруппированныйЗаказ.НомерСчета + "%");
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();

	СтруктураВозврат = Новый Структура;
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		СтруктураВозврат.Вставить("Номенклатура", ВыборкаДетальныеЗаписи.Продукция);
		СтруктураВозврат.Вставить("НомерСчета",   ВыборкаДетальныеЗаписи.НомерСчета);
		СтруктураВозврат.Вставить("Длина",        ВыборкаДетальныеЗаписи.Длина);
	КонецЦикла;
	
	Возврат СтруктураВозврат; 
```

## Процедура ЗаполнитьУпаковкуВСгруппированныхЗаказаСклада()

```
	Для каждого ТекСтрока из Таблица Цикл
		
		Запрос = Новый Запрос;
		Запрос.Текст = 
		"ВЫБРАТЬ
		|	СгруппированныеЗаказыСклад.Ссылка КАК Ссылка,
		|	СгруппированныеЗаказыСклад.Номеклатура КАК Номеклатура,
		|	СгруппированныеЗаказыСклад.НомерСчета КАК НомерСчета
		|ИЗ
		|	Документ.СгруппированныеЗаказыСклад КАК СгруппированныеЗаказыСклад
		|ГДЕ
		|	СгруппированныеЗаказыСклад.Номеклатура ПОДОБНО &Номеклатура
		|	И СгруппированныеЗаказыСклад.НомерСчета ПОДОБНО &НомерСчета";
		
		Запрос.УстановитьПараметр("Номеклатура", ТекСтрока.Номенклатура);
		Запрос.УстановитьПараметр("НомерСчета",  ЗаказКлиента + "%");
		
		РезультатЗапроса = Запрос.Выполнить();
		
		ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
		
		Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
			
			Если ТекСтрока.Номенклатура = ВыборкаДетальныеЗаписи.Номеклатура Тогда 
				
				ОбъектСгрупЗаказа = ВыборкаДетальныеЗаписи.Ссылка.ПолучитьОбъект(); 
				
				ОбъектСгрупЗаказа.УпакованоФакт = ТекСтрока.БылоУпаковано_шт + ТекСтрока.Количество_шт;
				
				Если ОбъектСгрупЗаказа.УпакованоФакт = ОбъектСгрупЗаказа.КоличествоПоЗаказу Тогда
					ИзменитьСтатусВЗаказеНаПроизводствоЦПМ(ОбъектСгрупЗаказа.НомерСчета, ОбъектСгрупЗаказа.Номеклатура);	
				КонецЕсли;
				
				ОбъектСгрупЗаказа.Записать();
			КонецЕсли;
			
		КонецЦикла;
		
		
	КонецЦикла;
``` 

## Процедура ИзменитьСтатусВЗаказеНаПроизводствоЦПМ(НомерСчета, Номенклатура)

```
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ЗаказыВПроизводствоЦПМ.Ссылка КАК Ссылка,
		|	ЗаказыВПроизводствоЦПМ.НоменклатураERP КАК НоменклатураERP,
		|	ЗаказыВПроизводствоЦПМ.НомерСчета КАК НомерСчета
		|ИЗ
		|	Документ.ЗаказыВПроизводствоЦПМ КАК ЗаказыВПроизводствоЦПМ
		|ГДЕ
		|	ЗаказыВПроизводствоЦПМ.НомерСчета ПОДОБНО &НомерСчета
		|	И ЗаказыВПроизводствоЦПМ.НоменклатураERP ПОДОБНО &НоменклатураERP";
	
	Запрос.УстановитьПараметр("НоменклатураERP", Номенклатура);
	Запрос.УстановитьПараметр("НомерСчета",      НомерСчета  + "%");
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		ОбъектЗаказа = ВыборкаДетальныеЗаписи.Ссылка.ПолучитьОбъект();
		
		ОбъектЗаказа.Статус = Перечисления.СтатусыПроизводства.Изготовлен;
		
		ОбъектЗаказа.Записать();
	КонецЦикла;
```

## Процедура ИзменитьСтатусыКоробкиСменногоЗадания() 

```
	ТекущееЗадание = ОбъектСменногоЗадания.Ссылка.ПолучитьОбъект();
	
	Для каждого СтрокаТЧ из ТекущееЗадание.КоробкиСменногоЗадания Цикл
		Если СтрокаТЧ.КоробкиЦПМ = ТекущаяКоробка Тогда
			СтрокаТЧ.КоробкаУпакована = ТекущаяКоробка.КоробкаУпакованаФакт;
		КонецЕсли;
	КонецЦикла;
	
	ТекущееЗадание.Записать();
```

