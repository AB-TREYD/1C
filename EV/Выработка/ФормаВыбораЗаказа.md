

 ## &НаСервере Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)  

 
 <details> 
   <summary> 
     Код  </summary>

	Если Параметры.Свойство("СсылкаНаЗаказ") тогда
		СсылкаНаЗаказ = Параметры.СсылкаНаЗаказ; 
		ЭтаФорма.ФИО=Параметры.ФИО;
		Если Параметры.ГрупповойРезерв="Нет" тогда   
			ЭтаФорма.IDZak 			= Параметры.IDZak;
			НовСтр 					= ДанныеЗаправкиНаОтдатчике.Добавить();  
			ЗаполнитьЗначенияСвойств(НовСтр,Параметры);		
		Иначе          
			//открыть ранее созданное    
			ЭтаФорма.IDZak=ЭтаФорма.Параметры.IDZak;
			РазбитьСтроку(Параметры.ГрупповойРезерв);          
			ОборудованиеИзменилось=Ложь;
			Для каждого стр из ЭтаФорма.ДанныеЗаправкиНаОтдатчике цикл			 
				Если ОборудованиеИзменилось=ложь и Стр.Оборудование<>Параметры.Оборудование тогда
					ОборудованиеИзменилось=Истина;	
				КонецЕсли;
				Стр.Оборудование=Параметры.Оборудование;
				ОбщееКолвоКМ=ОбщееКолвоКМ+Стр.КоличествоКМ;
			КонецЦикла;
			Если ОборудованиеИзменилось тогда     
				Элементы.ДанныеЗаправкиНаОтдатчикеОборудование.Заголовок="Актуальное оборудование";
				Сообщить("Оборудование в заказе изменилось, рассчитанные показатели могут быть неактуальны - рассчитайте данные перед закрытием");	
			КонецЕсли;			
		КонецЕсли;
	КонецЕсли;

</details>                                  


## Процедура РазбитьСтрокуТЧ(Строка)       //Разбивает полученную строку на параметры и вписывает их       
 <details> 
   <summary> 
     Код  </summary>

       НоваяЗапись=ЭтаФорма.ДанныеЗаправкиНаОтдатчике.Добавить();  
    Вхождение0=Найти(Строка,"#"); //номер счета	 
    Вхождение1=Найти(Строка,"ab");//номер этапа
    Вхождение2=Найти(Строка,"bc");//вид операции
    Вхождение3=Найти(Строка,"cd");//оборуд
    Вхождение4=Найти(Строка,"de");//РасценкаЗаСменуИнструмента
    Вхождение5=Найти(Строка,"ef");//РасценкаЗаСменуКатушкиВПриемник
    Вхождение6=Найти(Строка,"fg");//РасценкаЗаСменуКатушкиНаОтдатчике 
    Вхождение7=Найти(Строка, "gh");//РасценкаЗаСменуЦвета
    Вхождение8=Найти(Строка, "hj");//ЦветКуска 
    Вхождение9=Найти(Строка,"jk");//Цена  
    Вхождение10=Найти(Строка, "kl");//КоличествоКМ 
    Вхождение11=Найти(Строка, "lm");//КоэфЗагрОб 
    Вхождение12=Найти(Строка,"mn");//номер операции 
    Вхождение13=Найти(Строка, "no");///номер строки
    Вхождение14=Найти(Строка, "op");///РасценкаЗаСменуПластиката
    Вхождение15=Найти(Строка, "pq");///ЦенаКуска
    Вхождение16=Найти(Строка, "idzak");//idzak  
    
    Вхождение17=Найти(Строка, Символы.ПС);
    
    НоваяЗапись.НомерСчета=Сред(Строка,Вхождение0+1,Вхождение1-1-Вхождение0);
    НоваяЗапись.НомерЭтапа=Сред(Строка,Вхождение1+2,Вхождение2-1-Вхождение1-1);
    
    НоваяЗапись.ВидОперации=Перечисления.ВидОперации[СтрЗаменить(Стрзаменить(Стрзаменить(Сред(Строка,Вхождение2+2,Вхождение3-1-Вхождение2-1)," ",""),"(",""),")","")];
    НоваяЗапись.Оборудование=Справочники.НоменклатураОборудований.НайтиПоКоду(Сред(Строка,Вхождение3+2,Вхождение4-1-Вхождение3-1)); 
    
    НоваяЗапись.РасценкаЗаСменуИнструмента=Сред(Строка,Вхождение4+2,Вхождение5-1-Вхождение4-1);
    НоваяЗапись.РасценкаЗаСменуКатушкиВПриемник=Сред(Строка,Вхождение5+2,Вхождение6-1-Вхождение5-1);    
    НоваяЗапись.РасценкаЗаСменуКатушкиНаОтдатчике=Сред(Строка,Вхождение6+2,Вхождение7-1-Вхождение6-1);  
    НоваяЗапись.РасценкаЗаСменуЦвета=Сред(Строка,Вхождение7+2,Вхождение8-1-Вхождение7-1);  
    
    НоваяЗапись.цветКуска=Справочники.ПереченьЦветовЖил.НайтиПоКоду(Сред(Строка,Вхождение8+2,Вхождение9-1-Вхождение8-1));
    ЭтаФорма.Цена=Сред(Строка,Вхождение9+2,Вхождение10-1-Вхождение9-1);    
    
    НоваяЗапись.КоличествоКМ=Сред(Строка,Вхождение10+2,Вхождение11-1-Вхождение10-1);
    
    ЭтаФорма.КоэфЗагрОб=Сред(Строка,Вхождение11+2,Вхождение12-1-Вхождение11-1);    
    НоваяЗапись.НомерОперации=Сред(Строка,Вхождение12+2,Вхождение13-1-Вхождение12-1);  
    НоваяЗапись.НомерСтроки=Сред(Строка,Вхождение13+2,Вхождение14-1-Вхождение13-1);  
    НоваяЗапись.РасценкаЗаСменуПластиката=Сред(Строка,Вхождение14+2,Вхождение15-1-Вхождение14-1);  
    НоваяЗапись.ЦенаКуска=Сред(Строка,Вхождение15+2,Вхождение16-1-Вхождение15-1);  
    ЭтаФорма.Idzak=Сред(Строка,Вхождение16+5);


</details>

 ## Функция  РазбитьСтроку(Строка)    //Вписывает общие параметры в форму и вызывает РазбитьСтрокуЦикл 

 <details> 
   <summary> 
     Код  </summary>

   Итератор=1;
Пока не СтрПолучитьСтроку(Строка,итератор)="" цикл    
	СтрокаИтератор=СтрПолучитьСтроку(Строка,Итератор);
	РазбитьСтрокуТЧ(СтрокаИтератор);
	Итератор=Итератор+1;				
КонецЦикла;
</details>
     
## Процедура ПересчитатьИтоги()        	
 <details> 
   <summary> 
     Код  </summary>

   ЕстьЦвета=Истина;    
	Для каждого строка из ДанныеЗаправкиНаОтдатчике цикл     
		Если Строка.ВидОперации = Перечисления.ВидОперации.Изоляция тогда
			Если Строка(Строка.ЦветКуска)="" тогда
				ЕстьЦвета=Ложь;	
			КонецЕсли;                                                       
		КонецЕсли;
	КонецЦикла;
	Если ЕстьЦвета тогда
		Строка=ДанныеЗаправкиНаОтдатчике[0];
		Данные=Новый структура("НомерЭтапа,Оборудование,Длина,ВидОперации,ФИО,НомерСтроки,НомерОперации");  
		ЗаполнитьЗначенияСвойств(Данные,Строка);
		Данные.Вставить("ФИО",ЭтаФорма.ФИО);
		ДанныеЗаправкиНаОтдатчикеКоличествоКМПриИзмененииНаСервере(Данные);
	Иначе
		Сообщить("Внесите цвета");
	КонецЕсли;
	
</details>





 ## &НаСервере Процедура ДанныеЗаправкиНаОтдатчикеКоличествоКМПриИзмененииНаСервере(Данные)

 
 <details> 
   <summary> 
     Код  </summary>

	ФРМ 			= ФормированиеРабочихМассивов;
	ДанныеПоЭтапам	= ФРМ.СобратьУрезанныеДанныеПоЭтапам(СсылкаНаЗаказ);
	ПараметрыЗаказа	= ФРМ.СобратьУрезанныеПараметрыЗаказа(СсылкаНаЗаказ);
    СуммарноеЧистоеВремя = 0;                                                             
	СуммарнаяДеньга=0;
	ОбщееКолВоКМ=0;     
	
	Для каждого строка из ДанныеЗаправкиНаОтдатчике цикл   
		Расценки = ФРМ.ПолучитьРасценкиДляПресса7090(Данные,ДанныеЗаправкиНаОтдатчике.Выгрузить());
		
		ТЧ = СсылкаНаЗаказ.ЭтапыИОборудование;
		Отбор = Новый структура;
		Отбор.Вставить("ВидОперации",строка.ВидОперации);
		ИндексНомераЭтапа = тч.индекс(ТЧ.НайтиСтроки(Отбор)[строка.НомерОперации-1])+1;

		//Получаем ОбщееЧистоеВремя                                                            //было не ИндексНомераЭтапа, а Строка.НомерЭтапа
		ЧистоеВремя				= РасчетПроизводительностиОборудований.РасчетЧистойПроизводительности_Изоляция(ИндексНомераЭтапа,ДанныеПоЭтапам,ПараметрыЗаказа,Строка.КоличествоКМ);
		СуммарноеЧистоеВремя	= СуммарноеЧистоеВремя+ЧистоеВремя;
		ДеньгаЗаКМ				= ЧистоеВремя*Расценки.РасценкаЗаСмену/720;
		СуммарнаяДеньга			= СуммарнаяДеньга+ДеньгаЗаКм;     
		ОбщееКолВоКМ			= ОбщееКолВоКМ+Строка.КоличествоКм;
		
		
		строка.ЦенаКуска							= ДеньгаЗаКМ;
		строка.РасценкаЗаСменуИнструмента			= Расценки.РасценкаЗаСменуИнструмента;
		строка.РасценкаЗаСменуЦвета 				= Расценки.РасценкаЗаСменуЦвета;
		строка.РасценкаЗаСменуКатушкиВПриемник		= Расценки.РасценкаЗаСменуКатушкиВПриемник;
		строка.РасценкаЗаСменуКатушкиНаОтдатчике	= Расценки.РасценкаЗаСменуКатушкиНаОтдатчике;
		строка.РасценкаЗаСменуПластиката			= Расценки.РасценкаЗаСменуПластиката;
		
	КонецЦикла;  	
	Коэф		= СуммарноеЧистоеВремя/(СуммарноеЧистоеВремя+Расценки.ОбщееВремяОпераций);//       
	КоэфСмены	= ФРМ.ПоискКоэффициентаЗаСмену(Данные.Оборудование);
	#Область Вносим
	ЭтаФорма.КоэфЗагрОб		= Коэф;   
	ЭтаФорма.КоэфСмены		= КоэфСмены;
	ЭтаФорма.ОбщееКолвоКМ	= ОбщееКолвоКМ;
 	ЭтаФорма.Цена			= СуммарнаяДеньга; 
	ЭтаФорма.Разряд			= ФРМ.КоэфЗаРазряд(ЭтаФорма.ФИО);
	

	
</details>

 ## &НаКлиенте Процедура ДанныеЗаправкиНаОтдатчикеПриНачалеРедактирования(Элемент, НоваяСтрока, Копирование)

 
 <details> 
   <summary> 
     Код  </summary>

	Если НоваяСтрока И Не Копирование Тогда    
		
		Элемент.ТекущиеДанные.Оборудование = ДанныеЗаправкиНаОтдатчике[0].Оборудование;
		Элемент.ТекущиеДанные.номерОперации = ДанныеЗаправкиНаОтдатчике[0].номерОперации;
		Элемент.ТекущиеДанные.ВидОперации = ДанныеЗаправкиНаОтдатчике[0].ВидОперации;
		Элемент.ТекущиеДанные.НомерЭтапа = ДанныеЗаправкиНаОтдатчике[0].НомерЭтапа;
		Элемент.ТекущиеДанные.НомерСчета = ДанныеЗаправкиНаОтдатчике[0].НомерСчета;
	КонецЕсли;  
</details>



 ## &НаКлиенте Процедура ЗакрытьИСохранить(Команда)

 
 <details> 
   <summary> 
     Код  </summary>

	
	//+22,04   
	Есть0=Ложь;
	Для каждого Строчка из ДанныеЗаправкиНаОтдатчике цикл
		Если Строчка.ЦенаКуска=0 тогда
			Есть0=истина;
			Прервать;
		КонецЕсли;  
	КонецЦикла;  
	Если Есть0 тогда
		Режим = РежимДиалогаВопрос.ДаНет;  		
		Ответ = Вопрос("Рассчитать перед закрытием?", Режим,0);     	
		Ответ = ?(КодВозвратаДиалога.да=Ответ,истина,ложь);  
		Если Ответ тогда
			ПересчитатьИтоги();	
		КонецЕсли;
	КонецЕсли;
	//-22,04
	ВозвратнаяСтруктура=Новый структура;
	ВозвратнаяСтруктура.Вставить("ОбщееКолвоКМ",ОбщееКолвоКМ); 
	ВозвратнаяСтруктура.Вставить("Цена",ЭтаФорма.Цена); 
	ВозвратнаяСтруктура.Вставить("Разряд",ЭтаФорма.Разряд); 
	ВозвратнаяСтруктура.Вставить("КоэфСмены",ЭтаФорма.КоэфСмены); 
	ВозвратнаяСтруктура.Вставить("КоэфЗагрОб",ЭтаФорма.КоэфЗагрОб); 
	ВозвратнаяСтруктура.Вставить("РасценкаЗаСменуЦвета",ЭтаФорма.ДанныеЗаправкиНаОтдатчике[0].РасценкаЗаСменуЦвета);    
	ВозвратнаяСтруктура.Вставить("РасценкаЗаСменуИнструмента",ЭтаФорма.ДанныеЗаправкиНаОтдатчике[0].РасценкаЗаСменуИнструмента);    
	ВозвратнаяСтруктура.Вставить("РасценкаЗаСменуПластиката",ЭтаФорма.ДанныеЗаправкиНаОтдатчике[0].РасценкаЗаСменуПластиката);    
	
	ГрупповойРезерв="";    
	Итератор=0;
	Для каждого строка из ДанныеЗаправкиНаОтдатчике цикл		
		Итератор=Итератор+1;		
		Текст=Строка(Итератор)+"#"
		+Строка.НомерСчета+
		"ab"+Строка(Строка.НомерЭтапа)+
		"bc"+Строка(Строка.ВидОперации)+
		"cd"+Строка(ВернутьКод(Строка.Оборудование))+
		"de"+Строка(Строка.РасценкаЗаСменуИнструмента)+
		"ef"+Строка(Строка.РасценкаЗаСменуКатушкиВПриемник)+
		"fg"+Строка(Строка.РасценкаЗаСменуКатушкиНаОтдатчике)+
		"gh"+Строка(Строка.РасценкаЗаСменуЦвета)+
		"hj"+Строка(ВернутьКод(Строка.ЦветКуска))+
		"jk"+Строка(ЭтаФорма.Цена)+
		"kl"+Строка(Строка.КоличествоКМ)+
		"lm"+Строка(ЭтаФорма.КоэфЗагрОб)+
		"mn"+Строка(Строка.НомерОперации)+
		"no"+Строка(Строка.НомерСтроки)+  
		"op"+Строка(Строка.РасценкаЗаСменуПластиката)+ 
		"pq"+Строка(Строка.ЦенаКуска)+ 
		
		"idzak"+ЭтаФорма.idzak;
		
		Если Итератор=1 тогда 
			ГрупповойРезерв=Текст;   
		ИначеЕсли Итератор>1 тогда
			ГрупповойРезерв=ГрупповойРезерв+Символы.ПС+Текст;
		КонецЕсли;
	КонецЦикла;  
	ВозвратнаяСтруктура.Вставить("ГрупповойРезерв",ГрупповойРезерв);
	
	
	закрыть(ВозвратнаяСтруктура);    
</details>

 ## Функция  вернутьКод(ЧейКод)   
  <details> 
   <summary> 
     Код  </summary>

	Возврат Чейкод.код
</details>





 ## &НаКлиенте Процедура Рассчитать(Команда)   
 <details> 
   <summary> 
     Код  </summary>

	ПересчитатьИтоги();
</details>

