## &НаСервере Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка) 
 <details> 
   <summary> 
     Код  </summary>
   
	//заполнение формы предыдущими данными если раньше форма заполнялась
	Если Параметры.Ключ=0 тогда
		Строка=Параметры.ГрупповойРезерв;
		РазбитьСтроку(Строка);
	КонецЕсли;           
	Если Параметры.Свойство("ТолькоПросмотр") тогда
		Элементы.Группа6.ТолькоПросмотр = Параметры.ТолькоПросмотр;  
		Элементы.Готово.Видимость = не Элементы.Группа6.ТолькоПросмотр;
	КонецЕсли;
</details>

## &НаКлиенте Процедура Готово(Команда)   //Отправляет обратно в форму документа общие параметры и ТЧ(в виде многострочной строчной переменной) 

 <details> 
   <summary> 
     Код  </summary>
                          
	Если ГруппаЗаказов.Количество() тогда
		СтрокиБылиУдалены = Ложь;
		Для каждого СтрТч из ГруппаЗаказов.НайтиСтроки(Новый структура("НомерСчета","")) Цикл
			ГруппаЗаказов.Удалить(СтрТч);
			СтрокиБылиУдалены = истина;
		КонецЦикла;                    
		Если СтрокиБылиУдалены тогда
			Готово(неопределено);
		Иначе
			Итог=Новый структура;  
			Итог.Вставить("Маркоразмер",Маркоразмер);
			Итог.Вставить("НаименованиеОборудования",НаименованиеОборудования);
			Итог.Вставить("Сечение",Сечение);
			Итог.Вставить("НомерОперации",ГруппаЗаказов[0].НомерОперации);
			Итог.Вставить("НомерСчета",	  ГруппаЗаказов[0].НомерСчета);	   
			Итог.Вставить("СсылкаНаЗаказ",ГруппаЗаказов[0].СсылкаНаЗаказ);	   
			
			Итог.Вставить("ВидОперации",ВидОперации);
			Итог.Вставить("КоэффициентЗагруженностиОборудования",ГруппаЗаказов[0].КоэффициентЗагруженностиОборудованияИтоговый);		
			Итератор=0;
			ГрупповойРезерв="";
			Для каждого строка из ГруппаЗаказов цикл					
				Итератор=Итератор+1;		
				Текст=Строка(Итератор)+"#"+ПолучитьНомерЗаказа(Строка.СсылкаНаЗаказ)+
				"ab"+Строка(Строка.Оборудование)+
				"bc"+Строка(Строка.ДлинаЗаказа)+
				"cd"+Строка(Строка.ОбщееВремяНаЭтапе)+
				"de"+Строка(Строка.ВремяНеЗависящееОтДлиныЗаказа)+
				"ef"+Строка(Строка.КоэффициентЗагруженностиОборудования)+
				"fg"+Строка(Строка.КоэффициентЗагруженностиОборудованияИтоговый)+
				"gh"+Строка(Строка.НомерОперации)+
				"hj"+строка(Строка.ПустоеВремяНаЭтапе);
				
				Если Итератор=1 тогда 
					ГрупповойРезерв=Текст;   
				ИначеЕсли Итератор>1 тогда
					ГрупповойРезерв=ГрупповойРезерв+Символы.ПС+Текст;
				КонецЕсли;
			КонецЦикла;  
			Итог.Вставить("ГрупповойРезерв",ГрупповойРезерв);						 
			Закрыть(Итог);
		КонецЕсли;
	иначе
		Закрыть(неопределено);
	КонецЕсли; 

</details>    

## Функция ПолучитьНомерЗаказа(СсылкаНаЗаказ)
 <details> 
   <summary> 
     Код  </summary>
   
   	Возврат СсылкаНаЗаказ.Номер;
</details>    

## Процедура РазбитьСтрокуТЧ(Строка)       //Разбивает полученную строку на параметры и вписывает их
 <details> 
   <summary> 
     Код  </summary>
   


НоваяЗапись=ЭтаФорма.ГруппаЗаказов.Добавить();  
Вхождение0=Найти(Строка,"#");	  //номер строки     //переделать, черновой вариант(работает)
Вхождение1=Найти(Строка,"ab");    
Вхождение2=Найти(Строка,"bc");
Вхождение3=Найти(Строка,"cd");
Вхождение4=Найти(Строка,"de");
Вхождение5=Найти(Строка,"ef");
Вхождение6=Найти(Строка,"fg"); 
Вхождение7=Найти(Строка, "gh"); 
Вхождение8=Найти(Строка, "hj");
Вхождение9=Найти(Строка, Символы.ПС);                      
//Берем тут Общее оборудование т.к. групповая выработка и так предполагает одинаковое оборудование
НоваяЗапись.Оборудование=ЭтаФорма.НаименованиеОборудования;//Справочники.НоменклатураОборудований.НайтиПоНаименованию(Сред(Строка,Вхождение1+2,Вхождение2-1-Вхождение1-1));         
НомерЗаказа=Сред(Строка,Вхождение0+1,Вхождение1-1-Вхождение0);  
НоваяЗапись.НомерСчета = ?(СтрНайти(НомерЗаказа,"/")>0,НомерЗаказа,Документы.ЗаказыВПроизводство.НайтиПоНомеру(НомерЗаказа).НомерСчета);	
НоваяЗапись.СсылкаНаЗаказ = Документы.ЗаказыВПроизводство.НайтиПоНомеру(НомерЗаказа);
НоваяЗапись.ДлинаЗаказа=Сред(Строка,Вхождение2+2,Вхождение3-1-Вхождение2-1);
НоваяЗапись.ОбщееВремяНаЭтапе=Сред(Строка,Вхождение3+2,Вхождение4-1-Вхождение3-1);
НоваяЗапись.ВремяНеЗависящееОтДлиныЗаказа=Сред(Строка,Вхождение4+2,Вхождение5-1-Вхождение4-1);
НоваяЗапись.КоэффициентЗагруженностиОборудования=Сред(Строка,Вхождение5+2,Вхождение6-1-Вхождение5-1);
НоваяЗапись.КоэффициентЗагруженностиОборудованияИтоговый=Сред(Строка,Вхождение6+2,Вхождение7-1-Вхождение6-1);
//НоваяЗапись.НомерОперации=Сред(Строка,Вхождение7+2,1); //01,10
НоваяЗапись.НомерОперации=Сред(Строка,Вхождение7+2,Вхождение8-1-Вхождение7-1);   //+01,10
НоваяЗапись.ПустоеВремяНаЭтапе=Сред(Строка,Вхождение8+2);                        //+01,10

</details>

## Функция РазбитьСтроку(Строка)    //Вписывает общие параметры в форму и вызывает РазбитьСтрокуЦикл 


 <details> 
   <summary> 
     Код  </summary>
   
	ЭтаФорма.ВидОперации=Параметры.ВидОперации;
	ЭтаФорма.МаркоРазмер=Параметры.МаркоРазмер;
	ЭтаФорма.Сечение=Параметры.Сечение;
	ЭтаФорма.НаименованиеОборудования=Параметры.НаименованиеОборудования;	
	Итератор=1;
	Пока не СтрПолучитьСтроку(Строка,итератор)="" цикл    
		СтрокаИтератор=СтрПолучитьСтроку(Строка,Итератор);
		РазбитьСтрокуТЧ(СтрокаИтератор);
		Итератор=Итератор+1;				
	КонецЦикла;
 </details> 



## Функция ПараметрыЗаказа(СсылкаНаЗаказ)

 <details> 
   <summary> 
     Код  </summary>
   
   
	Заказ=СсылкаНаЗаказ;
	ПараметрыЗаказа=Новый структура;
	ПараметрыЗаказа.Вставить("Диаметр",Заказ.ДиаметрПроволоки);
	ПараметрыЗаказа.Вставить("КолвоКМпоЗаказу",Заказ.КоличествоКилометровПоЗаказу); //Кол-во км по заказу или кол-во км в производство?
	ПараметрыЗаказа.Вставить("КолвоКМвПроизводство",Заказ.КоличествоКилометровВПроизводство); 	
	Возврат ПараметрыЗаказа;	
</details> 

## &НаКлиенте Процедура ВписатьСсылкуИзФормыВыбораЗаказа(ТД)

 <details> 
   <summary> 
     Код  </summary>

	
	ФормаВыбораЗаказа = ПолучитьФорму("Документ.Выработка.Форма.ФормаВыбораЗаказа", Новый Структура("Счет",ТД.НомерСчета));
	ТД.СсылкаНаЗаказ=ФормаВыбораЗаказа.ОткрытьМодально(); 
	
	
</details>

## &НаКлиенте Процедура ГруппаЗаказовНомерСчетаПриИзменении(Элемент)      //открывает форму выбора 

 <details> 
   <summary> 
     Код  </summary>

	СтандартнаяОбработка=Ложь;      
	ФРМ = ФормированиеРабочихМассивов;
	ТД=ТекущийЭлемент.ТекущиеДанные;		
	
	
	ВписатьСсылкуИзФормыВыбораЗаказа(ТД);	
	Если ЗначениеЗаполнено(ТД.СсылкаНаЗаказ) тогда
		ПараметрыФормы = Новый Структура;   
		ПараметрыФормы.Вставить("СсылкаНаЗаказ",ТД.СсылкаНаЗаказ);     

		Форма = ПолучитьФорму("Документ.Выработка.Форма.ФормаВыбораЭтапа", ПараметрыФормы);
		РезультатФормы=Форма.ОткрытьМодально();         
		
		Если РезультатФормы=Неопределено тогда     
			Сообщить("Похоже Вы закрыли форму!");
		Иначе
			ПараметрыЗаказа=ПараметрыЗаказа(ТД.СсылкаНаЗаказ);
			//если не заполнены то происходит первичное заполнение общих данных ПО ПЕРВОЙ ВВЕДЕННОЙ СТРОКЕ
			Если ЭтаФорма.Сечение="" и ЭтаФорма.НаименованиеОборудования.Пустая() и ЭтаФорма.ВидОперации.Пустая() или Элемент.Родитель.ТекущаяСтрока = 0 тогда       				
				ЭтаФорма.Сечение					= РезультатФормы.Сечение;
				ЭтаФорма.НаименованиеОборудования	= РезультатФормы.Оборудование;	
				ЭтаФорма.МаркоРазмер				= ПараметрыЗаказа.Диаметр;
				ЭтаФорма.ВидОперации				= РезультатФормы.ВидОперации;
			КонецЕсли;     
			ТД.НомерОперации=РезультатФормы.НомерОперации;
			ТД.Оборудование=РезультатФормы.Оборудование;
			НомерСчетаГрупповой=Строка(ТД.НомерСчета)+"Групповой";
			//+01,10 
			Если Строка(ЭтаФорма.ВидОперации) = "Скрутка ТПЖ" тогда
				ПараметрыДляСкруткиТПЖ=новый структура;
				ПараметрыДляСкруткиТПЖ.Вставить("ОбщееПустоеВремя",0);
				ПараметрыДляСкруткиТПЖ.Вставить("ПустоеВремяВсехЗаказовКромеПервого",0);					
			КонецЕсли;
			//-	       
			Если Строка(ЭтаФорма.ВидОперации) = "Скрутка стренги" тогда 
				СкруткаСтренгиПосчитатьГрупповой(ТД.СсылкаНаЗаказ,ТД.Оборудование,ТД.НомерОперации);
			Иначе
				ПараметрыКоэф= ФРМ.РасчетКоэФЗагрОборуд(Истина,ЭтаФорма.ВидОперации,ТД.Оборудование,ТД.НомерОперации,неопределено,ТД.СсылкаНаЗаказ);
				ТД.ДлинаЗаказа = ПараметрыЗаказа.КолвоКМпоЗаказу;                                                                       
				ЗаполнитьЗначенияСвойств(ТД,ПараметрыКоэф);
				
				
				// находим большее значение из всех имеющихся и присваиваем его остальным как Итоговый                                      //
				КоэффициентЗагруженностиОборудованияИтоговый=0;	                               									 		   //
				//+01,10
				Для каждого Строка из ГруппаЗаказов цикл                                         							   	       	  
					Если Строка(ЭтаФорма.ВидОперации) = "Скрутка ТПЖ" тогда							                                  
						ПараметрыДляСкруткиТПЖ.ОбщееПустоеВремя = ПараметрыДляСкруткиТПЖ.ОбщееПустоеВремя+строка.ПустоеВремяНаЭтапе;                                                                            				
						Если КоэффициентЗагруженностиОборудованияИтоговый>0 тогда
							ПараметрыДляСкруткиТПЖ.ПустоеВремяВсехЗаказовКромеПервого = ПараметрыДляСкруткиТПЖ.ПустоеВремяВсехЗаказовКромеПервого+строка.ПустоеВремяНаЭтапе;																																										
							ПараметрыКоэф 								= ФРМ.РасчетКоэФЗагрОборуд(Истина,ЭтаФорма.ВидОперации,ТД.Оборудование,ГруппаЗаказов[0].НомерОперации,ПараметрыДляСкруткиТПЖ,ТД.СсылкаНаЗаказ);
							КоэффициентЗагруженностиОборудования		= ПараметрыКоэф.КоэффициентЗагруженностиОборудования;   
							Строка.КоэффициентЗагруженностиОборудования = КоэффициентЗагруженностиОборудования;						
						КонецЕсли;  					
						КоэффициентЗагруженностиОборудованияИтоговый	= Строка.КоэффициентЗагруженностиОборудования;
						КоэффициентЗагруженностиОборудования			= КоэффициентЗагруженностиОборудованияИтоговый;
					иначе	
						Если Строка.КоэффициентЗагруженностиОборудования > КоэффициентЗагруженностиОборудованияИтоговый тогда     		     
							КоэффициентЗагруженностиОборудованияИтоговый = Строка.КоэффициентЗагруженностиОборудования;	                    
						КонецЕсли; 
					КонецЕсли;						
				КонецЦикла;                                                                                                                     
				Для каждого Строка из ГруппаЗаказов цикл    
					Строка.КоэффициентЗагруженностиОборудованияИтоговый = КоэффициентЗагруженностиОборудованияИтоговый;	   	                    				
					Если строка(ЭтаФорма.ВидОперации) = "Скрутка ТПЖ" тогда
						Строка.КоэффициентЗагруженностиОборудования = КоэффициентЗагруженностиОборудованияИтоговый;	   	                    				
					КонецЕсли;
				КонецЦикла;    				
			КонецЕсли;   
		КонецЕсли;

	Иначе
		Сообщить("Вы вписали номер счета, который отсутсвует в заказах на производство!");
	КонецЕсли;   
</details>


##    Процедура СкруткаСтренгиПосчитатьГрупповой(СсылкаНаЗаказ,Оборудование,НомерОперации)       


 <details> 
   <summary> 
     Код  </summary>
	ФРМ = ФормированиеРабочихМассивов;
	ОбщееЧистоеВремя = 0;
	ОбщееВремяСмены  = 0;
	ВремяПодготовки  = 0;  
	Для каждого Строка из ГруппаЗаказов цикл  
		Времена = ФРМ.РасчетКоэФЗагрОборуд_Стренга(СсылкаНаЗаказ.ПолучитьОбъект(),НомерОперации,Истина);	
		ОбщееВремяСмены=ОбщееВремяСмены+Времена.ВремяСмены;
		ОбщееЧистоеВремя=ОбщееЧистоеВремя+Времена.ЧистоеВремя; 
		Строка.КоэффициентЗагруженностиОборудования=Времена.КоэффициентЗагруженностиОборудования;
		
		Если Строка=ГруппаЗаказов[0] тогда
			ВремяПодготовки=Времена.ВремяПодготовки;
			Продолжить;
		КонецЕсли;     
		
	КонецЦикла;
	Для каждого Строка из ГруппаЗаказов цикл
		Строка.КоэффициентЗагруженностиОборудованияИтоговый = ОбщееЧистоеВремя/(ОбщееВремяСмены+ОбщееЧистоеВремя+ВремяПодготовки);
	КонецЦикла;
	
// для 4 машины стренги


</details>

## &НаКлиенте Процедура Открыть_выбранный_заказ(Команда)

 <details> 
   <summary> 
     Код  </summary>

	ТекДанные= новый структура;            
  	ТекДанные.Вставить("СсылкаНаЗаказ",ТекущийЭлемент.ТекущиеДанные.СсылкаНаЗаказ);
  	ФормаПараметр = Новый Структура("Ключ",ТекДанные.СсылкаНаЗаказ);
	Форма = ПолучитьФорму("Документ.ЗаказыВПроизводство.Форма.ФормаДокумента", ФормаПараметр).ОткрытьМодально();
</details>

## &НаКлиенте Процедура ГруппаЗаказовНомерСчетаОткрытие(Элемент, СтандартнаяОбработка)

 <details> 
   <summary> 
     Код  </summary>

	СтандартнаяОбработка=Ложь;
	ГруппаЗаказовНомерСчетаПриИзменении(Элемент);
	
</details>



## 
 <details> <summary> Код  </summary>
 </details>

 ## \n
 \n<details> <summary> Код  </summary>\n
 \n</details>\n


