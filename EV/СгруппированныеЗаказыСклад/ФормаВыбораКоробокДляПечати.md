# Процедуры

## Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)  

 ```
	Если Параметры.РазбивкаВРучную = Истина Тогда
		
		ФормированиеЗаказаДляРазбивки = Новый ТаблицаЗначений;  
		
		ФормированиеЗаказаДляРазбивки.Колонки.Добавить("НоменклатураERP");
		ФормированиеЗаказаДляРазбивки.Колонки.Добавить("Задание");
		ФормированиеЗаказаДляРазбивки.Колонки.Добавить("Длина");
		ФормированиеЗаказаДляРазбивки.Колонки.Добавить("Ссылка");
		
		МассивНомеровСчетов = Новый Массив;
		
		ОставшиесяЗаказыДляРазбивки = ФормированиеЗаказаДляРазбивки.СкопироватьКолонки();  
		
		Для каждого Заказ из Параметры.Заказы Цикл 
			Если Заказ.РазбивкаВРучную = Истина Тогда
				УдалениеПрошлойРазбивкиКоробокИзСправочникаКоробкиЦПМ(Заказ, Параметры.Заказы);
			КонецЕсли;
		КонецЦикла; 
		
		Для каждого Заказ из Параметры.Заказы Цикл
			Если Заказ.РазбивкаВРучную = Истина Тогда	
				Если ПроверкаЕстьЛиУжеТакойНомерСчета(МассивНомеровСчетов, Заказ.НомерСчета) Тогда
					МассивНомеровСчетов.Добавить(Заказ.НомерСчета);
				КонецЕсли;
			КонецЕсли;	
		КонецЦикла;         
		
		Для каждого НомерСчета из МассивНомеровСчетов Цикл
			
			Запрос = Новый Запрос;
			Запрос.Текст = 
			"ВЫБРАТЬ
			|	СгруппированныеЗаказыСклад.Ссылка КАК Ссылка,
			|	СгруппированныеЗаказыСклад.Номеклатура КАК Номеклатура,
			|	СгруппированныеЗаказыСклад.НомерСчета КАК НомерСчета,
			|	СгруппированныеЗаказыСклад.ПроверкаОстаткаШинДляВыбораКоробки КАК ПроверкаОстаткаШинДляВыбораКоробки,
			|	СгруппированныеЗаказыСклад.КоличествоПоЗаказу КАК КоличествоПоЗаказу
			|ИЗ
			|	Документ.СгруппированныеЗаказыСклад КАК СгруппированныеЗаказыСклад
			|ГДЕ
			|	СгруппированныеЗаказыСклад.НомерСчета = &НомерСчета";
			
			Запрос.УстановитьПараметр("НомерСчета", НомерСчета);
			
			РезультатЗапроса = Запрос.Выполнить();
			
			ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
			
			Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
				
				ПозицияПростоУпаковываетсяИНеНужноПереразбивать = Ложь;
				Для каждого Заказ из Параметры.Заказы Цикл
					Если ВыборкаДетальныеЗаписи.Номеклатура = Заказ.Номенклатура и Заказ.РазбивкаВРучную = Ложь Тогда
						ПозицияПростоУпаковываетсяИНеНужноПереразбивать = Истина;
					КонецЕсли;
				КонецЦикла; 
				
				Если ПозицияПростоУпаковываетсяИНеНужноПереразбивать = Ложь Тогда
					
					ЗаказНаРучнуюУпаковку = Ложь;
					Для каждого Заказ из Параметры.Заказы Цикл
						Если ВыборкаДетальныеЗаписи.Номеклатура = Заказ.Номенклатура Тогда
							ЗаказНаРучнуюУпаковку = Истина;
							Прервать;
						КонецЕсли; 
					КонецЦикла;
					
					Если ЗаказНаРучнуюУпаковку = Истина Тогда 
						
						Если ВыборкаДетальныеЗаписи.ПроверкаОстаткаШинДляВыбораКоробки <> 0 Тогда
							СтрокаТЗ = ФормированиеЗаказаДляРазбивки.Добавить();  
							
							СтрокаТЗ.НоменклатураERP = ВыборкаДетальныеЗаписи.Номеклатура;
							СтрокаТЗ.Задание         = ВыборкаДетальныеЗаписи.ПроверкаОстаткаШинДляВыбораКоробки;
							СтрокаТЗ.Длина           = ВернутьДлиннуИзЗаказаНаПроизводство(ВыборкаДетальныеЗаписи.Номеклатура, ВыборкаДетальныеЗаписи.НомерСчета);
							СтрокаТЗ.Ссылка          = ВыборкаДетальныеЗаписи.Ссылка; 
						КонецЕсли;
						
					Иначе
						СтрокаТЗ = ОставшиесяЗаказыДляРазбивки.Добавить();  
						
						СтрокаТЗ.НоменклатураERP = ВыборкаДетальныеЗаписи.Номеклатура;
						СтрокаТЗ.Задание         = ВыборкаДетальныеЗаписи.КоличествоПоЗаказу;
						СтрокаТЗ.Длина           = ВернутьДлиннуИзЗаказаНаПроизводство(ВыборкаДетальныеЗаписи.Номеклатура, ВыборкаДетальныеЗаписи.НомерСчета);
						СтрокаТЗ.Ссылка          = ВыборкаДетальныеЗаписи.Ссылка;
						
					КонецЕсли;
				КонецЕсли;
				
			КонецЦикла;
			
			ФормированиеРабочихМассивов.РазбивкаЗаказаДляЗаполненияВКоробки(ФормированиеЗаказаДляРазбивки); //Переразбивка первых выбранных позиций
			
			ФормированиеРабочихМассивов.РазбивкаЗаказаДляЗаполненияВКоробки(ОставшиесяЗаказыДляРазбивки);   //Переразбивка оставшихся позиций позиций
			
		КонецЦикла;				 
		
		Для каждого Заказ из Параметры.Заказы Цикл
			Если Заказ.РазбивкаВРучную = Истина Тогда
				ЗаполнитьСгруппированныеЗаказыНовойРазбивкой(Заказ)  
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
	//Иначе
	Для каждого Заказ из Параметры.Заказы Цикл  
		
		ОбъектЗаказа = Заказ.Ссылка.ПолучитьОбъект();
		
		Если ОбъектЗаказа.КлКоробокДляЗаполнения <> 0 Тогда  
			
			Для каждого Коробка из ОбъектЗаказа.ПодходящиеКоробки Цикл
				
				Если ПроверкаНеВнесенаЛиУжеТакаяКоробка(Коробка) Тогда
				ИначеЕсли Коробка.КоробкаБылаУпакована = Ложь Тогда
					НоваяСтрока = Объект.КоробкиКоторыеМожноЗаполнять.Добавить();
					
					НоваяСтрока.НомерСчета      = ОбъектЗаказа.НомерСчета;
					НоваяСтрока.КоробкиЦПМ      = Коробка.КоробкиЦПМ;
					НоваяСтрока.Номенклатура    = Заказ.Номенклатура;
					НоваяСтрока.ВсеШиныВКоробке = Коробка.ВсеШиныВКоробке; 
					НоваяСтрока.ВесКоробки      = Коробка.ВесКоробки; 
					НоваяСтрока.Комментарий     = ОбъектЗаказа.Комментарий;
					
					НоваяСтрока.СсылкаНаСгруппированныйЗаказ = Заказ.Ссылка;
				КонецЕсли;                                
				
			КонецЦикла;
		Иначе
			Сообщить("Вы выбрали позицию " + Строка(ОбъектЗаказа.НомерСчета) + " " + Строка(ОбъектЗаказа.Номеклатура) + " по которой ещё нет коробок",);
		КонецЕсли;
		
	КонецЦикла;
	//КонецЕсли;
```

## Функция ПроверкаНеВнесенаЛиУжеТакаяКоробка(Коробка)  

```
	Для каждого КоробкиДляЗаполнения из Объект.КоробкиКоторыеМожноЗаполнять Цикл
		Если КоробкиДляЗаполнения.КоробкиЦПМ = Коробка.КоробкиЦПМ Тогда
			Возврат Истина;
		КонецЕсли;
	КонецЦикла;
	
	Возврат Ложь;
```

## Процедура ОбъектКоробкиКоторыеМожноЗаполнятьЗаполнитьКоробкуПриИзмененииНаСервере(СсылкаНаСгруппированныйЗаказ, ВсеШиныВКоробке, Номенклатура, ПроверкаНаВнесениеКоробки, СсылкаНаКоробку, НомерСчета)

 ```
	//Вычет по всем шинам сразу
	ВсеШиныДляПроверки = СтрРазделить(ВсеШиныВКоробке, ";");
	
	ТекущаяШина = ПолучениеШиныПоНоменклатуре(Номенклатура);       
	
	Для каждого ОднаИзШин из ВсеШиныДляПроверки Цикл 
		ПозицияДвоеточия = СтрНайти(ОднаИзШин, ":");
		ШинаЗапроса      = Лев(ОднаИзШин, ПозицияДвоеточия - 1);
		       
		Если СтрНайти(Номенклатура, ШинаЗапроса) и ОднаИзШин <> "" Тогда   
			
			ОставщеесяЧислоШин = ИзмененияКоличестваШинВСгрупированномЗаказеПоТекущейШине(СсылкаНаСгруппированныйЗаказ, ПроверкаНаВнесениеКоробки, Номенклатура, ВсеШиныВКоробке);
			
		ИначеЕсли ОднаИзШин <> "" Тогда 
			
			Запрос = Новый Запрос;
			Запрос.Текст = 
			"ВЫБРАТЬ
			|	СгруппированныеЗаказыСклад.Номеклатура КАК Номеклатура,
			|	СгруппированныеЗаказыСклад.НомерСчета КАК НомерСчета,
			|	СгруппированныеЗаказыСклад.Ссылка КАК Ссылка,
			|	СгруппированныеЗаказыСклад.ПроверкаОстаткаШинДляВыбораКоробки КАК ПроверкаОстаткаШинДляВыбораКоробки
			|ИЗ
			|	Документ.СгруппированныеЗаказыСклад КАК СгруппированныеЗаказыСклад
			|ГДЕ
			|	СгруппированныеЗаказыСклад.Номеклатура ПОДОБНО &Номеклатура
			|	И СгруппированныеЗаказыСклад.НомерСчета ПОДОБНО &НомерСчета";
			
			Запрос.УстановитьПараметр("Номеклатура", "%" + ШинаЗапроса + "%");
			Запрос.УстановитьПараметр("НомерСчета", НомерСчета + "%");
			
			РезультатЗапроса = Запрос.Выполнить();
			                                            
			ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
			
			Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
				Если СтрНайти(Номенклатура, ШинаЗапроса) = 0 Тогда 
					ИзмененияКоличестваШинВСгрупированномЗаказеПоТекущейШине(ВыборкаДетальныеЗаписи.Ссылка, ПроверкаНаВнесениеКоробки, ВыборкаДетальныеЗаписи.Номеклатура, ВсеШиныВКоробке);
				КонецЕсли;;
			КонецЦикла;
			
		КонецЕсли;		
	КонецЦикла;
	
	ШинаПроверки = ПолучениеШиныПоНоменклатуре(Номенклатура);
	
	Для каждого КоробкаДляЗаполнения из Объект.КоробкиКоторыеМожноЗаполнять Цикл
		Для каждого ОднаИзШин из ВсеШиныДляПроверки Цикл 
			Если ОднаИзШин <> "" Тогда 
				
				Шина = Лев(ОднаИзШин, ПозицияДвоеточия - 1); 
				
				Если КоробкаДляЗаполнения.НомерСчета = НомерСчета и КоробкаДляЗаполнения.ЗаполнитьКоробку = Ложь и СтрНайти(КоробкаДляЗаполнения.ВсеШиныВКоробке, Шина) Тогда
					
					ПозицияДвоеточия = СтрНайти(ОднаИзШин, ":");
								
					КоличествоШинДляЗаполненияКоробки = Число(ПолучениеКоличестваШинПоСтроке(КоробкаДляЗаполнения.ВсеШиныВКоробке, Шина));
					
					ЗапросНиз = Новый Запрос;
					ЗапросНиз.Текст = 
					"ВЫБРАТЬ
					|	СгруппированныеЗаказыСклад.Номеклатура КАК Номеклатура,
					|	СгруппированныеЗаказыСклад.НомерСчета КАК НомерСчета,
					|	СгруппированныеЗаказыСклад.Ссылка КАК Ссылка,
					|	СгруппированныеЗаказыСклад.ПроверкаОстаткаШинДляВыбораКоробки КАК ПроверкаОстаткаШинДляВыбораКоробки
					|ИЗ
					|	Документ.СгруппированныеЗаказыСклад КАК СгруппированныеЗаказыСклад
					|ГДЕ
					|	СгруппированныеЗаказыСклад.Номеклатура ПОДОБНО &Номеклатура
					|	И СгруппированныеЗаказыСклад.НомерСчета ПОДОБНО &НомерСчета";
					
					ЗапросНиз.УстановитьПараметр("Номеклатура", "%" + ШинаЗапроса + "%");
					ЗапросНиз.УстановитьПараметр("НомерСчета", НомерСчета + "%");
					
					РезультатЗапроса = ЗапросНиз.Выполнить();
					
					ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
					
					Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
						Если СтрНайти(ВыборкаДетальныеЗаписи.Номеклатура, Шина) и Шина <> "" Тогда  
							ОставщеесяЧислоШин = ВыборкаДетальныеЗаписи.ПроверкаОстаткаШинДляВыбораКоробки; 
						КонецЕсли;
					КонецЦикла;   
					
					Если ОставщеесяЧислоШин < КоличествоШинДляЗаполненияКоробки и СтрНайти(КоробкаДляЗаполнения.ВсеШиныВКоробке, ШинаПроверки) Тогда 
						КоробкаДляЗаполнения.СкрытьКоробку = Истина;
						Прервать;
					Иначе
						КоробкаДляЗаполнения.СкрытьКоробку = Ложь;
					КонецЕсли;
					
				КонецЕсли;
			КонецЕсли;
		КонецЦикла;
	КонецЦикла;
	
	СтруктураПоиска =  Новый Структура;
	СтруктураПоиска.Вставить("СкрытьКоробку", Ложь);
	Элементы.ОбъектКоробкиКоторыеМожноЗаполнять.ОтборСтрок = Новый ФиксированнаяСтруктура(СтруктураПоиска);
	
	ПодтянутьКоробкиПоИзменивщемусяЧислуШин(ОставщеесяЧислоШин, СсылкаНаКоробку, ПроверкаНаВнесениеКоробки, ВсеШиныВКоробке, НомерСчета, Номенклатура);
```

## Функция ИзмененияКоличестваШинВСгрупированномЗаказеПоТекущейШине(СсылкаНаСгруппированныйЗаказ, ПроверкаНаВнесениеКоробки, Номенклатура, КоличествоШинТекущейКОробки)

```
	ОбъектСгруппированнагоЗаказа = СсылкаНаСгруппированныйЗаказ.ПолучитьОбъект();
	
	Шина                              = ПолучениеШиныПоНоменклатуре(Номенклатура); 
	КоличествоШинДляЗаполненияКоробки = Число(ПолучениеКоличестваШинПоСтроке(КоличествоШинТекущейКОробки, Шина)); 
	
	Если ПроверкаНаВнесениеКоробки = Истина Тогда		
		ОбъектСгруппированнагоЗаказа.ПроверкаОстаткаШинДляВыбораКоробки = ОбъектСгруппированнагоЗаказа.ПроверкаОстаткаШинДляВыбораКоробки - КоличествоШинДляЗаполненияКоробки;	
	Иначе
		ОбъектСгруппированнагоЗаказа.ПроверкаОстаткаШинДляВыбораКоробки = ОбъектСгруппированнагоЗаказа.ПроверкаОстаткаШинДляВыбораКоробки + КоличествоШинДляЗаполненияКоробки;
	КонецЕсли;
	
	ОбъектСгруппированнагоЗаказа.Записать();
	
	Возврат ОбъектСгруппированнагоЗаказа.ПроверкаОстаткаШинДляВыбораКоробки;
	
```

## Процедура ПодтянутьКоробкиПоИзменивщемусяЧислуШин(ОставщеесяЧислоШин, СсылкаНаКоробку, ПроверкаНаВнесениеКоробки, ВсеШиныВКоробке, НомерСчета, Номенклатура)

```
	ОбъектКоробкиЦПМ = СсылкаНаКоробку.ПолучитьОбъект();	
	Если ПроверкаНаВнесениеКоробки Тогда
		ОбъектКоробкиЦПМ.КоробкаБылаУпакована = Истина;
	Иначе
		ОбъектКоробкиЦПМ.КоробкаБылаУпакована = Ложь;
	КонецЕсли; 	
	ОбъектКоробкиЦПМ.Записать();
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	СгруппированныеЗаказыСклад.Ссылка КАК Ссылка,
		|	СгруппированныеЗаказыСклад.ПодходящиеКоробки.(
		|		Ссылка КАК Ссылка,
		|		КоробкиЦПМ КАК КоробкиЦПМ
		|	) КАК ПодходящиеКоробки
		|ИЗ
		|	Документ.СгруппированныеЗаказыСклад КАК СгруппированныеЗаказыСклад
		|ГДЕ
		|	СгруппированныеЗаказыСклад.ПодходящиеКоробки.КоробкиЦПМ.Ссылка = &Ссылка";
	
	Запрос.УстановитьПараметр("Ссылка", СсылкаНаКоробку);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		
		ОбъектСгрупзаказа = ВыборкаДетальныеЗаписи.Ссылка.ПолучитьОбъект();
		
		ОбъектСгрупзаказа.ПодходящиеКоробки.Очистить();
		
		Запрос = Новый Запрос;
		Запрос.Текст = 
		"ВЫБРАТЬ
		|	КоробкиЦПМ.Ссылка КАК Ссылка,
		|	КоробкиЦПМ.ЗаказНаПроизводствоКоробки КАК ЗаказНаПроизводствоКоробки,
		|	КоробкиЦПМ.ВсеШиныВКоробке КАК ВсеШиныВКоробке,
		|	КоробкиЦПМ.ВесКоробки КАК ВесКоробки,
		|	КоробкиЦПМ.КоробкаБылаУпакована КАК КоробкаБылаУпакована
		|ИЗ
		|	Справочник.КоробкиЦПМ КАК КоробкиЦПМ
		|ГДЕ
		|	КоробкиЦПМ.ЗаказНаПроизводствоКоробки = &НомерСчёта
		|	И КоробкиЦПМ.ВсеШиныВКоробке ПОДОБНО &ВсеШиныВКоробке";
		
		Запрос.УстановитьПараметр("НомерСчёта", НомерСчета); 
		Шина = ПолучениеШиныПоНоменклатуре(ОбъектСгрупзаказа.Номеклатура);
		Запрос.УстановитьПараметр("ВсеШиныВКоробке", "%" + Шина + "%");
		
		РезультатЗапросаКоробок = Запрос.Выполнить();
		
		ВыборкаДетальныеЗаписиКоробок = РезультатЗапросаКоробок.Выбрать();
		
		КоробкиДляСборки = Новый Массив;  
		
		Пока ВыборкаДетальныеЗаписиКоробок.Следующий() Цикл 
			
			СсылкаИШиныИФактУпаковки = Новый Структура;
			СсылкаИШиныИФактУпаковки.Вставить("ВсеШиныВКоробке", ВыборкаДетальныеЗаписиКоробок.ВсеШиныВКоробке);
			СсылкаИШиныИФактУпаковки.Вставить("Ссылка", ВыборкаДетальныеЗаписиКоробок.Ссылка);
			СсылкаИШиныИФактУпаковки.Вставить("КоробкаУжеУпакована", ВыборкаДетальныеЗаписиКоробок.КоробкаБылаУпакована); 
			СсылкаИШиныИФактУпаковки.Вставить("ВесКоробки", ВыборкаДетальныеЗаписиКоробок.ВесКоробки);
			КоробкиДляСборки.Добавить(СсылкаИШиныИФактУпаковки);
			
		КонецЦикла;
		
		КоробкиДляЗаписиВТЧ = ПоискПодходящихКоробокПоСделаннымШинам(КоробкиДляСборки, НомерСчета, ОставщеесяЧислоШин, Номенклатура);
		
		Если КоробкиДляЗаписиВТЧ.Количество() <> 0 Тогда     
			
			Для каждого КоробкаДляВнесения из КоробкиДляЗаписиВТЧ Цикл
				
				НоваяСтрока = ОбъектСгрупзаказа.ПодходящиеКоробки.Добавить(); 

				НоваяСтрока.КоробкиЦПМ           = КоробкаДляВнесения.Ссылка;
				НоваяСтрока.ВсеШиныВКоробке      = КоробкаДляВнесения.ВсеШиныВКоробке;
				НоваяСтрока.ВесКоробки           = КоробкаДляВнесения.ВесКоробки;
				НоваяСтрока.КоробкаБылаУпакована = КоробкаДляВнесения.КоробкаУжеУпакована;
				
			КонецЦикла
				
		КонецЕсли;
		
		ОбъектСгрупзаказа.КлКоробокДляЗаполнения = ОбъектСгрупзаказа.ПодходящиеКоробки.Количество();
		
		ОбъектСгрупзаказа.Записать();
		
	КонецЦикла;	
	
```

## Функция УбратьДублиИзМассива(Массив) Экспорт
```
	ИндексТекущегоЭлемента = 0; 
	ВсегоЭлементов = Массив.Количество(); 
	Пока ИндексТекущегоЭлемента < ВсегоЭлементов Цикл 
		ИндексСледующегоЭлемента = ИндексТекущегоЭлемента + 1; 
		Пока ИндексСледующегоЭлемента < ВсегоЭлементов Цикл 
			Если Массив[ИндексСледующегоЭлемента] = Массив[ИндексТекущегоЭлемента] Тогда 
				Массив.Удалить(ИндексСледующегоЭлемента); 
				ВсегоЭлементов = ВсегоЭлементов - 1; 
			Иначе 
				ИндексСледующегоЭлемента = ИндексСледующегоЭлемента + 1; 
			КонецЕсли; 
		КонецЦикла; 
		ИндексТекущегоЭлемента = ИндексТекущегоЭлемента + 1; 
	КонецЦикла; 
	Возврат Массив; 
```

## Процедура ОбъектКоробкиКоторыеМожноЗаполнятьЗаполнитьКоробкуПриИзменении(Элемент)
```
	ОбъектКоробкиКоторыеМожноЗаполнятьЗаполнитьКоробкуПриИзмененииНаСервере(ТекущийЭлемент.ТекущиеДанные.СсылкаНаСгруппированныйЗаказ, ТекущийЭлемент.ТекущиеДанные.ВсеШиныВКоробке, ТекущийЭлемент.ТекущиеДанные.Номенклатура, ТекущийЭлемент.ТекущиеДанные.ЗаполнитьКоробку, ТекущийЭлемент.ТекущиеДанные.КоробкиЦПМ, ТекущийЭлемент.ТекущиеДанные.НомерСчета);
```

## Функция ПолучениеШиныПоНоменклатуре(Шина)
```	
	НаходимПозициюХ     = СтрНайти(Шина, "х");                                              // В номенклатуре находим позицию x 
	НаходимЛевыйПробел  = СтрНайти(Шина, " ", НаправлениеПоиска.СКонца, НаходимПозициюХ);   // Находим позицию пробела слева от x
	НаходимПравыйПробел = СтрНайти(Шина, " ", НаправлениеПоиска.СНачала, НаходимПозициюХ);  // Находим позицию пробела справа от x
	
	КоличествоСимволовСлева  = НаходимПозициюХ - НаходимЛевыйПробел;                                    // Число символов, слева от пробела и до x 
	КоличествоСимволовСправа = НаходимПравыйПробел - НаходимПозициюХ;                                   // Число символов, справа от пробела и до x
	
	ВысотаПозиции = Сред(Шина, НаходимЛевыйПробел + 1, КоличествоСимволовСлева - 1);        // Находим высоту    	
	ШиринаПозиции = Сред(Шина, НаходимПозициюХ + 1, КоличествоСимволовСправа - 1);          // Находим ширину
	
	ШинаПроверки = ВысотаПозиции + "х" + ШиринаПозиции;  
	
	Возврат ШинаПроверки;	
```

## Функция ПолучениеКоличестваШинПоСтроке(ВсеШиныВКоробке, ШинаПроверки)

```
	НахождениеШиныВСтроке = СтрНайти(ВсеШиныВКоробке, ШинаПроверки);	
	ПозицияТире = СтрНайти(ВсеШиныВКоробке, ":",, НахождениеШиныВСтроке);  
	ПозицияТочкиСЗапятой = СтрНайти(ВсеШиныВКоробке, ";",, ПозицияТире);  
	
	КоличествоШиныВКоробке = Сред(ВсеШиныВКоробке, ПозицияТире + 2, ПозицияТочкиСЗапятой - ПозицияТире - 2);
	
	Возврат КоличествоШиныВКоробке;
```

## Функция ПолучениеКоличестваШинПоЗаказу(НомерСчета, ШинаПроверки)
```
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	СгруппированныеЗаказыСклад.ПроверкаОстаткаШинДляВыбораКоробки КАК ПроверкаОстаткаШинДляВыбораКоробки,
		|	СгруппированныеЗаказыСклад.Номеклатура КАК Номеклатура,
		|	СгруппированныеЗаказыСклад.Ссылка КАК Ссылка,
		|	СгруппированныеЗаказыСклад.НомерСчета КАК НомерСчета
		|ИЗ
		|	Документ.СгруппированныеЗаказыСклад КАК СгруппированныеЗаказыСклад
		|ГДЕ
		|	СгруппированныеЗаказыСклад.Номеклатура ПОДОБНО &Номеклатура
		|	И СгруппированныеЗаказыСклад.НомерСчета = &НомерСчета";
	
	Запрос.УстановитьПараметр("Номеклатура", "%" + ШинаПроверки + "%");
	Запрос.УстановитьПараметр("НомерСчета", НомерСчета);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		Возврат ВыборкаДетальныеЗаписи.ПроверкаОстаткаШинДляВыбораКоробки;
	КонецЦикла;
	
	Возврат 0;
```

## Процедура Печатать(Команда)
```	
	СозданиеСменногоЗаданияУпаковкиШин();
```

## Процедура ПечататьНаСервере(ТабДок) 
```

	Макет = Документы.СгруппированныеЗаказыСклад.ПолучитьМакет("СменноеЗаданиеКоробок");
	
	ТабДок.ОриентацияСтраницы = ОриентацияСтраницы.Ландшафт;
	
	ОбластьЗаголовок = Макет.ПолучитьОбласть("Заголовок");  
	ТабДок.Вывести(ОбластьЗаголовок);
	
	ОбластьПодходящиеКоробкиШапка= Макет.ПолучитьОбласть("ПодходящиеКоробкиШапка");  
	ТабДок.Вывести(ОбластьПодходящиеКоробкиШапка);
	
	Для каждого Коробка из ЭтаФорма.Объект.КоробкиКоторыеМожноЗаполнять Цикл
		Если Коробка.ЗаполнитьКоробку = Истина Тогда
			ОбластьПодходящиеКоробки = Макет.ПолучитьОбласть("ПодходящиеКоробки"); 
			
			ОбластьПодходящиеКоробки.Параметры.ВсеШиныВКоробке = Коробка.ВсеШиныВКоробке;
			ОбластьПодходящиеКоробки.Параметры.КоробкиЦПМ      = Коробка.КоробкиЦПМ;
			ОбластьПодходящиеКоробки.Параметры.ВесКоробки      = Коробка.ВесКоробки;
			ОбластьПодходящиеКоробки.Параметры.НомерСчета      = Коробка.НомерСчета;
			ОбластьПодходящиеКоробки.Параметры.Комментарий     = Коробка.Комментарий;
			
			ТабДок.Вывести(ОбластьПодходящиеКоробки);
		КонецЕсли;
	КонецЦикла;	
```

## Функция НахождениеВсехШинПоЗаказу(НомерСчета)
```
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	СгруппированныеЗаказыСклад.НомерСчета КАК НомерСчета,
	|	СгруппированныеЗаказыСклад.Номеклатура КАК Номеклатура,
	|	СгруппированныеЗаказыСклад.Ссылка КАК Ссылка,
	|	СгруппированныеЗаказыСклад.ПрозводствоСЛиний КАК ПрозводствоСЛиний,
	|	СгруппированныеЗаказыСклад.КоличествоПоЗаказу КАК КоличествоПоЗаказу,
	|	СгруппированныеЗаказыСклад.ПроверкаОстаткаШинДляВыбораКоробки КАК ПроверкаОстаткаШинДляВыбораКоробки
	|ИЗ
	|	Документ.СгруппированныеЗаказыСклад КАК СгруппированныеЗаказыСклад
	|ГДЕ
	|	СгруппированныеЗаказыСклад.НомерСчета = &НомерСчета";
	
	Запрос.УстановитьПараметр("НомерСчета", НомерСчета);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать(); 
	
	ВсеШиныВЗаказе = Новый ТаблицаЗначений;
	ВсеШиныВЗаказе.Колонки.Добавить("Номеклатура");
    ВсеШиныВЗаказе.Колонки.Добавить("СделаноШин"); 
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл  
		
		ОбъектПозиции = ВыборкаДетальныеЗаписи.Ссылка.ПолучитьОбъект();
		
		Стр = ВсеШиныВЗаказе.Добавить();
		
		Стр.Номеклатура = ОбъектПозиции.Номеклатура; 
		
		Если ОбъектПозиции.Номеклатура = Объект.Номеклатура Тогда
			Стр.СделаноШин  = Объект.ПроверкаОстаткаШинДляВыбораКоробки;
		Иначе
			Стр.СделаноШин  = ОбъектПозиции.ПроверкаОстаткаШинДляВыбораКоробки;
		КонецЕсли;	
		
	КонецЦикла;
	
	Возврат ВсеШиныВЗаказе;	
```

## Процедура СозданиеСменногоЗаданияУпаковкиШин() 
```

	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	СменноеЗаданиеУпаковкиШин.Ссылка КАК Ссылка,
		|	СменноеЗаданиеУпаковкиШин.ДатаДляЗполнения КАК ДатаДляЗполнения
		|ИЗ
		|	Документ.СменноеЗаданиеУпаковкиШин КАК СменноеЗаданиеУпаковкиШин
		|ГДЕ
		|	СменноеЗаданиеУпаковкиШин.ДатаДляЗполнения = &ТекущаяДата";
	
	Запрос.УстановитьПараметр("ТекущаяДата", Дата(Год(ТекущаяДата()),Месяц(ТекущаяДата()), День(ТекущаяДата()) ));
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Если ВыборкаДетальныеЗаписи.Количество() = 0 Тогда
		
		НовыйДокумент = Документы.СменноеЗаданиеУпаковкиШин.СоздатьДокумент(); 
		
		НовыйДокумент.Дата = ТекущаяДата();
		НовыйДокумент.ДатаДляЗполнения = ТекущаяДата();
		
		Для каждого ВыбраннаяКоробка из Объект.КоробкиКоторыеМожноЗаполнять Цикл
			
			Если ВыбраннаяКоробка.ЗаполнитьКоробку = Истина Тогда
				
				НоваяСтрока = НовыйДокумент.КоробкиСменногоЗадания.Добавить();
				                             
				НоваяСтрока.ВсеШиныВКоробке              = ВыбраннаяКоробка.ВсеШиныВКоробке;
				НоваяСтрока.ВесКоробки                   = ВыбраннаяКоробка.ВесКоробки;
				НоваяСтрока.НомерСчета                   = ВыбраннаяКоробка.НомерСчета;
				НоваяСтрока.КоробкиЦПМ                   = ВыбраннаяКоробка.КоробкиЦПМ; 
				НоваяСтрока.Комментарий                  = ВыбраннаяКоробка.Комментарий;
				НоваяСтрока.СсылкаНаСгруппированныйЗаказ = ВыбраннаяКоробка.СсылкаНаСгруппированныйЗаказ;
				
				ОбъектКоробкиЦПМ =  ВыбраннаяКоробка.КоробкиЦПМ.ПолучитьОбъект();
				ОбъектКоробкиЦПМ.КоробкаБылаУпакована = Истина;
				ОбъектКоробкиЦПМ.Записать();
								
				ЗаполнитьКоличествоКоробокУОставшихсяПозиций(ВыбраннаяКоробка.КоробкиЦПМ,  ВыбраннаяКоробка.НомерСчета);
				
			КонецЕсли;
			
		КонецЦикла; 
		
	    СменноеЗаданиеПрошлогоДля = ПолучитСменноеЗаданиеПрошлогоДля();
		
		Если СменноеЗаданиеПрошлогоДля <> Неопределено Тогда 
			Для каждого СтрокаТЧ из СменноеЗаданиеПрошлогоДля Цикл
				
				НоваяСтрока = НовыйДокумент.КоробкиСменногоЗадания.Добавить();
				
				НоваяСтрока.ВсеШиныВКоробке              = СтрокаТЧ.ВсеШиныВКоробке;
				НоваяСтрока.ВесКоробки                   = СтрокаТЧ.ВесКоробки;
				НоваяСтрока.НомерСчета                   = СтрокаТЧ.НомерСчета;
				НоваяСтрока.КоробкиЦПМ                   = СтрокаТЧ.КоробкиЦПМ; 
				НоваяСтрока.Комментарий                  = СтрокаТЧ.Комментарий;
				НоваяСтрока.СсылкаНаСгруппированныйЗаказ = СтрокаТЧ.СсылкаНаСгруппированныйЗаказ;
				
			КонецЦикла; 
		КонецЕсли;
		
		НовыйДокумент.Записать();
		
	Иначе
		
		Пока ВыборкаДетальныеЗаписи.Следующий() Цикл 
			
			ОбъектУпаковкиШин = ВыборкаДетальныеЗаписи.Ссылка.ПолучитьОбъект(); 
			
			Для каждого ВыбраннаяКоробка из Объект.КоробкиКоторыеМожноЗаполнять Цикл
				
				Если ВыбраннаяКоробка.ЗаполнитьКоробку = Истина и ПроверкаВнесёнаЛиЭтаПозицияВСменноеЗадание(ВыбраннаяКоробка.КоробкиЦПМ, ОбъектУпаковкиШин.КоробкиСменногоЗадания) Тогда
					
					НоваяСтрока = ОбъектУпаковкиШин.КоробкиСменногоЗадания.Добавить();
					
					НоваяСтрока.ВсеШиныВКоробке              = ВыбраннаяКоробка.ВсеШиныВКоробке;
					НоваяСтрока.ВесКоробки                   = ВыбраннаяКоробка.ВесКоробки;
					НоваяСтрока.НомерСчета                   = ВыбраннаяКоробка.НомерСчета;
					НоваяСтрока.КоробкиЦПМ                   = ВыбраннаяКоробка.КоробкиЦПМ;
					НоваяСтрока.Комментарий                  = ВыбраннаяКоробка.Комментарий;
					НоваяСтрока.СсылкаНаСгруппированныйЗаказ = ВыбраннаяКоробка.СсылкаНаСгруппированныйЗаказ;
					
					ОбъектКоробкиЦПМ =  ВыбраннаяКоробка.КоробкиЦПМ.ПолучитьОбъект();
					ОбъектКоробкиЦПМ.КоробкаБылаУпакована = Истина;
				    ОбъектКоробкиЦПМ.Записать();
					
					ЗаполнитьКоличествоКоробокУОставшихсяПозиций(ВыбраннаяКоробка.КоробкиЦПМ,  ВыбраннаяКоробка.НомерСчета);
					
				КонецЕсли;
				
			КонецЦикла;
			
			ОбъектУпаковкиШин.Записать();
			
		КонецЦикла;
		
	КонецЕсли;
```

## Функция ПроверкаНаВсеЛиЗаказыЗаполнены(ПодходящиеКоробки, КоличествоПоЗаказу, ПрозводствоСЛиний, ПроверкаОстаткаШинДляВыбораКоробки)
```
	Для каждого ПроверкаКоробки из ПодходящиеКоробки Цикл
		Если ПроверкаКоробки.КоробкаБылаУпакована = Истина и КоличествоПоЗаказу = ПрозводствоСЛиний и ПроверкаОстаткаШинДляВыбораКоробки = 0 Тогда 
			Возврат Истина;
		КонецЕсли;
	КонецЦикла;
	
	Возврат Ложь;
	
```

## Процедура ПерезаполнитьПодходящиеКоробки(ОбъектСгуппированногоЗаказа) 
```
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	КоробкиЦПМ.Ссылка КАК Ссылка,
	|	КоробкиЦПМ.ЗаказНаПроизводствоКоробки КАК ЗаказНаПроизводствоКоробки,
	|	КоробкиЦПМ.ВсеШиныВКоробке КАК ВсеШиныВКоробке,
	|	КоробкиЦПМ.ВесКоробки КАК ВесКоробки,
	|	КоробкиЦПМ.КоробкаБылаУпакована КАК КоробкаБылаУпакована
	|ИЗ
	|	Справочник.КоробкиЦПМ КАК КоробкиЦПМ
	|ГДЕ
	|	КоробкиЦПМ.ЗаказНаПроизводствоКоробки = &НомерСчёта";
	
	Запрос.УстановитьПараметр("НомерСчёта", ОбъектСгуппированногоЗаказа.НомерСчета);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	КоробкиДляСборки = Новый Массив;  
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл 
		
		Если СтрНайти(ВыборкаДетальныеЗаписи.ВсеШиныВКоробке, ПолучениеШиныПоНоменклатуреДляПерезаписи(ОбъектСгуппированногоЗаказа)) Тогда
			СсылкаИШиныИФактУпаковки = Новый Структура;
			СсылкаИШиныИФактУпаковки.Вставить("ВсеШиныВКоробке", ВыборкаДетальныеЗаписи.ВсеШиныВКоробке);
			СсылкаИШиныИФактУпаковки.Вставить("Ссылка", ВыборкаДетальныеЗаписи.Ссылка);
			СсылкаИШиныИФактУпаковки.Вставить("КоробкаУжеУпакована", ВыборкаДетальныеЗаписи.КоробкаБылаУпакована);
			КоробкиДляСборки.Добавить(СсылкаИШиныИФактУпаковки);
		КонецЕсли;
		
	КонецЦикла;
	
	Если ВыборкаДетальныеЗаписи <> Неопределено Тогда 
		СтруктураДляПоиска = Новый Структура("КоробкаБылаУпакована", Ложь);  
		
		ТабличнаяЧастьПодходящихКоробок = ОбъектСгуппированногоЗаказа.ПодходящиеКоробки; 
		
		МассивНеУпакованныхКоробок = ТабличнаяЧастьПодходящихКоробок.НайтиСтроки(СтруктураДляПоиска);
		
		Для каждого Строка Из МассивНеУпакованныхКоробок Цикл 
			ТабличнаяЧастьПодходящихКоробок.Удалить(Строка); 
		КонецЦикла; 
		
		КоробкиДляЗаписиВТЧ = ПоискПодходящихКоробокПоСделаннымШинам(КоробкиДляСборки, ОбъектСгуппированногоЗаказа.НомерСчета, 0,"");
		
		Если КоробкиДляЗаписиВТЧ.Количество() <> 0 Тогда
			ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать(); 
			
			Для Каждого КоробкаШины из КоробкиДляЗаписиВТЧ Цикл 
				Пока ВыборкаДетальныеЗаписи.Следующий() Цикл 
					
					Если ВыборкаДетальныеЗаписи.Ссылка = КоробкаШины.Ссылка Тогда
						
						НоваяСтрока = ОбъектСгуппированногоЗаказа.ПодходящиеКоробки.Добавить(); 
						
						//НоваяСтрока.ЗаполнитьКоробкуШинами = БиблиотекаКартинок.ОформлениеЗнакФлажок;
						НоваяСтрока.КоробкиЦПМ           = ВыборкаДетальныеЗаписи.Ссылка;
						НоваяСтрока.ВсеШиныВКоробке      = КоробкаШины.ВсеШиныВКоробке;
						НоваяСтрока.ВесКоробки           = ВыборкаДетальныеЗаписи.ВесКоробки;
						НоваяСтрока.КоробкаБылаУпакована = ВыборкаДетальныеЗаписи.КоробкаБылаУпакована;
						Прервать;
						
					КонецЕсли;			
					
				КонецЦикла;
				
			КонецЦикла;	
		КонецЕсли;
		
		ОбъектСгуппированногоЗаказа.КлКоробокДляЗаполнения = ОбъектСгуппированногоЗаказа.ПодходящиеКоробки.Количество(); 
		
		ПерезаполнитьПодходящиеКоробкиУДругихПозиций(РезультатЗапроса.Выгрузить()[0].ЗаказНаПроизводствоКоробки);
		
	КонецЕсли; 
	
	///////// Временно потом сразу из регистра подтягиваться будется
	//Если ОбъектСгуппированногоЗаказа.ПроверкаОстаткаШинДляВыбораКоробки = 0 Тогда 
	//	ОбъектСгуппированногоЗаказа.ПроверкаОстаткаШинДляВыбораКоробки = ОбъектСгуппированногоЗаказа.ПрозводствоСЛиний;
	//КонецЕсли;
```

## Функция ПоискПодходящихКоробокПоСделаннымШинам(КоробкиДляСборки, НомерСчета, ОставщеесяЧислоШин, Номенклатура)
```

	КоробкиДляВозврата = Новый Массив;
	
	Для каждого СписокШинВКоробке из КоробкиДляСборки Цикл
		
		МожноЛиВноситьКоробкуВТЧ = Новый Массив();
		
		ВсеШиныДляПроверки = СтрРазделить(СписокШинВКоробке.ВсеШиныВКоробке, ";");
		
		ТекущаяШина = ПолучениеШиныПоНоменклатуре(Номенклатура);       
				
		Для каждого ОднаИзШин из ВсеШиныДляПроверки Цикл
			
			Если ОднаИзШин <> "" Тогда
				
				ПозицияДвоеточия = СтрНайти(ОднаИзШин, ":");
				ШинаПроверки     = Лев(ОднаИзШин, ПозицияДвоеточия - 1); 
				
				Если ШинаПроверки = ТекущаяШина Тогда
					КоличествоШиныВКоробке = ПолучениеКоличестваШинПоСтроке(СписокШинВКоробке.ВсеШиныВКоробке, ШинаПроверки); 
					
					Если ОставщеесяЧислоШин >= Число(КоличествоШиныВКоробке) или СписокШинВКоробке.КоробкаУжеУпакована Тогда
						МожноЛиВноситьКоробкуВТЧ.Добавить(Истина);
					Иначе
						МожноЛиВноситьКоробкуВТЧ.Добавить(Ложь);
						Прервать;
					КонецЕсли;
				ИначеЕсли СтрНайти(СписокШинВКоробке.ВсеШиныВКоробке, ШинаПроверки) > 0 Тогда   
					КоличествоШиныВКоробке    = ПолучениеКоличестваШинПоСтроке(СписокШинВКоробке.ВсеШиныВКоробке, ШинаПроверки);
					ОставщеесяЧислоШинПозиции = ПолучениеКоличестваШинПоЗаказу(НомерСчета, ШинаПроверки); 
					
					Если ОставщеесяЧислоШинПозиции >= Число(КоличествоШиныВКоробке) или СписокШинВКоробке.КоробкаУжеУпакована Тогда
						МожноЛиВноситьКоробкуВТЧ.Добавить(Истина);
					Иначе
						МожноЛиВноситьКоробкуВТЧ.Добавить(Ложь);
						Прервать;
					КонецЕсли;
					
				КонецЕсли;
				
			КонецЕсли;
					
		КонецЦикла;
		
		КоробкуМожноЗаписыватьВТЧ = Ложь;
		Для каждого ПроверкаНаВнесение из МожноЛиВноситьКоробкуВТЧ Цикл 
			Если ПроверкаНаВнесение = Истина Тогда
				КоробкуМожноЗаписыватьВТЧ = Истина;
			Иначе
				КоробкуМожноЗаписыватьВТЧ = Ложь;
				Прервать;	
			КонецЕсли;
		КонецЦикла;
		
		Если КоробкуМожноЗаписыватьВТЧ Тогда 
			СсылкаИШины = Новый Структура;
			СсылкаИШины.Вставить("ВсеШиныВКоробке", СписокШинВКоробке.ВсеШиныВКоробке);
			СсылкаИШины.Вставить("Ссылка", СписокШинВКоробке.Ссылка); 
			СсылкаИШины.Вставить("КоробкаУжеУпакована", СписокШинВКоробке.КоробкаУжеУпакована);
			СсылкаИШины.Вставить("ВесКоробки", СписокШинВКоробке.ВесКоробки);
			КоробкиДляВозврата.Добавить(СсылкаИШины);
		КонецЕсли;
		
	КонецЦикла;
	
	Возврат КоробкиДляВозврата;	
```  

## Процедура ПерезаполнитьПодходящиеКоробкиУДругихПозиций(НомерСчета)
```	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	СгруппированныеЗаказыСклад.Ссылка КАК Ссылка,
	|	СгруппированныеЗаказыСклад.НомерСчета КАК НомерСчета,
	|	СгруппированныеЗаказыСклад.Номеклатура КАК Номеклатура
	|ИЗ
	|	Документ.СгруппированныеЗаказыСклад КАК СгруппированныеЗаказыСклад
	|ГДЕ
	|	СгруппированныеЗаказыСклад.НомерСчета = &НомерСчета";
	
	Запрос.УстановитьПараметр("НомерСчета", НомерСчета);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		
		Если ВыборкаДетальныеЗаписи.Номеклатура <> Объект.Номеклатура Тогда 
			ОбъектЗаказа = ВыборкаДетальныеЗаписи.Ссылка.ПолучитьОбъект();
			
			Запрос = Новый Запрос;
			Запрос.Текст = 
			"ВЫБРАТЬ
			|	КоробкиЦПМ.Ссылка КАК Ссылка,
			|	КоробкиЦПМ.ЗаказНаПроизводствоКоробки КАК ЗаказНаПроизводствоКоробки,
			|	КоробкиЦПМ.ВсеШиныВКоробке КАК ВсеШиныВКоробке,
			|	КоробкиЦПМ.ВесКоробки КАК ВесКоробки,
			|	КоробкиЦПМ.КоробкаБылаУпакована КАК КоробкаБылаУпакована
			|ИЗ
			|	Справочник.КоробкиЦПМ КАК КоробкиЦПМ
			|ГДЕ
			|	КоробкиЦПМ.ЗаказНаПроизводствоКоробки = &НомерСчёта";
			
			Запрос.УстановитьПараметр("НомерСчёта", ОбъектЗаказа.НомерСчета);
			
			РезультатЗапросаНижнего = Запрос.Выполнить();
			
			ВыборкаДетальныеЗаписиНижнийЗапрос = РезультатЗапросаНижнего.Выбрать();
			
			КоробкиДляСборки = Новый Массив;
			
			Пока ВыборкаДетальныеЗаписиНижнийЗапрос.Следующий() Цикл 
				
				Если СтрНайти(ВыборкаДетальныеЗаписиНижнийЗапрос.ВсеШиныВКоробке, ПолучениеШиныПоНоменклатуреДляПерезаписи(ОбъектЗаказа)) Тогда
					СсылкаИШиныИФактУпаковки = Новый Структура;
					СсылкаИШиныИФактУпаковки.Вставить("ВсеШиныВКоробке",     ВыборкаДетальныеЗаписиНижнийЗапрос.ВсеШиныВКоробке);
					СсылкаИШиныИФактУпаковки.Вставить("Ссылка",              ВыборкаДетальныеЗаписиНижнийЗапрос.Ссылка);
					СсылкаИШиныИФактУпаковки.Вставить("КоробкаУжеУпакована", ВыборкаДетальныеЗаписиНижнийЗапрос.КоробкаБылаУпакована);	
					КоробкиДляСборки.Добавить(СсылкаИШиныИФактУпаковки);
				КонецЕсли;
				
			КонецЦикла;
			
			Если ВыборкаДетальныеЗаписиНижнийЗапрос <> Неопределено Тогда
				СтруктураДляПоиска = Новый Структура("КоробкаБылаУпакована", Ложь);  
				
				ТабличнаяЧастьПодходящихКоробок = ОбъектЗаказа.ПодходящиеКоробки; 
				
				МассивНеУпакованныхКоробок = ТабличнаяЧастьПодходящихКоробок.НайтиСтроки(СтруктураДляПоиска);
				
				Для каждого Строка Из МассивНеУпакованныхКоробок Цикл 
					ТабличнаяЧастьПодходящихКоробок.Удалить(Строка); 
				КонецЦикла;
				КоробкиДляЗаписиВТЧ = ПоискПодходящихКоробокПоСделаннымШинам(КоробкиДляСборки, ОбъектЗаказа.НомерСчета, 0, "");
				
				Если КоробкиДляЗаписиВТЧ.Количество() <> 0 Тогда
					ВыборкаДетальныеЗаписиНижнийЗапрос = РезультатЗапросаНижнего.Выбрать(); 
					
					Для Каждого КоробкаШины из КоробкиДляЗаписиВТЧ Цикл 
						Пока ВыборкаДетальныеЗаписиНижнийЗапрос.Следующий() Цикл 
							
							Если ВыборкаДетальныеЗаписиНижнийЗапрос.Ссылка = КоробкаШины.Ссылка Тогда
								
								НоваяСтрока = ОбъектЗаказа.ПодходящиеКоробки.Добавить(); 
								
								//НоваяСтрока.ЗаполнитьКоробкуШинами = БиблиотекаКартинок.ОформлениеЗнакФлажок;
								НоваяСтрока.КоробкиЦПМ = ВыборкаДетальныеЗаписиНижнийЗапрос.Ссылка;
								НоваяСтрока.ВсеШиныВКоробке = КоробкаШины.ВсеШиныВКоробке;
								НоваяСтрока.ВесКоробки = ВыборкаДетальныеЗаписиНижнийЗапрос.ВесКоробки; 
								Прервать;
								
							КонецЕсли;			
							
						КонецЦикла;
						
					КонецЦикла;
					
				КонецЕсли;
				
				ОбъектЗаказа.КлКоробокДляЗаполнения = ОбъектЗаказа.ПодходящиеКоробки.Количество();
				
			КонецЕсли;
		КонецЕсли;
		
	КонецЦикла;
	
```

## Функция ПолучениеШиныПоНоменклатуреДляПерезаписи(Шина);
```	
	НаходимПозициюХ     = СтрНайти(Шина.Номеклатура, "х");                                              // В номенклатуре находим позицию x 
	НаходимЛевыйПробел  = СтрНайти(Шина.Номеклатура, " ", НаправлениеПоиска.СКонца, НаходимПозициюХ);   // Находим позицию пробела слева от x
	НаходимПравыйПробел = СтрНайти(Шина.Номеклатура, " ", НаправлениеПоиска.СНачала, НаходимПозициюХ);  // Находим позицию пробела справа от x
	
	КоличествоСимволовСлева  = НаходимПозициюХ - НаходимЛевыйПробел;                                    // Число символов, слева от пробела и до x 
	КоличествоСимволовСправа = НаходимПравыйПробел - НаходимПозициюХ;                                   // Число символов, справа от пробела и до x
	
	ВысотаПозиции = Сред(Шина.Номеклатура, НаходимЛевыйПробел + 1, КоличествоСимволовСлева - 1);        // Находим высоту    	
	ШиринаПозиции = Сред(Шина.Номеклатура, НаходимПозициюХ + 1, КоличествоСимволовСправа - 1);          // Находим ширину
	
	ШинаПроверки = ВысотаПозиции + "х" + ШиринаПозиции;  
	
	Возврат ШинаПроверки;
```

## Функция ПроверкаВнесёнаЛиЭтаПозицияВСменноеЗадание(ТекущаяКоробка, КоробкиСменногоЗадания)

```	
	Для каждого УпаковкаШин из КоробкиСменногоЗадания Цикл
		
		Если УпаковкаШин.КоробкиЦПМ = ТекущаяКоробка Тогда 	
			Возврат Ложь;    	
		КонецЕсли; 
		
	КонецЦикла; 
	
	Возврат Истина;
```

## Процедура УдалениеПрошлойРазбивкиКоробокИзСправочникаКоробкиЦПМ(Заказ, Параметры)

```	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	КоробкиЦПМ.ЗаказНаПроизводствоКоробки КАК ЗаказНаПроизводствоКоробки,
		|	КоробкиЦПМ.Ссылка КАК Ссылка,
		|	КоробкиЦПМ.КоробкаБылаУпакована КАК КоробкаБылаУпакована
		|ИЗ
		|	Справочник.КоробкиЦПМ КАК КоробкиЦПМ
		|ГДЕ
		|	КоробкиЦПМ.ЗаказНаПроизводствоКоробки ПОДОБНО &ЗаказНаПроизводствоКоробки";
	
	Запрос.УстановитьПараметр("ЗаказНаПроизводствоКоробки", Заказ.НомерСчета);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл  
		ЭтуКоробкуУдаляем = ПроверитьВыбранаЛиПозицияНаВноситьВПечать(Параметры, ВыборкаДетальныеЗаписи.Ссылка);
		Если ВыборкаДетальныеЗаписи.КоробкаБылаУпакована = Ложь и ЭтуКоробкуУдаляем Тогда
			
			ОбъекКоробкиЦПМ = ВыборкаДетальныеЗаписи.Ссылка.ПолучитьОбъект();
			
			ОбъекКоробкиЦПМ.Удалить();
			
		КонецЕсли;
	КонецЦикла;
``` 

## Функция ВернутьДлиннуИзЗаказаНаПроизводство(Номеклатура, НомерСчета) 

 ```
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ЗаказыВПроизводствоЦПМ.Ссылка КАК Ссылка,
	|	ЗаказыВПроизводствоЦПМ.НоменклатураERP КАК НоменклатураERP,
	|	ЗаказыВПроизводствоЦПМ.НомерСчета КАК НомерСчета,
	|	ЗаказыВПроизводствоЦПМ.Длина КАК Длина
	|ИЗ
	|	Документ.ЗаказыВПроизводствоЦПМ КАК ЗаказыВПроизводствоЦПМ
	|ГДЕ
	|	ЗаказыВПроизводствоЦПМ.НоменклатураERP ПОДОБНО &НоменклатураERP
	|	И ЗаказыВПроизводствоЦПМ.НомерСчета ПОДОБНО &НомерСчета";
	
	Запрос.УстановитьПараметр("НоменклатураERP", Номеклатура);
	Запрос.УстановитьПараметр("НомерСчета",      НомерСчета + "%");
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		Возврат ВыборкаДетальныеЗаписи.Длина;
	КонецЦикла;
```

## Функция ПроверкаЕстьЛиУжеТакойНомерСчета(МассивНомеровСчетов, НомерСчетаЗаказа)

```
	Для Каждого НомерСчета из МассивНомеровСчетов Цикл
		
		Если НомерСчетаЗаказа = НомерСчета Тогда 
			Возврат Ложь;
		КонецЕсли;
		
	КонецЦикла;	
	
	Возврат Истина;
```  
                    
## Процедура ЗаполнитьСгруппированныеЗаказыНовойРазбивкой(Заказ) 

```
	ОбъектСгруппированногоЗаказа = Заказ.Ссылка.ПолучитьОбъект();
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	КоробкиЦПМ.НоменклатураВКоробке.(
		|		Номенклатура КАК Номенклатура,
		|		НужноУпаковать КАК НужноУпаковать
		|	) КАК НоменклатураВКоробке,
		|	КоробкиЦПМ.ЗаказНаПроизводствоКоробки КАК ЗаказНаПроизводствоКоробки,
		|	КоробкиЦПМ.ВсеШиныВКоробке КАК ВсеШиныВКоробке,
		|	КоробкиЦПМ.Ссылка КАК Ссылка,
		|	КоробкиЦПМ.ВесКоробки КАК ВесКоробки
		|ИЗ
		|	Справочник.КоробкиЦПМ КАК КоробкиЦПМ
		|ГДЕ
		|	КоробкиЦПМ.ЗаказНаПроизводствоКоробки = &ЗаказНаПроизводствоКоробки
		|	И КоробкиЦПМ.НоменклатураВКоробке.Номенклатура ПОДОБНО &Номенклатура";
	
	Запрос.УстановитьПараметр("ЗаказНаПроизводствоКоробки", ОбъектСгруппированногоЗаказа.НомерСчета);
	Запрос.УстановитьПараметр("Номенклатура",               ОбъектСгруппированногоЗаказа.Номеклатура);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл  
		
		КоробкуМожноДобавитьВТЧ = Истина;
		Для каждого НоменклатураВКоробки из ВыборкаДетальныеЗаписи.Ссылка.НоменклатураВКоробке Цикл
			
			ЗапросПоискСгрупЗаказа = Новый Запрос;
			ЗапросПоискСгрупЗаказа.Текст = 
			"ВЫБРАТЬ
			|	СгруппированныеЗаказыСклад.Номеклатура КАК Номеклатура,
			|	СгруппированныеЗаказыСклад.НомерСчета КАК НомерСчета,
			|	СгруппированныеЗаказыСклад.ПроверкаОстаткаШинДляВыбораКоробки КАК ПроверкаОстаткаШинДляВыбораКоробки
			|ИЗ
			|	Документ.СгруппированныеЗаказыСклад КАК СгруппированныеЗаказыСклад
			|ГДЕ
			|	СгруппированныеЗаказыСклад.Номеклатура ПОДОБНО &Номеклатура
			|	И СгруппированныеЗаказыСклад.НомерСчета = &НомерСчета";
			
			ЗапросПоискСгрупЗаказа.УстановитьПараметр("Номеклатура", НоменклатураВКоробки.Номенклатура);
			ЗапросПоискСгрупЗаказа.УстановитьПараметр("НомерСчета",  ОбъектСгруппированногоЗаказа.НомерСчета);
			
			РезультатЗапросаСгрупЗаказа = ЗапросПоискСгрупЗаказа.Выполнить();
			
			ВыборкаДетальныеЗаписиСгрупЗаказа = РезультатЗапросаСгрупЗаказа.Выбрать();
			
			Пока ВыборкаДетальныеЗаписиСгрупЗаказа.Следующий() Цикл
				
				ВысотаИШирина = ФормированиеРабочихМассивов.ПолучитьВысотуИШиринуШины(ВыборкаДетальныеЗаписиСгрупЗаказа.Номеклатура);
				
				ПозицияНоменклатуры = СтрНайти(ВыборкаДетальныеЗаписи.ВсеШиныВКоробке, ВысотаИШирина.ВысотаПозиции + "х" + ВысотаИШирина.ШиринаПозиции);
				ПозицияТире = СтрНайти(ВыборкаДетальныеЗаписи.ВсеШиныВКоробке, ":",, ПозицияНоменклатуры);  
				ПозицияТочкиСЗапятой = СтрНайти(ВыборкаДетальныеЗаписи.ВсеШиныВКоробке, ";",, ПозицияТире);  
				
				КоличествоШиныВКоробке = Сред(ВыборкаДетальныеЗаписи.ВсеШиныВКоробке, ПозицияТире + 2, ПозицияТочкиСЗапятой - ПозицияТире - 2);
				
				Если ВыборкаДетальныеЗаписиСгрупЗаказа.ПроверкаОстаткаШинДляВыбораКоробки >= Число(КоличествоШиныВКоробке) Тогда
				Иначе
					КоробкуМожноДобавитьВТЧ = Ложь;	
				КонецЕсли;

			КонецЦикла;
			
			Если КоробкуМожноДобавитьВТЧ = Ложь Тогда
				Прервать;
			КонецЕсли;
			
		КонецЦикла;
		
		Если КоробкуМожноДобавитьВТЧ = Истина Тогда 
			СтрокаТЧ = ОбъектСгруппированногоЗаказа.ПодходящиеКоробки.Добавить();
			
			СтрокаТЧ.ВсеШиныВКоробке      = ВыборкаДетальныеЗаписи.ВсеШиныВКоробке;
			СтрокаТЧ.ВесКоробки           = ВыборкаДетальныеЗаписи.ВесКоробки; 
			СтрокаТЧ.КоробкиЦПМ           = ВыборкаДетальныеЗаписи.Ссылка; 
			СтрокаТЧ.КоробкаБылаУпакована = Ложь;		
		КонецЕсли;
		
	КонецЦикла;
	
	ОбъектСгруппированногоЗаказа.КлКоробокДляЗаполнения = ОбъектСгруппированногоЗаказа.ПодходящиеКоробки.Количество();
	
	ОбъектСгруппированногоЗаказа.Записать();
	
``` 

## Функция ПолучитСменноеЗаданиеПрошлогоДля()

```
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	СменноеЗаданиеУпаковкиШин.Ссылка КАК Ссылка,
	|	СменноеЗаданиеУпаковкиШин.ДатаДляЗполнения КАК ДатаДляЗполнения
	|ИЗ
	|	Документ.СменноеЗаданиеУпаковкиШин КАК СменноеЗаданиеУпаковкиШин
	|
	|УПОРЯДОЧИТЬ ПО
	|	СменноеЗаданиеУпаковкиШин.ДатаДляЗполнения УБЫВ";
	
	//Запрос.УстановитьПараметр("ТекущаяДата", Дата(Год(ТекущаяДата()),Месяц(ТекущаяДата()), День(ТекущаяДата()) -1 ));
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл 
		
		Отбор = Новый Структура;
		Отбор.Вставить("КоробкаУпакована", Ложь); 
		СтрокиДляЗаполнения = ВыборкаДетальныеЗаписи.Ссылка.КоробкиСменногоЗадания.НайтиСтроки(Отбор);
		
		Возврат СтрокиДляЗаполнения;  
		
	КонецЦикла; 
	
```

## Функция ПроверитьВыбранаЛиПозицияНаВноситьВПечать(Параметры, СсылкаНаКоробку)

 ```
	Для каждого Позиция из Параметры Цикл
		Если Позиция.РазбивкаВРучную = Ложь Тогда 
			
			Запрос = Новый Запрос;
			Запрос.Текст = 
			"ВЫБРАТЬ
			|	КоробкиЦПМ.НоменклатураВКоробке.(
			|		Номенклатура КАК Номенклатура
			|	) КАК НоменклатураВКоробке,
			|	КоробкиЦПМ.ЗаказНаПроизводствоКоробки КАК ЗаказНаПроизводствоКоробки,
			|	КоробкиЦПМ.Ссылка КАК Ссылка
			|ИЗ
			|	Справочник.КоробкиЦПМ КАК КоробкиЦПМ
			|ГДЕ
			|	КоробкиЦПМ.ЗаказНаПроизводствоКоробки = &ЗаказНаПроизводствоКоробки
			|	И КоробкиЦПМ.НоменклатураВКоробке.Номенклатура ПОДОБНО &Номенклатура";
			
			Запрос.УстановитьПараметр("ЗаказНаПроизводствоКоробки", Позиция.НомерСчета);
			Запрос.УстановитьПараметр("Номенклатура",               Позиция.Номенклатура);
			
			РезультатЗапроса = Запрос.Выполнить();
			
			ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
			
			Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
				Если ВыборкаДетальныеЗаписи.Ссылка.НоменклатураВКоробке.Количество() = 1 Тогда
					Если СсылкаНаКоробку = ВыборкаДетальныеЗаписи.Ссылка Тогда 
						Возврат Ложь;
					КонецЕсли;
				КонецЕсли;			
			КонецЦикла;
			
		КонецЕсли;	
		
	КонецЦикла;
	
	Возврат Истина;

```  

## Процедура ЗаполнитьКоличествоКоробокУОставшихсяПозиций(КоробкиЦПМ, НомерСчета) 

```	
	Для каждого Позиции из КоробкиЦПМ.НоменклатураВКоробке Цикл
		
		Запрос = Новый Запрос;
		Запрос.Текст = 
		"ВЫБРАТЬ
		|	СгруппированныеЗаказыСклад.Ссылка КАК Ссылка,
		|	СгруппированныеЗаказыСклад.Номеклатура КАК Номеклатура,
		|	СгруппированныеЗаказыСклад.НомерСчета КАК НомерСчета
		|ИЗ
		|	Документ.СгруппированныеЗаказыСклад КАК СгруппированныеЗаказыСклад
		|ГДЕ
		|	СгруппированныеЗаказыСклад.Номеклатура ПОДОБНО &Номеклатура
		|	И СгруппированныеЗаказыСклад.НомерСчета = &НомерСчета";
		
		Запрос.УстановитьПараметр("Номеклатура", Позиции.Номенклатура);
		Запрос.УстановитьПараметр("НомерСчета",  НомерСчета);
		
		РезультатЗапроса = Запрос.Выполнить();
		
		ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
		
		Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
			ОбъектСгрупЗак = ВыборкаДетальныеЗаписи.Ссылка.ПолучитьОбъект(); 
			ОбъектСгрупЗак.КлКоробокДляЗаполнения = ОбъектСгрупЗак.КлКоробокДляЗаполнения - 1;
			ОбъектСгрупЗак.ЗаказПолностьюУпакован = ПроверкаНаВсеЛиЗаказыЗаполнены(ОбъектСгрупЗак.ПодходящиеКоробки, ОбъектСгрупЗак.КоличествоПоЗаказу, ОбъектСгрупЗак.ПрозводствоСЛиний, ОбъектСгрупЗак.ПроверкаОстаткаШинДляВыбораКоробки);
			Для каждого ПроверкаКоробки из ОбъектСгрупЗак.ПодходящиеКоробки Цикл
				Если КоробкиЦПМ = ПроверкаКоробки.КоробкиЦПМ Тогда
					ПроверкаКоробки.КоробкаБылаУпакована = Истина;
				КонецЕсли;
			КонецЦикла; 
			ОбъектСгрупЗак.Записать();
		КонецЦикла;		
		
	КонецЦикла;
```




