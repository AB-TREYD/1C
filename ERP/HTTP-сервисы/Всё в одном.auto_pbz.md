## Функция auto_pbz(Запрос)


<details>
<summary>Code</summary>

  
      	 
      	//Тут всё в кг!
      	
      	Ответ = Новый HTTPСервисОтвет(200);
      	Ответ.Заголовки.Вставить("Content-type","text/xml; charset=utf-8");    
      	//параметры
      	КодНоменклатуры = СокрЛП(Запрос.ПараметрыЗапроса.Получить("a"));
      	Количество 		= Число(СокрЛП(Запрос.ПараметрыЗапроса.Получить("b")));
      	Автор			= Справочники.Пользователи.НайтиПоНаименованию(Запрос.ПараметрыЗапроса.Получить("c"));
      	Дата			= Дата(Запрос.ПараметрыЗапроса.Получить("d"));
      	Признак 		= Запрос.ПараметрыЗапроса.Получить("e");
      	ЗаказКлиента	= Запрос.ПараметрыЗапроса.Получить("f");
      	ВМетрах			= Запрос.ПараметрыЗапроса.Получить("g");
      	ВШтуках			= Запрос.ПараметрыЗапроса.Получить("h");
      	Склад			= Запрос.ПараметрыЗапроса.Получить("k");
      	Комментарий		= Запрос.ПараметрыЗапроса.Получить("l");
      	idzak			= Запрос.ПараметрыЗапроса.Получить("m");
      	
      	Номенклатура = Справочники.Номенклатура.НайтиПоКоду(КодНоменклатуры);
      	//Параметры
      	Если 	Номенклатура 	= Справочники.Номенклатура.ПустаяСсылка() 
      		или Количество 		<= 0  
      		или Автор 			= Справочники.Пользователи.НайтиПоНаименованию("") 
      		или Автор 			= Справочники.Пользователи.ПустаяСсылка()
      		или Дата 			= Дата("00010101") 
      		или Признак 		= "" 
      		//или (Признак = "ОМД" и ЗаказКлиента = "")
      		тогда
      		Ответ = Новый HTTPСервисОтвет(500);
      	Иначе
      		Ответ = СоздатьПроизводствоБезЗаказа(Номенклатура,Количество,Автор,Дата,Признак,ЗаказКлиента,Склад,Комментарий,idzak);
      	КонецЕсли;
      	//500 - нет номенклатуры или колво = 0
      	//400 - нет спецификации 
      	//300 - ошибка внутри функции
      	//200 - топчик   
      
      	Возврат Ответ; 	
      КонецФункции    
</details>

## Функция СоздатьПроизводствоБезЗаказа(Номенклатура,Количество,Автор,Дата,Признак,ЗаказКлиента,Склад = "Участок обработки металлов давлением (ОМД)",Комментарий="",idzak = "")


<details>
<summary>Code</summary>

  
        
        	Ответ = Новый HTTPСервисОтвет(300);                                         
        	Если Признак = "ОМД" тогда   		
        		СкладПолучатель 	= Справочники.Склады.НайтиПоНаименованию(Склад);
        		СкладОбеспечение 	= Справочники.Склады.НайтиПоНаименованию("Участок обработки металлов давлением (ОМД)");					
        	ИначеЕсли Признак = "БЛ" тогда
        		СкладПолучатель 	= Справочники.Склады.НайтиПоНаименованию(Склад);
        		СкладОбеспечение 	= Справочники.Склады.НайтиПоНаименованию("Участок бескислородного литья (БЛ)");
        	КонецЕсли;
        	Запрос = Новый Запрос;
        	Запрос.Текст = 
        	"ВЫБРАТЬ
        	|	ПроизводствоБезЗаказаВыходныеИзделия.Номенклатура КАК Номенклатура
        	|ИЗ
        	|	Документ.ПроизводствоБезЗаказа.ВыходныеИзделия КАК ПроизводствоБезЗаказаВыходныеИзделия
        	|ГДЕ
        	|	ПроизводствоБезЗаказаВыходныеИзделия.idzak = &idzak";
        	
        	Запрос.УстановитьПараметр("idzak", idzak);
        	
        	РезультатЗапроса = Запрос.Выполнить();
        	
        	Если РезультатЗапроса.Выгрузить().Количество() = 0 или idzak <> "" тогда	
        		Если Признак <> "" тогда
        			Запрос = Новый Запрос;
        			Запрос.Текст = 
        			"ВЫБРАТЬ
        			|	РесурсныеСпецификации.Ссылка КАК Ссылка
        			|ИЗ
        			|	Справочник.РесурсныеСпецификации КАК РесурсныеСпецификации
        			|ГДЕ
        			|	РесурсныеСпецификации.Статус = &Статус
        			|	И РесурсныеСпецификации.ОсновноеИзделиеНоменклатура = &Номенклатура";	
        			Запрос.УстановитьПараметр("Номенклатура", Номенклатура);
        			Запрос.УстановитьПараметр("Статус", Перечисления.СтатусыСпецификаций.Действует);
        			РезультатЗапроса = Запрос.Выполнить().Выгрузить();	
        			Если РезультатЗапроса.Количество() тогда
        				Спец = РезультатЗапроса[0].ссылка;
        			Иначе
        				Возврат  Новый HTTPСервисОтвет(400);
        				//заглушка, чтобы не создавалось ничего если нет спецификации
        				Спец = Справочники.РесурсныеСпецификации.ПустаяСсылка();
        				Сообщить("Действующая спецификация для номенклатуры: " +  Номенклатура + " не найдена.");
        			КонецЕсли;  	
        			
        			ПБЗ = Документы.ПроизводствоБезЗаказа.СоздатьДокумент();                          	
        			ПБЗ.Организация = Справочники.Организации.НайтиПоНаименованию("КЗ"+" ""Эксперт"+"-Кабель""",Истина);
        			ПБЗ.Подразделение = Справочники.СтруктураПредприятия.НайтиПоНаименованию("ЦПМ",Истина);   
        			ПБЗ.ГруппировкаЗатрат = Перечисления.ГруппировкиЗатратВПроизводствеБезЗаказа.ПоСпецификациям; 
        			ПБЗ.Дата = Дата;  
        			ПБЗ.СозданАвтоматически = Истина;  
        			ПБЗ.Комментарий = Номенклатура.Наименование + " " + Комментарий;
        			ПБЗ.ВидЦены = Справочники.ВидыЦен.НайтиПоНаименованию("Плановая себестоимость",Истина);
        			ПБЗ.Валюта = Справочники.Валюты.НайтиПоНаименованию("руб.",истина);
        			ПБЗ.СпособРаспределенияЗатратНаВыходныеИзделия = Перечисления.СпособыРаспределенияЗатратНаВыходныеИзделия.ПоДолямСтоимости;
        			ПБЗ.Автор 		  = Пользователи.НайтиПоИмени("Admin");
        			ПБЗ.Ответственный = Автор;  
        			Если не ЗаказКлиента="" тогда ЗаказКлиента = Документы.ЗаказКлиента.НайтиПоРеквизиту("Номер",ЗаказКлиента) КонецЕсли;
        			
        			ПБЗ.СсылкаНаЗаказКлиента = ЗаказКлиента;
        			ПБЗ.ОбязательноеНаличиеСсылкиНаЗаказКлиента = ?(Строка(ЗаказКлиента)<>"",Истина,Ложь);
        			
        			НовСтр = ПБЗ.ВыходныеИзделия.Добавить();
        			НовСтр.Номенклатура = Номенклатура;
        			НовСтр.idzak = idzak;
        			НовСтр.НаправлениеВыпуска = Перечисления.ХозяйственныеОперации.ВыпускПродукцииНаСклад;
        			НовСтр.КоличествоУпаковок = Количество;
        			НовСтр.Количество = Количество;
        			НовСтр.Получатель = СкладПолучатель;   
        			НовСтр.Спецификация = Спец; 
        			НовСтр.НомерГруппыЗатрат = 1;
        			
        			ЗаполнитьМатериалыИРаботы(ПБЗ);
        			Для каждого СтрМатериалыИРаботы из ПБЗ.МатериалыИРаботы цикл
        				СтрМатериалыИРаботы.Склад = СкладОбеспечение;
        				СтрМатериалыИРаботы.НомерГруппыЗатрат = 1;
        			КонецЦикла;         
        			
        			СтруктураПоиска = Новый Структура("НомерГруппыЗатрат", 0);
        			Строки = ПБЗ.ПобочныеИзделия.НайтиСтроки(СтруктураПоиска);
        			Для Каждого ТекСтрока Из Строки Цикл
        				ТекСтрока.НомерГруппыЗатрат = 1;
        			КонецЦикла;
        			
        			Строки = ПБЗ.Трудозатраты.НайтиСтроки(СтруктураПоиска);
        			Для Каждого ТекСтрока Из Строки Цикл
        				ТекСтрока.НомерГруппыЗатрат = 1;
        			КонецЦикла;
        			ПБЗ.Записать();
        			ПБЗ.Записать(РежимЗаписиДокумента.Проведение);                     
        			Номер_и_дата_Сборки_разборки = АвтоСозданиеСборки(Номенклатура,Автор,Количество,idzak,Дата,СкладПолучатель);
        			Ответ = Новый HTTPСервисОтвет(200);                                         	
        			Ответ.Заголовки.Вставить("PBZ",Строка(ПБЗ.Номер)+" "+Строка(ПБЗ.Дата));
        			Ответ.Заголовки.Вставить("SBORKA",Номер_и_дата_Сборки_разборки);
        		КонецЕсли;
        	КонецЕсли;
        	Возврат Ответ;
        КонецФункции
</details>

## Процедура ЗаполнитьМатериалыИРаботы(ПБЗ)


<details>
<summary>Code</summary>

  
        	//         
        	ИмяТЧ = "МатериалыИРаботы";
        	//
        	
        	Запрос = Новый Запрос;
        	МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
        	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
        	
        	Запрос.Текст = Документы.ПроизводствоБезЗаказа.ТекстЗапросаМатериалыПоГруппамЗатрат();
        	Запрос.УстановитьПараметр("Дата", ПБЗ.Дата);
        	Запрос.УстановитьПараметр("ВидЦены", ПБЗ.ВидЦены);
        	Запрос.УстановитьПараметр("ЗаполнятьАвтоматически", Истина);
        	
        	// Подготовим таблицу продукции
        	ПоляГруппировки = "НомерГруппыЗатрат, НаправлениеВыпуска, Получатель,
        	|	Номенклатура, Характеристика, Серия,
        	|	Назначение, Спецификация";
        	ПоляСуммирования = "Количество";
        	
        	ТаблицаПродукции = ПБЗ.ВыходныеИзделия.Выгрузить(, ПоляГруппировки + ", " + ПоляСуммирования);
        	ТаблицаПродукции.Свернуть(ПоляГруппировки, ПоляСуммирования);
        	
        	ТаблицаПродукции.Колонки.Добавить("Организация",				Новый ОписаниеТипов("СправочникСсылка.Организации"));
        	ТаблицаПродукции.Колонки.Добавить("ГруппировкаЗатрат",			Новый ОписаниеТипов("ПеречислениеСсылка.ГруппировкиЗатратВПроизводствеБезЗаказа"));
        	ТаблицаПродукции.Колонки.Добавить("Подразделение",				Новый ОписаниеТипов("СправочникСсылка.СтруктураПредприятия"));
        	ТаблицаПродукции.Колонки.Добавить("ОшибкаВНастройкахМодели",	Новый ОписаниеТипов("Булево"));
        	ТаблицаПродукции.Колонки.Добавить("ОтражатьЗатратыДокументом",	Новый ОписаниеТипов("Булево"));
        	
        	ТаблицаПродукции.ЗаполнитьЗначения(ПБЗ.Организация,			"Организация");
        	ТаблицаПродукции.ЗаполнитьЗначения(ПБЗ.ГруппировкаЗатрат,	"ГруппировкаЗатрат");
        	ТаблицаПродукции.ЗаполнитьЗначения(ПБЗ.Подразделение,		"Подразделение");
        	ТаблицаПродукции.ЗаполнитьЗначения(Истина,						"ОтражатьЗатратыДокументом");
        	
        	// Подготовим параметры заполнения
        	ДанныеШапки = Новый Структура("Дата", ПБЗ.Дата);
        	
        	ПараметрыЗаполнения = Новый Структура("ДанныеШапки",	ДанныеШапки);
        	ПараметрыЗаполнения.Вставить("ЗаполнятьАвтоматически",	Истина);
        	
        	ПереченьДанных = Новый Массив;
        	ПереченьДанных.Добавить("МатериалыИУслуги");
        	ПараметрыЗаполнения.Вставить("ПереченьДанных", ПереченьДанных);
        	
        	// Получим данные спецификаций и поместим их в ВТ.
        	Документы.ПроизводствоБезЗаказа.ДанныеСпецификацииПоСпискуПродукции(ТаблицаПродукции,
        	ПараметрыЗаполнения,
        	МенеджерВременныхТаблиц);
        	
        	// Заполним затраты
        	ТаблицаЗатрат = Запрос.Выполнить().Выгрузить();
        	
        	Если Не ТаблицаЗатрат.Количество() = 0 Тогда
        		МассивСтрок = Новый Массив;
        		СтруктураПоиска = Новый Структура("НомерГруппыЗатрат", 0);
        		
        		ТаблицаОбъекта = ПБЗ[ИмяТЧ]; // ДанныеФормыКоллекция
        		Для Каждого ТекЗатрата Из ТаблицаЗатрат Цикл
        			
        			НоваяСтрока = ТаблицаОбъекта.Добавить();
        			ЗаполнитьЗначенияСвойств(НоваяСтрока, ТекЗатрата);
        			
        			СтруктураПоиска.НомерГруппыЗатрат = НоваяСтрока.НомерГруппыЗатрат;
        		КонецЦикла;
        	КонецЕсли;
        	
        КонецПроцедуры
</details>

##   Функция АвтоСозданиеСборки(Номенклатура,Ответственный,Колво,IDZAK="",Дата,Склад)  


<details>
<summary>Code</summary>

	Номер_и_дата_Сборки_разборки = "";
	Если не idzak = "" тогда
		//необходимо в Документы.сборкаТовара создать реквизит idzak 15длина строка
		УстановитьПривилегированныйРежим(Истина);
		НоменклатураМатериал = Справочники.Номенклатура.НайтиПоКоду("00000015918"); 
		//Проверка существующей сборки...
		Запрос = Новый Запрос;
		Запрос.Текст = 
		"ВЫБРАТЬ
		|	СборкаТоваров.Ссылка КАК Ссылка
		|ИЗ
		|	Документ.СборкаТоваров КАК СборкаТоваров
		|ГДЕ
		|	СборкаТоваров.ПометкаУдаления = Ложь
		|	И СборкаТоваров.idzak = &idzak";
		
		Запрос.УстановитьПараметр("idzak", idzak);
		РезультатЗапроса = Запрос.Выполнить().Выгрузить(); 
		
		Если РезультатЗапроса.Количество() = 0 тогда
			Если  Колво<>0 
				и Номенклатура <> Справочники.Номенклатура.ПустаяСсылка()
				и Ответственный <> Справочники.Пользователи.ПустаяСсылка()	тогда
				
				НовДок 							= Документы.СборкаТоваров.СоздатьДокумент();
				НовДок.Ответственный 			= Ответственный;
				НовДок.Организация 				= Справочники.Организации.НайтиПоНаименованию("КЗ"+" ""Эксперт"+"-Кабель""",Истина);    
				НовДок.ХозяйственнаяОперация 	= Перечисления.ХозяйственныеОперации.РазборкаТоваров;              
				НовДок.Склад 					= Склад;
				НовДок.Номенклатура				= НоменклатураМатериал;
				НовДок.КоличествоУпаковок 		= Колво;
				НовДок.Количество				= Колво;
				НовДок.Статус 					= Перечисления.СтатусыСборокТоваров.СобраноРазобрано;
				НовДок.Дата 					= Дата;
				НовДок.Подразделение 			= Справочники.СтруктураПредприятия.НайтиПоНаименованию("ЦПМ",истина);
				НовДок.СборкаПодДеятельность 	= Перечисления.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДС;
				НовДок.ВариантПриемкиТоваров 	= Перечисления.ВариантыПриемкиТоваров.РазделенаТолькоПоНакладным;	        
				НовДок.idzak 					= idzak;
				
				НовСтр 						= НовДок.Товары.Добавить();
				НовСтр.Номенклатура 		= Номенклатура;
				НовСтр.Упаковка 			= Справочники.УпаковкиЕдиницыИзмерения.НайтиПоНаименованию("кг");
				НовСтр.КоличествоУпаковок	= Колво;
				НовСтр.Количество			= Колво;
				НовДок.Записать(РежимЗаписиДокумента.Проведение);  
				Номер_и_дата_Сборки_разборки = Строка(НовДок.Номер)+" "+Строка(НовДок.Дата);
			КонецЕсли;			
		КонецЕсли;	          
		УстановитьПривилегированныйРежим(Ложь);  
	КонецЕсли;	                         
	Возврат Номер_и_дата_Сборки_разборки;
КонецФункции



</details>



      
