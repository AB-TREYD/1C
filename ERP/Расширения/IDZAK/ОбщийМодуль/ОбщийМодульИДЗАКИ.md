##  &НаСервере Функция СформироватьIDZAK(НомерЗаказа) Экспорт
<details> <summary> Код  </summary>
  	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	УчетIDZAKaza.IDZAKaza КАК IDZAKaza,
	|	УчетIDZAKaza.Период КАК Период,
	|	УчетIDZAKaza.Отправлен_в_EV КАК Отправлен_в_EV
	|ИЗ
	|	РегистрСведений.УчетIDZAKaza КАК УчетIDZAKaza
	|ГДЕ
	|	УчетIDZAKaza.IDZAKaza < 20000000000000000000
	|
	|УПОРЯДОЧИТЬ ПО
	|	УчетIDZAKaza.Период УБЫВ";
	
	Результат = Запрос.Выполнить().Выгрузить();        
	Если Результат.Количество() тогда
		ПорядковыйНомер = Прав(Строка(Формат(Результат[0].IDZAKaza+1,"ЧГ = 0")),6);   
	Иначе
		ПорядковыйНомер = "000000";
	КонецЕсли;               
	Год = Прав(Строка(Год(ТекущаяДата())),2);
	Резерв1 = "0"; //На данный момент просто бессмысленный символ
	Резерв2 = "0"; //На данный момент просто бессмысленный символ
	Признак = "1";
	IDZAKaza = Признак + Резерв1 + Резерв2 + Год + НомерЗаказа + "001" + ПорядковыйНомер;
	ТекДата = ТекущаяДатаСеанса();
	ТекДатаПлюс1 =  ТекДата+1;
	Пока не ТекДата >= ТекДатаПлюс1 цикл   
		ТекДата = ТекущаяДатаСеанса();
	КонецЦикла;                            
	НовЗапись = РегистрыСведений.УчетIDZAKaza.СоздатьМенеджерЗаписи();
	НовЗапись.IDZAKaza = Число(Формат(IDZAKaza,"ЧГ = 0"));
	НовЗапись.Период = ТекущаяДатаСеанса();
	
	НовЗапись.Записать();
	
	
	Возврат IDZAKaza;
	
	
	
	
	

</details>

## &НаСервере Процедура ДобавитьКолонкиВТаблицуОтправки(ТЗ) Экспорт
<details> <summary> Код  </summary>
  	ТЗ.Колонки.Добавить("Номенклатура"							); //0
	ТЗ.Колонки.Добавить("ПроцентРучнойСкидки"					); //1
	ТЗ.Колонки.Добавить("НомерСчетаВАнжелике"					); //2
	ТЗ.Колонки.Добавить("Количество"							); //3
	ТЗ.Колонки.Добавить("ДатаЗаказа"							); //4
	ТЗ.Колонки.Добавить("Комментарий"							); //5
	ТЗ.Колонки.Добавить("Примечание"							); //6
	ТЗ.Колонки.Добавить("Намотка"								); //7
	ТЗ.Колонки.Добавить("ЕдиницаИзмерения"						); //8
	ТЗ.Колонки.Добавить("Толеранс"								); //9
	ТЗ.Колонки.Добавить("ДатаВыпуска"							); //10
	ТЗ.Колонки.Добавить("ЧтоДелатьСЗаказом"						); //11
	ТЗ.Колонки.Добавить("КомментарийНеСтандартнойКонструкции"	); //12
	ТЗ.Колонки.Добавить("БулевоНеСтандартнойКонструкции"		); //13
	ТЗ.Колонки.Добавить("ВидКабеля"								); //14
	ТЗ.Колонки.Добавить("МаркаКабеля"							); //15
	ТЗ.Колонки.Добавить("КоличествоЖил"							); //16
	ТЗ.Колонки.Добавить("Сечение"								); //17
	ТЗ.Колонки.Добавить("Напряжение"							); //18
	ТЗ.Колонки.Добавить("Исполнение"							); //19
	ТЗ.Колонки.Добавить("ВидИсполнения"							); //20
	ТЗ.Колонки.Добавить("NPE"									); //21
	ТЗ.Колонки.Добавить("СечениеЭкрана"							); //22
	ТЗ.Колонки.Добавить("Цвет"									); //23
	ТЗ.Колонки.Добавить("ПлюсовойКабель"						); //24
	ТЗ.Колонки.Добавить("ИсполнениеПлюсовой"					); //25
	ТЗ.Колонки.Добавить("КоличествоЖилПлюсовой"					); //26
	ТЗ.Колонки.Добавить("СечениеЖилыПлюсовой"					); //27
	ТЗ.Колонки.Добавить("Менеджер"								); //28
	ТЗ.Колонки.Добавить("ПодТип"								); //29
	ТЗ.Колонки.Добавить("Контрагент"							); //30	
	ТЗ.Колонки.Добавить("IDZAKaza",								); //31	
	

</details>

## &НаСервере Процедура ОтправитьВ_EV(ТЗ,ИмяФайла) экспорт                                      
<details> <summary> Код  </summary>
  	УстановитьПривилегированныйРежим(Истина);	 
	База = "Danilova_test";
	ПутьКФайлу = "\\dataserv1c\IT-отдел\Obmen\erp_ev\order_list\file"+Формат(ТекущаяДата(),"ДФ=yyyy_MM_dd")+"_"+ИмяФайла+".xml";	
	Запись = Новый ЗаписьXML;  
	Запись.ОткрытьФайл(ПутьКФайлу, "UTF-8"); 
	Запись.ЗаписатьОбъявлениеXML();     
	Запись.ЗаписатьНачалоЭлемента("Список");
	
	Для каждого Позиция из ТЗ цикл       
		НазваниеСтроки = "IDZAKaza_" + Позиция.IDZAKAZA;  
		//Значение всегда тип СТРОКА
		Запись.ЗаписатьНачалоЭлемента(НазваниеСтроки);
		Индекс = ТЗ.Индекс(Позиция);	
		
		Для каждого Колонка из ТЗ.Колонки Цикл    	
			Запись.ЗаписатьАтрибут(Колонка.Имя, Строка(ТЗ[Индекс][Колонка.Имя]));
		КонецЦикла;	
		
		#Область Описание_атрибутов
		
		//Номенклатура							 //0
		//ПроцентРучнойСкидки					 //1
		//НомерСчетаВАнжелике					 //2
		//Количество							 //3
		//ДатаЗаказа							 //4
		//Комментарий							 //5
		//Примечание							 //6
		//Намотка								 //7
		//ЕдиницаИзмерения						 //8
		//Толеранс								 //9
		//ДатаВыпуска							 //10
		//ЧтоДелатьСЗаказом						 //11
		//КомментарийНеСтандартнойКонструкции	 //12
		//БулевоНеСтандартнойКонструкции		 //13
		//ВидКабеля								 //14
		//МаркаКабеля							 //15
		//КоличествоЖил							 //16
		//Сечение								 //17
		//Напряжение							 //18
		//Исполнение							 //19
		//ВидИсполнения							 //20
		//NPE									 //21
		//СечениеЭкрана							 //22
		//Цвет									 //23
		//ПлюсовойКабель						 //24
		//ИсполнениеПлюсовой					 //25
		//КоличествоЖилПлюсовой					 //26
		//СечениеЖилыПлюсовой					 //27
		//Менеджер								 //28
		//ПодТип								 //29
		//Контрагент							 //30			
		
		#КонецОбласти
		
		Запись.ЗаписатьКонецЭлемента();
	КонецЦикла;                         
	Запись.ЗаписатьКонецЭлемента();
	
	Запись.Закрыть(); 
	Соединение = Новый HTTPСоединение("1s-1", 80, "Администратор","22170");
	Текст = "/"+База+"/ru/hs/sozdanie_dokumentov_erp?a="+ПутьКФайлу;
	Запрос = Новый HTTPЗапрос(Текст);
	Результат = Соединение.Получить(Запрос);	 
	Если Результат.Заголовки.Получить("ev_result") = неопределено тогда
		Для каждого Позиция из ТЗ цикл    
			СнятьГалкуВРегистреИдзаков(Позиция.IDZAKaza);
		КонецЦикла;
	Иначе	
		ОбработатьОтветЕВ(Результат.Заголовки.Получить("ev_result"),ПутьКФайлу);
	КонецЕсли;
	УстановитьПривилегированныйРежим(Ложь);	 

</details>

##  &НаСервере Процедура ОбработатьОтветЕВ(СтрокаОтвет,ПутьКФайлу)
<details> <summary> Код  </summary>
  	ТЗ_Ответ = Новый ТаблицаЗначений;
	ТЗ_Ответ.Колонки.Добавить("IDZAKaza");
	ТЗ_Ответ.Колонки.Добавить("Отправлен_в_EV");
	Пока не СтрокаОтвет = "" цикл     
		НовСтр = ТЗ_Ответ.Добавить();
		НовСтр.IDZAKAZA = Лев(СтрокаОтвет,20);
		НовСтр.Отправлен_в_EV = СтрЗаменить(Лев(СтрокаОтвет,22),НовСтр.IDZAKAZA +"_","");
		СтрокаОтвет = Сред(СтрокаОтвет,23);
	КонецЦикла;
	ПоставитьГалкиВРегистреИдзаков(ТЗ_Ответ);
	УдаляемУдачноСозданныеДокументыИзФайла(ТЗ_Ответ,ПутьКФайлу);

</details>

## &НаСервере Процедура СнятьГалкуВРегистреИдзаков(IDZAKaza) Экспорт                

<details> <summary> Код  </summary>
           
          Запрос = Новый Запрос;
        	Запрос.УстановитьПараметр("IDZAKaza", Число(IDZAKaza));
        	Запрос.Текст = 
        	"ВЫБРАТЬ ПЕРВЫЕ 1
        	|	УчетIDZAK.IDZAKaza КАК IDZAKaza,
        	|	УчетIDZAK.Период КАК Период
        	|ИЗ
        	|	РегистрСведений.УчетIDZAK КАК УчетIDZAK
        	|ГДЕ
        	|	УчетIDZAK.IDZAKaza = &IDZAKaza";
        	РезультатЗапроса = Запрос.Выполнить().Выгрузить();
        	Если РезультатЗапроса.Количество() тогда
        		Запись = РегистрыСведений.УчетIDZAKaza.СоздатьМенеджерЗаписи();
        		Запись.IDZAKaza = РезультатЗапроса[0].IDZAKaza;
        		Запись.Период = РезультатЗапроса[0].Период;
        		Запись.Прочитать();
        		Запись.Отправлен_в_EV = Ложь;
        		Запись.Записать();
        	КонецЕсли;

</details>

## &НаСервере Процедура УдаляемУдачноСозданныеДокументыИзФайла(ТЗ,ПутьКФайлу)
<details> <summary> Код  </summary>
  
	Если не ПутьКФайлу = "" тогда
		СтарыйТекст = Новый ЧтениеТекста(ПутьКФайлу);
		Строки = СтарыйТекст.Прочитать();
		Для каждого Позиция из ТЗ цикл
			КолвоСтрок = СтрЧислоСтрок(Строки); //Первые две и последнюю не учитывать
			Если Позиция.Отправлен_в_EV = "y" тогда
				Если СтрНайти(Строки,Позиция.IDZAKAZA)>0 тогда
					Для НомерСтроки = 3 по КолвоСтрок-1 цикл
						СтрокаНаУдаление = СтрПолучитьСтроку(Строки,НомерСтроки);		
						Если СтрНайти(СтрокаНаУдаление,Позиция.IDZAKAZA)>0 тогда
							НомерСтроки = НомерСтроки-1;
							Строки = СтрЗаменить(Строки,СтрокаНаУдаление+Символы.ПС,"");	
							Прервать;
						КонецЕсли;
					КонецЦикла;
				Иначе
					//Что-то непонятное...
				КонецЕсли;		
			КонецЕсли;		
		КонецЦикла;     
		СтарыйТекст.Закрыть(); 
		Если СтрЧислоСтрок(Строки) = 3 тогда //Удаляем файл если остались только 3 строки
			УдалитьФайлы(ПутьКФайлу);		
		ИначеЕсли не Строки = "" тогда       //Если файл не удаляем тогда перезаписываем с ОСТАВШЕЙСЯ Строкой
			НовыйТекст = Новый ЗаписьТекста(ПутьКФайлу);
			НовыйТекст.Записать(Строки); 
			НовыйТекст.Закрыть();                   
		КонецЕсли;
	КонецЕсли;

</details>

## &НаСервере Процедура ПоставитьГалкиВРегистреИдзаков(ТЗ)
<details> <summary> Код  </summary>
  
  	Для каждого Заказ из ТЗ цикл
		
		Запрос = Новый Запрос;
		Запрос.УстановитьПараметр("IDZAKaza", Число(Заказ.IDZAKaza));
		Запрос.Текст = 
		"ВЫБРАТЬ ПЕРВЫЕ 1
		|	УчетIDZAK.IDZAKaza КАК IDZAKaza,
		|	УчетIDZAK.Период КАК Период
		|ИЗ
		|	РегистрСведений.УчетIDZAK КАК УчетIDZAK
		|ГДЕ
		|	УчетIDZAK.IDZAKaza = &IDZAKaza";
		РезультатЗапроса = Запрос.Выполнить().Выгрузить();
		Если РезультатЗапроса.Количество() тогда
			Запись = РегистрыСведений.УчетIDZAKaza.СоздатьМенеджерЗаписи();
			Запись.IDZAKaza = РезультатЗапроса[0].IDZAKaza;
			Запись.Период = РезультатЗапроса[0].Период;
			Запись.Прочитать();
			Запись.Отправлен_в_EV = ?(Заказ.Отправлен_в_EV = "y",Истина,Ложь);
			Запись.Записать();
		КонецЕсли;
		
	КонецЦикла;

</details>

## &НаСервере Функция ПолучитьПараметрыКабеля(Номенклатура)  Экспорт
<details> <summary> Код  </summary>
  	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	Номенклатура.Ссылка КАК Ссылка,
	|	Номенклатура.Гн_ВидКабеля.Наименование 				КАК ВидКабеля,
	|	Номенклатура.Гн_МаркаКабеля.Наименование 			КАК МаркаКабеля,
	|	Номенклатура.Гн_КоличествоЖил.КоличествоЖил 		КАК КоличествоЖил,
	|	Номенклатура.Гн_СечениеЖилы.Сечение 				КАК Сечение,
	|	Номенклатура.Гн_Напряжение.Напряжение 				КАК Напряжение,
	|	Номенклатура.Гн_Исполнение.Наименование 			КАК Исполнение,
	|	Номенклатура.Гн_ВидИсполнения.Наименование 			КАК ВидИсполнения,
	|	Номенклатура.Гн_NPE.Наименование 					КАК NPE,
	|	Номенклатура.Гн_СечениеЭкрана.Сечение 				КАК СечениеЭкрана,
	|	Номенклатура.Гн_Цвет.Наименование 					КАК Цвет,
	|   Номенклатура.Гн_ПлюсовойКабель 						КАК ПлюсовойКабель,
	|	Номенклатура.Гн_ИсполнениеПлюсовой.Наименование 	КАК ИсполнениеПлюсовой,
	|	Номенклатура.Гн_КоличествоЖилПлюсовой.КоличествоЖил КАК КоличествоЖилПлюсовой,
	|	Номенклатура.Гн_СечениеЖилыПлюсовой.Сечение 		КАК СечениеЖилыПлюсовой,
	|	Номенклатура.Гн_ДопТипКабеля.Наименование 			КАК ПодТип
	|ИЗ
	|	Справочник.Номенклатура КАК Номенклатура
	|ГДЕ
	|	Номенклатура.Ссылка = &Номенклатура";
	
	Запрос.УстановитьПараметр("Номенклатура", Номенклатура);
	
	Результат = Запрос.Выполнить().Выгрузить();
	Если Результат.Количество()>0 тогда
		Возврат Результат[0];	
	Иначе 
		Возврат Неопределено;
	КонецЕсли; 
	

</details>

## &НаСервере Функция ПрограммистЛиТекущийПользователь() Экспорт
<details> <summary> Код  </summary>
  	
	Возврат Строка(Пользователи.ТекущийПользователь()) = "Admin" 
	или Строка(Пользователи.ТекущийПользователь()) = "Ставцев И.Ю."
	или Строка(Пользователи.ТекущийПользователь()) = "Яковлев А.С.";
	

</details>     

## &НаСервере Функция ПроверитьЗаписьВРегистреИдзаков(IDZAKAZA) Экспорт
<details> <summary> Код  </summary>
  Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("IDZAKaza", IDZAKAZA);
	Запрос.Текст = 
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	IDZAKи.Отправлен_в_EV КАК Отправлен_в_EV,
	|	IDZAKи.IDZAKaza КАК IDZAKaza
	|ИЗ
	|	РегистрСведений.УчетIDZAK КАК IDZAKи
	|ГДЕ
	|	IDZAKи.IDZAKaza = &IDZAKaza";
	Результат = Запрос.Выполнить().Выгрузить();
	Результат = ?(Результат.Количество()>0,Результат[0].Отправлен_в_EV,Ложь);
	//если записи есть тогда возвращаем значение записи, если нет тогда ложь
	Возврат Результат

</details>

## &НаСервере Функция ПроверкаНоменклатурыТчНаСовпадениеССервером(IDZAKaza,Номенклатура)Экспорт
<details> <summary> Код  </summary>	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("IDZAKaza", IDZAKaza);
	Запрос.УстановитьПараметр("Номенклатура", Номенклатура);
	Запрос.Текст = 
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	Продукция.Номенклатура КАК Номенклатура
	|ИЗ
	|	Документ.ЗаказНаПроизводство2_2.Продукция КАК Продукция
	|ГДЕ
	|	Продукция.IDZAKaza = &IDZAKaza
	|	И Продукция.Номенклатура = &Номенклатура
	|	И Продукция.Ссылка.ПометкаУдаления = ЛОЖЬ";
	Результат = Запрос.Выполнить().Выгрузить().Количество();
	Возврат ?(Результат=0,Истина,Ложь);	

</details>

## &НаСервере Функция ПолучитьНужныйНамЗНП(IDZAKaza) Экспорт
	 
  <details> <summary> Код  </summary>
    
 Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	Продукция.Ссылка.Ссылка КАК Ссылка
	|ИЗ
	|	Документ.ЗаказНаПроизводство2_2.Продукция КАК Продукция
	|ГДЕ
	|	Продукция.IDZAKaza = &IDZAKaza
	|	И Продукция.Ссылка.ПометкаУдаления = ЛОЖЬ 
	|
	|УПОРЯДОЧИТЬ ПО
	|	Продукция.Ссылка.Дата УБЫВ";
	Запрос.УстановитьПараметр("IDZAKaza", IDZAKaza);
	Возврат Запрос.Выполнить().Выгрузить();

</details>

## &НаСервере Функция ПолучитьНужныйНамПБЗ(IDZAKaza) Экспорт  
<details> <summary> Код  </summary>
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	ВыходныеИзделия.Ссылка.Ссылка КАК Ссылка
	|ИЗ
	|	Документ.ПроизводствоБезЗаказа.ВыходныеИзделия КАК ВыходныеИзделия
	|ГДЕ
	|	ВыходныеИзделия.IDZAKaza = &IDZAKaza
	|	И ВыходныеИзделия.Ссылка.ПометкаУдаления = ЛОЖЬ
	|
	|УПОРЯДОЧИТЬ ПО
	|	ВыходныеИзделия.Ссылка.Дата УБЫВ";
	Запрос.УстановитьПараметр("IDZAKaza", IDZAKaza);
	Возврат Запрос.Выполнить().Выгрузить();

</details>

 
