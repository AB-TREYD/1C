
## &После("ПередЗаписью") Процедура IDZAK_ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)

<details> <summary> Код  </summary>

	Если ОтключитьОтEV = Ложь тогда  
		Если ЭтотОбъект.Перезаполнение_из_хттп_Сервиса тогда ЭтотОбъект.Перезаполнение_из_хттп_Сервиса = ложь;
		Иначе
			Если ЭтоНовый() = ложь тогда
				Для каждого ВыходноеИзделие из ЭтотОбъект.ВыходныеИзделия цикл
					Если РаботаСоСпецификацией.УсловияДляСозданияПБЗСпецификации(ВыходноеИзделие.Номенклатура,ЭтотОбъект.Подразделение) тогда 	
						ВыходноеИзделие.IDZAKaza =  ?(ВыходноеИзделие.IDZAKaza = 0, ОбщийМодульИДЗАКИ.СформироватьIDZAK(Прав(СокрЛП(ЭтотОбъект.Номер),6)),ВыходноеИзделие.IDZAKaza);	
						Если ВыходноеИзделие.IDZAKaza>0 и ВыходноеИзделие.IDZAKaza< 2*pow(10,19) тогда	
							
							//ЕСЛИ  Сменилась номенклатура тогда отправляем!
							ПересоздатьЗаказЕВ = ПроверкаНоменклатурыТчНаСовпадениеССервером(ВыходноеИзделие.IDZAKaza,ВыходноеИзделие.Номенклатура); 
							//Если Номенклатура изменилась ИЛИ Отходы!
							Если ПересоздатьЗаказЕВ или (ВыходноеИзделие.Номенклатура.Гн_ВидКабеля.Наименование = "Отходы" и ЭтотОбъект.МатериалыИРаботы.Количество() = 0)тогда  
								//новая номенклатура = пустая СТАРАЯ спецификация с новой номенклатурой)
								ЭтотОбъект.МатериалыИРаботы.Очистить();
								ОбщийМодульИДЗАКИ.СнятьГалкуВРегистреИдзаков(ВыходноеИзделие.IDZAKaza); //Снятая галка = заказ будет переотправлен
								РаботаСоСпецификацией.ОпустошитьСпецификацию(ВыходноеИзделие.Номенклатура, ВыходноеИзделие.IDZAKaza); 
							КонецЕсли;				
							Если ОбщийМодульИДЗАКИ.ПроверитьЗаписьВРегистреИдзаков(ВыходноеИзделие.IDZAKAZA) = ложь и ВыходноеИзделие.КоличествоУпаковок > 0 тогда
								Подготовка_и_Отправка_В_EV(ВыходноеИзделие);	
								
								
								
								
								Если РаботаСоСпецификацией.НайтиНужнуюСпецификацию(ВыходноеИзделие.IDZAKaza) = Справочники.РесурсныеСпецификации.ПустаяСсылка() тогда									
									РаботаСоСпецификацией.СоздатьПустуюСпецификацию(ВыходноеИзделие.Номенклатура, ВыходноеИзделие.IDZAKaza, ЭтотОбъект.Дата);  			
								КонецЕсли;                                                                
								Если ТаблицыСпецификацииПустые(ВыходноеИзделие.IDZAKAZA) тогда									
									ЗаполнитьПустуюСпецификацию();
									ВыходноеИзделие.Спецификация = РаботаСоСпецификацией.НайтиНужнуюСпецификацию(ВыходноеИзделие.IDZAKaza);	 													
								КонецЕсли; 
								Если ИзменилсяЛиСклад() = ложь тогда //Склад не изменился
									//Вносим нашу спецуху в поле + запрашиваем из ЕВ актуальную спецуху + заполняем ТЧ Материалы и Работы
									Если ВыходноеИзделие.Номенклатура.Гн_ВидКабеля.Наименование = "Отходы" 
										или стрНайти(нрег(ВыходноеИзделие.Номенклатура.Наименование),"жгут") тогда   
										//На этот момент спецуха УЖЕ должна быть записана в файлик
										РаботаСоСпецификацией.ДополнитьПоСпецификацииДляПБЗ(ЭтотОбъект) 
									КонецЕсли;  
								КонецЕсли;  
							КонецЕсли;	             
						КонецЕсли;								
					КонецЕсли;	
					Если РежимЗаписи = РежимЗаписиДокумента.Проведение и ВыходноеИзделие.Номенклатура.Наименование = "Дробленый ПВХ" тогда
						//нужна проверка на создание                          
						Текст = АвтоСозданиеСборкиДробленка_новая(ВыходноеИзделие.Номенклатура,ЭтотОбъект.Ответственный,ВыходноеИзделие.КоличествоУпаковок,ВыходноеИзделие.idzakaza);
						Сообщить(Текст);			
					Иначе	
						Текст = СообщитьОСуществующейСборкеРазборке(ВыходноеИзделие.IDZAKaza);  
						Если Текст = "" тогда иначе Сообщить(Текст) КонецЕсли;
					КонецЕсли;  
					
				КонецЦикла   
			КонецЕсли;  
		КонецЕсли;  
	КонецЕсли;			

</details>       

## Функция ТаблицыСпецификацииПустые(IDZAKAZA)
<details> <summary> Код  </summary>
	
 Возврат	РаботаСоСпецификацией.НайтиНужнуюСпецификацию(IDZAKaza)["МатериалыИУслуги"].Количество() = 0 или РаботаСоСпецификацией.НайтиНужнуюСпецификацию(IDZAKaza)["ВсеВОдномМатериалыИУслугиExpertClass"].Количество() = 0;	

</details>	

## Процедура ЗаполнитьПустуюСпецификацию()   

<details> <summary> Код  </summary>
   
   
      РБС = РаботаСоСпецификацией;
      	Структ = РБС.ОбработатьФайлик_new_spec(РБС.ФормированиеТЗ_new_spec(),1);
      	РБС.ЗаполнитьСпецификацию(Структ.ТЗ,Структ.IDZAKAZA,Структ.Признак);		
      	
      	Структ = РБС.ОбработатьФайлик_new_spec(РБС.ФормированиеТЗ_new_spec(),2);
      	Если Структ.Признак = "Эталон" тогда Структ.ТЗ.Колонки.КоличествоУпаковок.Имя = "ЭталонныйНорматив" КонецЕсли;      	
      	РБС.ЗаполнитьСпецификацию(Структ.ТЗ,Структ.IDZAKAZA,Структ.Признак);		
	
</details>

## Функция ИзменилсяЛиСклад()
<details> <summary> Код  </summary>

       Ответ = Ложь;                                   
    	ТЧ  = ЭтотОбъект.МатериалыИРаботы;            
    	ТЧС = ЭтотОбъект.Ссылка.МатериалыИРаботы;
    	Если ТЧ.Количество() = 0 тогда
    		Ответ = Ложь;
    	ИначеЕсли ТЧ.Количество() <> ТЧС.Количество()  тогда
    		Ответ = Истина;      
    	Иначе
    		Для ИН = 0 по ТЧС.Количество()-1 цикл
    			Если ТЧ[ИН].Склад <> ТЧС[ИН].Склад тогда 
    				Ответ = Истина;
    				Прервать;
    			КонецЕсли;
    		КонецЦикла;
    	КонецЕсли;		
    	Возврат Ответ;

</details>

## Функция ПроверкаНоменклатурыТчНаСовпадениеССервером(IDZAKaza,Номенклатура)
<details> <summary> Код  </summary>
	
    	Запрос = Новый Запрос;
    	Запрос.УстановитьПараметр("IDZAKaza", IDZAKaza);
    	Запрос.УстановитьПараметр("Номенклатура", Номенклатура);
    	Запрос.Текст = 
    	"ВЫБРАТЬ ПЕРВЫЕ 1
    	|	Продукция.Номенклатура КАК Номенклатура
    	|ИЗ
    	|	Документ.ПроизводствоБезЗаказа.ВыходныеИзделия КАК Продукция
    	|ГДЕ
    	|	Продукция.IDZAKaza = &IDZAKaza
    	|	И Продукция.Номенклатура = &Номенклатура
    	|	И Продукция.Ссылка.ПометкаУдаления = ЛОЖЬ";
    	Результат = Запрос.Выполнить().Выгрузить().Количество();
    	Возврат ?(Результат=0,Истина,Ложь);	

</details>

## Процедура Подготовка_и_Отправка_В_EV(ВыходноеИзделие)          

<details> <summary> Код  </summary>

  	//Отправляем если
  	//
  	//
  	//
  	//
  	ТЗ_Отправка = Новый ТаблицаЗначений;	         
  	ОбщийМодульИДЗАКИ.ДобавитьКолонкиВТаблицуОтправки(ТЗ_Отправка);
  	Структ = Новый Структура;       //Структ параметров ИЗ НАШЕГО ТЕКУЩЕГО ОБЪЕКТА!
  	Структ.Вставить("Комментарий",	"");
  	Структ.Вставить("ДатаЗаказа",	ЭтотОбъект.Дата);
  	Структ.Вставить("НомерБЗ",		СтрЗаменить(СокрЛП(ЭтотОбъект.Номер),Сред(СокрЛП(ЭтотОбъект.Номер),СтрНайти(СокрЛП(ЭтотОбъект.Номер),"--"),4),"--БЗ"));
  	Структ.Вставить("Контрагент",	"");
  	Структ.Вставить("ЧтоДелатьСЗаказом",	"ПересоздатьЗаказЕВ");
  	Структ.Вставить("Менеджер",		СокрЛП(ЭтотОбъект.Ответственный));
  	ДобавитьСтрокуВТаблицуОтправки(ТЗ_Отправка,ВыходноеИзделие,Структ); 
  	ОбщийМодульИДЗАКИ.ОтправитьВ_EV(ТЗ_Отправка,Структ.НомерБЗ);	
  	

</details>    

## Процедура ДобавитьСтрокуВТаблицуОтправки(ТЗ,Продукц,Структ)
<details> <summary> Код  </summary>

    	НовСтр = ТЗ.Добавить();         
    	ЗаполнитьЗначенияСвойств(НовСтр,Структ);
    	ЗаполнитьЗначенияСвойств(НовСтр,Продукц);  
    	
    	НовСтр.ПроцентРучнойСкидки				    = "";
    	НовСтр.НомерСчетаВАнжелике					= Структ.НомерБЗ+"/"+Продукц.НомерСтроки;
    	НовСтр.ЕдиницаИзмерения						= Продукц.Номенклатура.ЕдиницаИзмерения;
    	НовСтр.Толеранс								= "";
    	НовСтр.ЧтоДелатьСЗаказом 					= Структ.ЧтоДелатьСЗаказом;
    	НовСтр.Контрагент   						= Структ.Контрагент;
    	НовСтр.IDZAKaza 							= Формат(Продукц.IDZAKAZA,"ЧГ=0");
    	НовСтр.БулевоНестандартнойКонструкции = Строка(Ложь);
    	
    	
    	ПараметрыКабеля = ОбщийМодульИДЗАКИ.ПолучитьПараметрыКабеля(Продукц.Номенклатура);
    	ЗаполнитьЗначенияСвойств(НовСтр,ПараметрыКабеля);
    	
    	

</details>  

//ПБЗ ФормаДокумента
//Вызывается в ВсеВОдномПередЗаписьюПосле(Отказ, ПараметрыЗаписи)


## Функция АвтоСозданиеСборкиДробленка_Новая(Номенклатура,Ответственный,Колво,IDZAKAZA) Экспорт      
<details> <summary> Код  </summary>
   
    	Если не IDZAKAZA = 0 тогда
    		//необходимо в Документы.сборкаТовара создать реквизит IDZAKaza 15длина строка
    		УстановитьПривилегированныйРежим(Истина);
    		ТекстОшибки = "";      
    		НоменклатураЗаполнение = Справочники.Номенклатура.НайтиПоКоду("1--00041415"); 
    		//Проверка существующей сборки...
    		Запрос = Новый Запрос;
    		Запрос.Текст = 
    		"ВЫБРАТЬ
    		|	СборкаТоваров.Ссылка КАК Ссылка
    		|ИЗ
    		|	Документ.СборкаТоваров КАК СборкаТоваров
    		|ГДЕ
    		|	СборкаТоваров.ПометкаУдаления = Ложь
    		|	И СборкаТоваров.IDZAKAZA = &IDZAKAZA";
    		
    		Запрос.УстановитьПараметр("IDZAKAZA", IDZAKAZA);
    		РезультатЗапроса = Запрос.Выполнить().Выгрузить(); 
    		
    		Если РезультатЗапроса.Количество() = 0 тогда
    			Если  Колво<>0 
    				и Номенклатура = Справочники.Номенклатура.НайтиПоНаименованию("Дробленый ПВХ",истина) 
    				и Ответственный <> Справочники.Пользователи.ПустаяСсылка()	тогда
    				
    				НовДок = Документы.СборкаТоваров.СоздатьДокумент();
    				НовДок.Ответственный = Ответственный;
    				НовДок.Организация = Справочники.Организации.НайтиПоНаименованию("КЗ"+" ""Эксперт"+"-Кабель""",Истина);    
    				НовДок.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.СборкаТоваров;              
    				НовДок.Склад = Справочники.Склады.НайтиПоНаименованию("Склад НЗП ЦКПП",истина);
    				НовДок.Номенклатура = НоменклатураЗаполнение;
    				НовДок.КоличествоУпаковок = Колво;
    				НовДок.Количество= Колво;
    				НовДок.Статус = Перечисления.СтатусыСборокТоваров.СобраноРазобрано;
    				НовДок.Дата = ЭтотОбъект.Дата;
    				НовДок.Подразделение = Справочники.СтруктураПредприятия.НайтиПоНаименованию("ЦКПП",истина);
    				НовДок.СборкаПодДеятельность = Перечисления.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДС;
    				НовДок.ВариантПриемкиТоваров = Перечисления.ВариантыПриемкиТоваров.РазделенаТолькоПоНакладным;	        
    				НовДок.IDZAKAZA = IDZAKAZA;
    				
    				НовСтр = НовДок.Товары.Добавить();
    				НовСтр.Номенклатура = Номенклатура;
    				НовСтр.Упаковка 	= Справочники.УпаковкиЕдиницыИзмерения.НайтиПоНаименованию("кг");
    				НовСтр.КоличествоУпаковок = Колво;
    				НовСтр.Количество= Колво;
    				НовДок.Записать(РежимЗаписиДокумента.Проведение);
    				ТекстОшибки = ("При проведении была создана Сборка товара ""Заполнение"" из ""Дробленый ПВХ"". Номер документа: "+НовДок.Номер);
    			Иначе               
    				Если Номенклатура = Справочники.Номенклатура.НайтиПоНаименованию("Дробленый ПВХ",истина) тогда
    					Если Колво = 0 тогда ТекстОшибки = ТекстОшибки + "Не указано количество" + Символы.ПС КонецЕсли;
    					Если Ответственный = Справочники.Пользователи.ПустаяСсылка() тогда ТекстОшибки = текстОшибки + "Ответственный за документ не указан" + Символы.ПС КонецЕсли;           
    				КонецЕсли;	
    			КонецЕсли;	  
    		Иначе            
    			Номера = "";
    			Для каждого Стр из РезультатЗапроса цикл
    				Номера = Номера + Стр.Ссылка.Номер + " ";
    			КонецЦикла;
    			ТекстОшибки = ("Для этого документа есть Сборка товара ""Заполнение"" из ""Дробленый ПВХ"". Номера документов: " + Номера);				
    		КонецЕсли;	          
    		//УстановитьПривилегированныйРежим(Ложь);  
    	КонецЕсли;	        
    	УстановитьПривилегированныйРежим(Ложь);
    	Возврат ТекстОшибки;

</details>

## Функция СообщитьОСуществующейСборкеРазборке(IDZAKAZA)

<details> <summary> Код  </summary>

      	Текст = "";
      	Если не IDZAKAZA = 0 тогда
      
      		УстановитьПривилегированныйРежим(Истина);
      		//Проверка существующей сборки...
      		Запрос = Новый Запрос;
      		Запрос.Текст = 
      		"ВЫБРАТЬ
      		|	СборкаТоваров.Ссылка КАК Ссылка
      		|ИЗ
      		|	Документ.СборкаТоваров КАК СборкаТоваров
      		|ГДЕ
      		|	СборкаТоваров.ПометкаУдаления = Ложь
      		|	И СборкаТоваров.IDZAKAZA = &IDZAKAZA";
      		Запрос.УстановитьПараметр("IDZAKAZA", IDZAKAZA);
      		РезультатЗапроса = Запрос.Выполнить().Выгрузить();  
      		Если РезультатЗапроса.Количество()>0 тогда
      			Номера = "";
      			Для каждого Стр из РезультатЗапроса цикл
      				Номера = Номера + Стр.Ссылка.Номер + " ";
      			КонецЦикла;
      			Текст =("Для этого документа есть Сборка товара. Номера документов: " + Номера);				
      		КонецЕсли;	    	
      		УстановитьПривилегированныйРежим(Ложь);
      	КонецЕсли; 
      	Возврат Текст;


</details>

## &После("ПриКопировании") Процедура IDZAK_ПриКопировании(ОбъектКопирования)       

<details> <summary> Код  </summary>
      
      	Для каждого стр из ЭтотОбъект.ВыходныеИзделия Цикл 
      		Стр.IDZAKaza = 0;		
      	КонецЦикла; 
      	ЭтотОбъект.МатериалыИРаботы.Очистить();
 </details>


