## 
 <details> <summary> Код  </summary> 

 </details>

 
## &После("ПередЗаписью") Процедура IDZAK_ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
 <details> <summary> Код  </summary> 

	Если ЭтотОбъект.ОтключитьОтEV = ложь тогда 
		//Вот эта вся суета запускает создание и отправку!!!!!!!      
		
		
				
		Если не(ЭтотОбъект.Ссылка.ПометкаУдаления = ложь и ЭтотОбъект.ПометкаУдаления = истина )тогда      
			Для каждого Продукц из ЭтотОбъект.Продукция цикл      					 
				Отказ = ПроверитьСуществованиеЗаказовСТакимИдзаказа(Продукц.IDZAKaza,ЭтотОбъект.Ссылка);  
				Если Отказ тогда 
					Сообщить(" ""Заказ на производство"" на текущий ""Заказ клиента"" с такими же позициями продукции уже существует!");
					Прервать;
				КонецЕсли;
			КонецЦикла;
			Если Отказ = ложь тогда
				Если ЭтоНовый() тогда //Первая запись заказа на производство
					//Создаем ПУСТУЮ спецификацию для всех у кого есть идзак(а он должен быть у всех нужных нам)     
					Для каждого Продукц из ЭтотОбъект.Продукция цикл		
						Если Продукц.IDZAKaza>0 и Продукц.IDZAKaza< 2*pow(10,19) и не ЭтотОбъект.Подразделение.Наименование= "ЦПМ" тогда
							РаботаСоСпецификацией.СоздатьПустуюСпецификацию(Продукц.Номенклатура, Продукц.IDZAKaza,ЭтотОбъект.Дата);  
						КонецЕсли;
					КонецЦикла;
				КонецЕсли;  
				
				Если РежимЗаписи = РежимЗаписиДокумента.Проведение тогда //Если проведение то пытаемся отправить
					Проверка_и_Отправка_В_EV();	
				КонецЕсли;   
				
				Для каждого Продукц из ЭтотОбъект.Продукция цикл 
					Если не ЭтотОбъект.Подразделение.Наименование= "ЦПМ" тогда
						//////////////////+Проверка наличия спецификации////////////////////////////
						//Есть наша спецификация или нет - пофик, ищем нашу, иначе вставляем пустую
						Если Продукц.IDZAKaza>0 тогда
							Продукц.Спецификация = РаботаСоСпецификацией.НайтиНужнуюСпецификацию(Продукц.IDZAKAZA); 		
							Если Продукц.Спецификация.IDZAKAZA = Продукц.IDZAKaza и
								(Продукц.Спецификация["МатериалыИУслуги"].Количество() = 0 
								или Продукц.Спецификация["ВсеВОдномМатериалыИУслугиExpertClass"].Количество() = 0) тогда
								Продукц.Спецификация = Справочники.РесурсныеСпецификации.ПустаяСсылка();
								ЭтотОбъект.НаличиеСпецификации = Ложь;			
							КонецЕсли;        
						КонецЕсли;
						//////////////////-Проверка наличия спецификации////////////////////////////
					КонецЕсли;
				КонецЦикла;
			КонецЕсли;
		Иначе
			//Если пометка на удаление поставилась тогда летим в ЕВ и помечаем на удаление заказы
			ПометитьНаУдалениеЗаказыВ_ЕВ();
		КонецЕсли;       
		
		
	КонецЕсли;
	
	
	
 </details>


## Функция ПроверитьСуществованиеЗаказовСТакимИдзаказа(IDZAKAZA,Ссылка)
 <details> <summary> Код  </summary> 

	Если IDZAKAZA = 0 тогда Возврат Ложь КонецЕсли; 
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	Продукция.Ссылка.Ссылка КАК Ссылка
		|ИЗ
		|	Документ.ЗаказНаПроизводство2_2.Продукция КАК Продукция
		|ГДЕ
		|	Продукция.IDZAKaza = &IDZAKaza 
		|	И Продукция.Ссылка <> &Ссылка
		|	И Продукция.Ссылка.ПометкаУдаления = Ложь";
	
	Запрос.УстановитьПараметр("Idzakaza", Idzakaza);
	Запрос.УстановитьПараметр("Ссылка", Ссылка);
	
	РезультатЗапроса = Запрос.Выполнить().Выгрузить();
	Возврат РезультатЗапроса.Количество()>0;
 </details>



## Процедура Проверка_и_Отправка_В_EV()  

 <details> <summary> Код  </summary> 

   
   
   //В процедуре смотрим Менялось кол-во/номенкл и нужно или не нужно отправлять 
	//НЕ НУЖНО ОТПРАВЛЯТЬ ЕСЛИ В РЕГИСТРЕ ИДЗАКОВ ЛОЖЬ
	ТЗ_Отправка = Новый ТаблицаЗначений; 
	ОбщийМодульИДЗАКИ.ДобавитьКолонкиВТаблицуОтправки(ТЗ_Отправка); //набиваем колонки в ТЗ(по старому шаблону  до марта 2024г)
	Для каждого Продукц из ЭтотОбъект.Продукция цикл
		Если Продукц.IDZAKaza>0 и Продукц.IDZAKaza< 2*pow(10,19) 
			и Продукц.Статус <> Перечисления.СтатусыВПроизводстве.ПустаяСсылка() тогда
			//////////////////+Формируем структуру доп.параметров///////////////////////
			Структ = Новый Структура;       //Структ параметров ИЗ НАШЕГО ТЕКУЩЕГО ОБЪЕКТА!
			Структ.Вставить("Комментарий",	ЭтотОбъект.Комментарий);
			Структ.Вставить("ДатаЗаказа",	ЭтотОбъект.ДатаПотребности);
			Структ.Вставить("НомерЗК",		СокрЛП(ЭтотОбъект.ДокументОснование.Номер));
			Структ.Вставить("Контрагент",	СокрЛП(ЭтотОбъект.ДокументОснование.Контрагент.Наименование));
			Структ.Вставить("Менеджер",		СокрЛП(ЭтотОбъект.Ответственный));
			Структ.Вставить("ЧтоДелатьСЗаказом","");
			//////////////////-Формируем структуру доп.параметров///////////////////////
			//////////////////+Проверка изменений///////////////////////////////////////			
			//Если статус УЖЕ ДО ЗАПИСИ был в графике ИНАЧЕ это ПЕРВЫЙ вграфик для нашей позиции
			Если ПолучитьСтатусПродукцииНаСервере(Продукц.IDZAKaza) = Перечисления.СтатусыВПроизводстве.ВГрафике 
				или ПолучитьСтатусПродукцииНаСервере(Продукц.IDZAKaza) = Перечисления.СтатусыВПроизводстве.ВПроизводстве тогда
				//Проверка номенклатуры		
				ПересоздатьЗаказЕВ = ПроверкаНоменклатурыТчНаСовпадениеССервером(Продукц.IDZAKaza,Продукц.Номенклатура);
				Если ПересоздатьЗаказЕВ тогда
					ОбщийМодульИДЗАКИ.СнятьГалкуВРегистреИдзаков(Продукц.IDZAKaza); //Снятая галка = заказ будет переотправлен
					РаботаСоСпецификацией.ОпустошитьСпецификацию(Продукц.Номенклатура, Продукц.IDZAKaza); 
					//новая номенклатура = пустая СТАРАЯ спецификация с новой номенклатурой)
					Структ.ЧтоДелатьСЗаказом = "ПересоздатьЗаказЕВ";
				ИначеЕсли Продукц.Статус = Перечисления.СтатусыВПроизводстве.ВГрафике 
					или Продукц.Статус = Перечисления.СтатусыВПроизводстве.ВПроизводстве тогда
					//Если изменилась номенклатура то мы всё равно пересоздаем заказ с новым количеством... поэтому мы в ИНАЧЕ
					//Проверка количества  
					ПерезаполнитьЗаказЕВ = ПроверкаКоличестваТчНаСовпадениеССервером(Продукц.IDZAKaza,Продукц.Скидка,Продукц.КоличествоУпаковок,ЭтотОбъект.Комментарий);					
					//В EV будем перевписывать новый коэф конвертации и кол-во по заказу
					Если ПерезаполнитьЗаказЕВ тогда 
						Структ.ЧтоДелатьСЗаказом = "ПерезаполнитьЗаказЕВ";
						ОбщийМодульИДЗАКИ.СнятьГалкуВРегистреИдзаков(Продукц.IDZAKaza); //Снятая галка = заказ будет переотправлен
					КонецЕсли;  					
				КонецЕсли;        					
			КонецЕсли;                                     			
			//////////////////-Проверка изменений///////////////////////////////////////						
			////////////////////////////////////////////////////////////////////////////			
			//////////////////+Заполнение тз для отправки///////////////////////////////			
			//Проверочка на ЛОЖЬ в регистре идзаков, если ложь то суем в тз отправки
			Если  ОбщийМодульИДЗАКИ.ПроверитьЗаписьВРегистреИдзаков(Продукц.IDZAKaza) = ложь тогда 
				ДобавитьСтрокуВТаблицуОтправки(ТЗ_Отправка,Продукц,Структ);	
			КонецЕсли;	
			//////////////////-Заполнение тз для отправки///////////////////////////////
			////////////////////////////////////////////////////////////////////////////
		КонецЕсли;    
	КонецЦикла;    
	//////////////////////////+Отправка/////////////////////////////////////////////////
	Если ТЗ_Отправка.Количество() тогда    //непосредственно отправка. НУЖНО ДОПИСАТЬ НАСТРОЙКИ БАЗЫ И ФАЙЛА!!!
		ОбщийМодульИДЗАКИ.ОтправитьВ_EV(ТЗ_Отправка,СокрЛП(ЭтотОбъект.ДокументОснование.Номер));	
	КонецЕсли;
	//////////////////////////-Отправка/////////////////////////////////////////////////
 </details>
  

## #Область Проверки
 <details> <summary> Код  </summary> 

   
## Функция ПроверкаНоменклатурыТчНаСовпадениеССервером(IDZAKaza,Номенклатура)
 <details> <summary> Код  </summary> 

	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("IDZAKaza", IDZAKaza);
	Запрос.УстановитьПараметр("Номенклатура", Номенклатура);
	Запрос.Текст = 
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	Продукция.Номенклатура КАК Номенклатура
	|ИЗ
	|	Документ.ЗаказНаПроизводство2_2.Продукция КАК Продукция
	|ГДЕ
	|	Продукция.IDZAKaza = &IDZAKaza
	|	И Продукция.Номенклатура = &Номенклатура
	|	И Продукция.Ссылка.ПометкаУдаления = ЛОЖЬ";
	Результат = Запрос.Выполнить().Выгрузить().Количество();
	Возврат ?(Результат=0,Истина,Ложь);	
 </details>

## Функция ПроверкаКоличестваТчНаСовпадениеССервером(IDZAKaza,Скидка,КоличествоУпаковок,Комментарий)
 <details> <summary> Код  </summary> 

	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("IDZAKaza", IDZAKaza);
	Запрос.УстановитьПараметр("Скидка", Скидка);
	Запрос.УстановитьПараметр("КоличествоУпаковок", КоличествоУпаковок);
	Запрос.УстановитьПараметр("Комментарий", Комментарий);
	Запрос.Текст = 
	"ВЫБРАТЬ Первые 1
	|	Продукция.Номенклатура КАК Номенклатура
	|ИЗ
	|	Документ.ЗаказНаПроизводство2_2.Продукция КАК Продукция
	|ГДЕ
	|	Продукция.IDZAKaza = &IDZAKaza
	|	И Продукция.Скидка = &Скидка
	|	И Продукция.Ссылка.ПометкаУдаления = ЛОЖЬ
	|	И Продукция.КоличествоУпаковок = &КоличествоУпаковок
	|	И Продукция.Ссылка.Комментарий ПОДОБНО &Комментарий";
	
	Результат = Запрос.Выполнить().Выгрузить().Количество();
	Возврат ?(Результат=0,Истина,Ложь);
	
 </details>



 </details>
 
## #Область Подготовка_параметров
 <details> <summary> Код  </summary> 

## Процедура ДобавитьСтрокуВТаблицуОтправки(ТЗ,Продукц,Структ)
 <details> <summary> Код  </summary> 
	
	НовСтр = ТЗ.Добавить();         
	ЗаполнитьЗначенияСвойств(НовСтр,Структ);
	ЗаполнитьЗначенияСвойств(НовСтр,Продукц);  
	
	НовСтр.ПроцентРучнойСкидки				    = Строка(ПолучитьПроцентРучнойСкидки(Продукц.IDZAKAZA));
	НовСтр.НомерСчетаВАнжелике					= Структ.НомерЗК+"/"+Продукц.НомерСтроки;
	НовСтр.ЕдиницаИзмерения						= Продукц.Номенклатура.ЕдиницаИзмерения;
	НовСтр.Толеранс								= ПолучитьТолеранс(Продукц);
	НовСтр.ЧтоДелатьСЗаказом 					= Структ.ЧтоДелатьСЗаказом;
	НовСтр.Контрагент   						= Структ.Контрагент;
	НовСтр.IDZAKaza 							= Формат(Продукц.IDZAKAZA,"ЧГ=0");

	ПараметрыКабеля = ОбщийМодульИДЗАКИ.ПолучитьПараметрыКабеля(Продукц.Номенклатура);
	ЗаполнитьЗначенияСвойств(НовСтр,ПараметрыКабеля);
	
		
 </details>
 
## Функция ПолучитьТолеранс(Продукц)
 <details> <summary> Код  </summary> 

	Толеранс = "";
	Если не Продукц.ТолерансМинус = 0 тогда
		Толеранс = "-" + Продукц.ТолерансМинус + "%"
	КонецЕсли;                 							
	Если не Продукц.Толеранс = 0 тогда
		Толеранс = Толеранс + " +" + Продукц.Толеранс + "%";	
	КонецЕсли;
	Возврат СокрЛ(Толеранс);
 </details>

## Функция ПолучитьПроцентРучнойСкидки(IDZAKAZA)
 <details> <summary> Код  </summary> 

	Запрос = Новый Запрос;   
	Запрос.УстановитьПараметр("IDZAKaza", IDZAKaza);	
	
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	Товары.ПроцентРучнойСкидки КАК ПроцентРучнойСкидки
	|ИЗ
	|	Документ.ЗаказКлиента.Товары КАК Товары
	|ГДЕ
	|	Товары.IDZAKaza = &IDZAKaza";
	Результат = Запрос.Выполнить().Выгрузить();	
	Возврат ?(Результат.Количество()>0,Результат[0].ПроцентРучнойСкидки,0);
	
 </details>

## Функция ПолучитьСтатусПродукцииНаСервере(IDZAKAZA)
 <details> <summary> Код  </summary> 

   
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("IDZAKaza", IDZAKaza);	
	Запрос.Текст = 
	"ВЫБРАТЬ Первые 1
	|	Продукция.Статус КАК Статус
	|ИЗ
	|	Документ.ЗаказНаПроизводство2_2.Продукция КАК Продукция
	|ГДЕ
	|	Продукция.IDZAKaza = &IDZAKaza
	|	И Продукция.Ссылка.ПометкаУдаления = ЛОЖЬ";
	Результат = Запрос.Выполнить().Выгрузить();
	Если Результат.Количество()>0 тогда 
		Результат = Результат[0].Статус;
	Иначе 
		Результат = Перечисления.СтатусыВПроизводстве.ПустаяСсылка();
	КонецЕсли;
	Возврат Результат
	
 </details>



 </details>

## Процедура ПометитьНаУдалениеЗаказыВ_ЕВ()
 <details> <summary> Код  </summary> 

   
	База = "Danilova_test";
	ПутьКФайлу = "\\dataserv1c\IT-отдел\Obmen\erp_ev\order_list\PometkaUdaleniaZNP.xml";	 
		
	УстановитьПривилегированныйРежим(Истина);	 
 
	//////////////////////////+Отправка/////////////////////////////////////////////////

	Запись = Новый ЗаписьXML;  
	Запись.ОткрытьФайл(ПутьКФайлу, "UTF-8"); 
	Запись.ЗаписатьОбъявлениеXML();     
	Запись.ЗаписатьНачалоЭлемента("Список");
	
	Для каждого Продукц из ЭтотОбъект.Продукция цикл
		Если Продукц.IDZAKaza>0 тогда 
			
			ОбщийМодульИДЗАКИ.СнятьГалкуВРегистреИдзаков(Продукц.IDZAKaza);
			РаботаСоСпецификацией.ОпустошитьСпецификацию(Продукц.Номенклатура, Продукц.IDZAKaza); 
			
			Запись.ЗаписатьНачалоЭлемента("IDZAKaza_" + Формат(Продукц.IDZAKAZA,"ЧГ=0"));  
			Запись.ЗаписатьКонецЭлемента();       
			
		КонецЕсли;    
	КонецЦикла;                         
	Запись.ЗаписатьКонецЭлемента();	
	Запись.Закрыть(); 
	Соединение = Новый HTTPСоединение("1s-1", 80, "Администратор","22170");
	Текст = "/"+База+"/ru/hs/pometka_udalenia_znp";
	Запрос = Новый HTTPЗапрос(Текст);
	Результат = Соединение.Получить(Запрос);	 
	УстановитьПривилегированныйРежим(Ложь);	 
	//////////////////////////-Отправка/////////////////////////////////////////////////
	
 </details>


