
 ## Процедура  СоздатьПустуюСпецификацию(НоменклатураСпецификации, IDZAKAZA_спецификации,ДатаНачалаДействия) экспорт                     	

 <details> <summary> Код  </summary>
	УстановитьПривилегированныйРежим(Истина);       
	//                                                
	
	//
	Специф = Справочники.РесурсныеСпецификации.СоздатьЭлемент();    
	
	
	
	Специф.Родитель 							= Справочники.РесурсныеСпецификации.НайтиПоНаименованию("К распределению");			
	Специф.ТипПроизводственногоПроцесса 		= Перечисления.ТипыПроизводственныхПроцессов.Сборка;
	Специф.ОсновноеИзделиеКоличествоУпаковок 	= 1;
	Специф.ОсновноеИзделиеНоменклатура 			= НоменклатураСпецификации;
	Специф.ОсновноеИзделиеУпаковка 				= Специф.ОсновноеИзделиеНоменклатура.ЕдиницаИзмерения;
	//
	Специф.Наименование 						= Строка(Специф.ОсновноеИзделиеНоменклатура);		
	Специф.НачалоДействия 						= ДатаНачалаДействия;
	Специф.Idzakaza 							= IDZAKAZA_спецификации;  
	Специф.СозданоАвтоматическимАлгоритмом 		= Истина;
	Специф.Статус 								= Перечисления.СтатусыСпецификаций.ВРазработке;
	Специф.ВыпускПроизвольнымиПорциями 			= Истина;
	Специф.СпособРаспределенияЗатратНаВыходныеИзделия = Перечисления.СпособыРаспределенияЗатратНаВыходныеИзделия.ПоДолямСтоимости; 
	Специф.МатериалыИУслуги.Очистить();      
	//
	ВыхИзд 						= Специф.ВыходныеИзделия.Добавить();
	ВыхИзд.Номенклатура 		= Специф.ОсновноеИзделиеНоменклатура; 
	ВыхИзд.КоличествоУпаковок 	= Специф.ОсновноеИзделиеКоличествоУпаковок; 
	ВыхИзд.Упаковка 			= Специф.ОсновноеИзделиеУпаковка; 
	//  
	Специф.Записать();   
	
	СозданиеЭтапа(Специф.Ссылка);
	УстановитьПривилегированныйРежим(Ложь);

</details>  

 ## Процедура ОпустошитьСпецификацию(НоменклатураСпецификации, IDZAKAZA_спецификации) экспорт                     	

 <details> <summary> Код  </summary>
	УстановитьПривилегированныйРежим(Истина);       
	//
	//ДатаНачалаДействия = ТекущаяДата()-60*60*24;          
	//
	Специф = Справочники.РесурсныеСпецификации.НайтиПоРеквизиту("IDZAKAZA",IDZAKAZA_спецификации);
	Если ЗначениеЗаполнено(Специф) тогда 
		Специф = Специф.ПолучитьОбъект();
		Специф.Родитель 							= Справочники.РесурсныеСпецификации.НайтиПоНаименованию("К распределению");			
		Специф.ТипПроизводственногоПроцесса 		= Перечисления.ТипыПроизводственныхПроцессов.Сборка;
		Специф.ОсновноеИзделиеКоличествоУпаковок 	= 1;
		Специф.ОсновноеИзделиеНоменклатура 			= НоменклатураСпецификации;
		Специф.ОсновноеИзделиеУпаковка 				= Специф.ОсновноеИзделиеНоменклатура.ЕдиницаИзмерения;
		//
		Специф.Наименование 						= Строка(Специф.ОсновноеИзделиеНоменклатура);		
		//Специф.НачалоДействия 						= ДатаНачалаДействия;
		Специф.Idzakaza 							= IDZAKAZA_спецификации;  
		Специф.СозданоАвтоматическимАлгоритмом 		= Истина;
		Специф.Статус 								= Перечисления.СтатусыСпецификаций.ВРазработке;
		Специф.ВыпускПроизвольнымиПорциями 			= Истина;
		Специф.СпособРаспределенияЗатратНаВыходныеИзделия = Перечисления.СпособыРаспределенияЗатратНаВыходныеИзделия.ПоДолямСтоимости; 
		Специф.МатериалыИУслуги.Очистить();      
		//                          
		Специф.ВыходныеИзделия.Очистить();
		ВыхИзд 						= Специф.ВыходныеИзделия.Добавить();
		ВыхИзд.Номенклатура 		= Специф.ОсновноеИзделиеНоменклатура; 
		ВыхИзд.КоличествоУпаковок 	= Специф.ОсновноеИзделиеКоличествоУпаковок; 
		ВыхИзд.Упаковка 			= Специф.ОсновноеИзделиеУпаковка; 
		//  
		Специф.Записать();      
		Специф = Справочники.РесурсныеСпецификации.НайтиПоРеквизиту("IDZAKAZA",IDZAKAZA_спецификации).ПолучитьОбъект();
		Специф.Записать();   
	КонецЕсли;
	УстановитьПривилегированныйРежим(Ложь);

</details>  


 ## Процедура СозданиеЭтапа(Владелец)

 <details> <summary> Код  </summary>
	Этап = Справочники.ЭтапыПроизводства.СоздатьЭлемент();
	Этап.Заполнить(Неопределено);
	Этап.Владелец             = Владелец;
	Этап.НомерЭтапа           = 1;
	Этап.НомерСледующегоЭтапа = 0;        	
	Этап.Наименование         = СтрШаблон(НСтр("ru = 'Производство %1';
	|en = 'Manufacturing %1'"), 1); 
	Этап.Подразделение = Справочники.СтруктураПредприятия.НайтиПоНаименованию("Производство");
	Этап.УстановитьСсылкуНового(Справочники.ЭтапыПроизводства.ПолучитьСсылку());
	Этап.Записать();   
	
	

</details>

 ## Функция УсловияДляСозданияПБЗСпецификации(Номенклатура,Подразделение) Экспорт

 <details> <summary> Код  </summary>
	//Автосоздание спецификации если - 
	//А) Подразделение = "Производство","Производство_1", "ЦПМ"
	//Б) Номенклатура.ВидНоменклатуры.НаборСвойств = "Готовая продукция","Товар (б/х, б/с)"
	//В) Номенклатура.Гн_ВидКабеля = "Отходы"
	//Г) Номенклатура = "жгут"
	//Д) Номенклатура = НЕ "жгут", "пруток", "катанка", "канал медный"
	
	Ответ = Ложь;
	Номенкл = НРег(Строка(Номенклатура)); 
	
	Если 	Подразделение.Наименование = "Производство" 
		или Подразделение.Наименование = "Производство_1" 
		или Подразделение.Наименование = "ЦПМ" тогда
		
		Если 	СтрНайти(Номенклатура.ВидНоменклатуры.НаборСвойств.Наименование,"Готовая продукция") 
			или СтрНайти(Номенклатура.ВидНоменклатуры.НаборСвойств.Наименование,"Товар (б/х, б/с)")   
			или СтрНайти(Нрег(Номенклатура.Гн_ВидКабеля.Наименование),"отходы") 
			или СтрНайти(Номенкл,"жгут") тогда
			
			
			Если не(СтрНайти(Номенкл,"шина")>0 
				или СтрНайти(Номенкл,"пруток")>0  
				или СтрНайти(Номенкл,"канал медный")>0 
				или СтрНайти(Номенкл,"катанка")>0) тогда
				Ответ = Истина;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	Возврат Ответ;
</details>


 ## Функция НайтиНужнуюСпецификацию(IDZAKAZA) Экспорт

 <details> <summary> Код  </summary>
	IDZAKAZA_запрос = Число("1" + Сред(Формат(IDZAKAZA,"ЧГ=0"),2));
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("IDZAKAZA", IDZAKAZA_запрос);
	Запрос.Текст = 
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	Спец.Ссылка КАК Ссылка
	|ИЗ
	|	Справочник.РесурсныеСпецификации КАК Спец
	|ГДЕ
	|	Спец.IDZAKAZA = &IDZAKAZA
	|
	|УПОРЯДОЧИТЬ ПО
	|	Спец.НачалоДействия УБЫВ";
	
	
	Результат = Запрос.Выполнить().Выгрузить();
	Если Результат.Количество() = 1 тогда
		Спец = Результат[0].Ссылка;
	Иначе 
		Спец = Справочники.РесурсныеСпецификации.ПустаяСсылка();		
	КонецЕсли;
	Возврат Спец;
</details>


 ## Процедура ЗаполнитьСпецификацию(ТЗ,IDZAKAZA,Признак) Экспорт      	

 <details> <summary> Код  </summary>
	Спецификация = Справочники.РесурсныеСпецификации.НайтиПоРеквизиту("IDZAKAZA",IDZAKAZA);
	Если ЗначениеЗаполнено(Спецификация) тогда
		Спецификация = Спецификация.ПолучитьОбъект();	
		НужнаЗапись = Ложь;
		ТЧ = ?(Признак = "Производственная","МатериалыИУслуги","ВсеВОдномМатериалыИУслугиExpertClass");
		Если СравнениеТЧСпецификаций(ТЗ,Спецификация.Ссылка,ТЧ) тогда  //немножко сравниваем Кол-во и номенкл, чтобы избежать записи
			Спецификация[ТЧ].Загрузить(ТЗ);			 
			НужнаЗапись = Истина;			
		КонецЕсли;
		Если  Спецификация.МатериалыИУслуги.Количество()>0 
			и Спецификация.ВсеВОдномМатериалыИУслугиExpertClass.Количество()>0 
			И Спецификация.Статус <> Перечисления.СтатусыСпецификаций.Действует тогда 			
			Спецификация.Статус = Перечисления.СтатусыСпецификаций.Действует;       
			НужнаЗапись = Истина;
		КонецЕсли;         
		Если НужнаЗапись тогда
			Спецификация.Записать();	        
		КонецЕсли;	
	КонецЕсли;  	

</details>


 ## Функция СравнениеТЧСпецификаций(ТЗ,Спецификация,ТЧ)	

 <details> <summary> Код  </summary>
	Ответ = ложь;                                   
	КоличествоУпаковок = ?(ТЧ = "МатериалыИУслуги","КоличествоУпаковок","ЭталонныйНорматив");
	СП = Спецификация[ТЧ];
	Если ТЗ.Количество() <> СП.Количество() тогда
		Ответ = Истина;
	Иначе
		Для ИН = 0 по СП.Количество()-1 цикл
			Если ТЗ[ИН].Номенклатура <> СП[ИН].Номенклатура или Окр(ТЗ[ИН][КоличествоУпаковок],3) <> СП[ИН][КоличествоУпаковок] тогда					
				Ответ = Истина;
				Прервать;
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;	
	Возврат Ответ
</details>

 ## Процедура ДополнитьПоСпецификацииДляПБЗ(ДОК,ИмяТЧ="МатериалыИРаботы") Экспорт//отходы //08,08,23

 <details> <summary> Код  </summary>
	ДОК.МатериалыИРаботы.Очистить();	
	
	Запрос = Новый Запрос;
	МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	
	Запрос.Текст = Документы.ПроизводствоБезЗаказа.ТекстЗапросаМатериалыПоГруппамЗатрат();
	Запрос.УстановитьПараметр("Дата", ДОК.Дата);
	Запрос.УстановитьПараметр("ВидЦены", ДОК.ВидЦены);
	Запрос.УстановитьПараметр("ЗаполнятьАвтоматически", Истина);
	
	// Подготовим таблицу продукции
	ПоляГруппировки = "НомерГруппыЗатрат, НаправлениеВыпуска, Получатель,
	|	Номенклатура, Характеристика, Серия,
	|	Назначение, Спецификация";
	ПоляСуммирования = "Количество";
	
	ТаблицаПродукции = ДОК.ВыходныеИзделия.Выгрузить(, ПоляГруппировки + ", " + ПоляСуммирования);
	ТаблицаПродукции.Свернуть(ПоляГруппировки, ПоляСуммирования);
	
	ТаблицаПродукции.Колонки.Добавить("Организация",				Новый ОписаниеТипов("СправочникСсылка.Организации"));
	ТаблицаПродукции.Колонки.Добавить("ГруппировкаЗатрат",			Новый ОписаниеТипов("ПеречислениеСсылка.ГруппировкиЗатратВПроизводствеБезЗаказа"));
	ТаблицаПродукции.Колонки.Добавить("Подразделение",				Новый ОписаниеТипов("СправочникСсылка.СтруктураПредприятия"));
	ТаблицаПродукции.Колонки.Добавить("ОшибкаВНастройкахМодели",	Новый ОписаниеТипов("Булево"));
	ТаблицаПродукции.Колонки.Добавить("ОтражатьЗатратыДокументом",	Новый ОписаниеТипов("Булево"));
	
	ТаблицаПродукции.ЗаполнитьЗначения(ДОК.Организация,			"Организация");
	ТаблицаПродукции.ЗаполнитьЗначения(ДОК.ГруппировкаЗатрат,	"ГруппировкаЗатрат");
	ТаблицаПродукции.ЗаполнитьЗначения(ДОК.Подразделение,		"Подразделение");
	ТаблицаПродукции.ЗаполнитьЗначения(Истина,						"ОтражатьЗатратыДокументом");
	
	// Подготовим параметры заполнения
	ДанныеШапки = Новый Структура("Дата", ДОК.Дата);
	
	ПараметрыЗаполнения = Новый Структура("ДанныеШапки",	ДанныеШапки);
	ПараметрыЗаполнения.Вставить("ЗаполнятьАвтоматически",	Истина);
	
	ПереченьДанных = Новый Массив;
	ПереченьДанных.Добавить("МатериалыИУслуги");
	ПараметрыЗаполнения.Вставить("ПереченьДанных", ПереченьДанных);
	
	// Получим данные спецификаций и поместим их в ВТ.
	Документы.ПроизводствоБезЗаказа.ДанныеСпецификацииПоСпискуПродукции(ТаблицаПродукции,
	ПараметрыЗаполнения,
	МенеджерВременныхТаблиц);
	
	// Заполним затраты
	ТаблицаЗатрат = Запрос.Выполнить().Выгрузить();
	
	Если Не ТаблицаЗатрат.Количество() = 0 Тогда
		МассивСтрок = Новый Массив;
		СтруктураПоиска = Новый Структура("НомерГруппыЗатрат", 0);
		
		ТаблицаОбъекта = ДОК[ИмяТЧ]; // ДанныеФормыКоллекция
		Для Каждого ТекЗатрата Из ТаблицаЗатрат Цикл
			
			НоваяСтрока = ТаблицаОбъекта.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяСтрока, ТекЗатрата);
			
			СтруктураПоиска.НомерГруппыЗатрат = НоваяСтрока.НомерГруппыЗатрат;
		КонецЦикла;
	КонецЕсли;

</details>

 ## Процедура ВписатьСпецификациюВДокумент(Документ,БЗ = Ложь) Экспорт    

 <details> <summary> Код  </summary>
	Если БЗ тогда 
		ТЧ = "ВыходныеИзделия"; 
		НужнаЗапись = Ложь;
		ТЗ = Документ[ТЧ].Выгрузить();      	
		Для каждого Стр из ТЗ  цикл       
			Если Стр.IDZAKAZA <> Стр.Спецификация.IDZAKAZA тогда 	//попадаем если спецификация НЕ наша 			
				Стр.Спецификация = Справочники.РесурсныеСпецификации.НайтиПоРеквизиту("IDZAKAZA",Стр.IDZAKAZA);
				//Если она незаполнена тогда очищаем и стираем наличиеСпецификации из заказа
				Если Стр.Спецификация["МатериалыИУслуги"].Количество() = 0 
					или Стр.Спецификация["ВсеВОдномМатериалыИУслугиExpertClass"].Количество() = 0 тогда
					Стр.СпецификацияЗаполнена = Ложь;
				КонецЕсли;
				НужнаЗапись = Истина;
			КонецЕсли;   
		КонецЦикла;   
		Если НужнаЗапись тогда
			Документ = Документ.ПолучитьОбъект(); 
			Документ.Перезаполнение_из_хттп_Сервиса = Истина;
			Документ[ТЧ].Загрузить(ТЗ);
			Документ.Записать();  
		КонецЕсли;
	Иначе    
		НужнаЗапись = Ложь;
		ЕстьСпецуха = Документ.НаличиеСпецификации;
		ТЧ = "Продукция";
		ТЗ = Документ[ТЧ].Выгрузить();      	
		Для каждого Стр из ТЗ  цикл       
			Если Стр.IDZAKAZA <> Стр.Спецификация.IDZAKAZA тогда 	//попадаем если спецификация НЕ наша 			
				НужнаЗапись = ?(Стр.Спецификация.IDZAKAZA > 0,Истина,НужнаЗапись);
				Стр.Спецификация = Справочники.РесурсныеСпецификации.НайтиПоРеквизиту("IDZAKAZA",Стр.IDZAKAZA);
				//Если она незаполнена тогда очищаем и стираем наличиеСпецификации из заказа
				Если Стр.Спецификация["МатериалыИУслуги"].Количество() = 0 или Стр.Спецификация["ВсеВОдномМатериалыИУслугиExpertClass"].Количество() = 0 тогда
					Стр.Спецификация = Справочники.РесурсныеСпецификации.ПустаяСсылка();	
				КонецЕсли;	
				НужнаЗапись = ?(Стр.IDZAKAZA = Стр.Спецификация.IDZAKAZA,Истина,НужнаЗапись);		
			КонецЕсли;   
			ЕстьСпецуха = ?(ЗначениеЗаполнено(Стр.Спецификация) = Ложь,Ложь,ЕстьСпецуха);
		КонецЦикла;   
		Если НужнаЗапись тогда  
			Документ = Документ.ПолучитьОбъект();  
			Документ[ТЧ].Загрузить(ТЗ);
			Документ.НаличиеСпецификации = ЕстьСпецуха;
			Документ.Записать(); 
		КонецЕсли;
	КонецЕсли;                                               

</details>




	


 ## #Область Чтение_файла_new_spec

 <details> <summary> Код  </summary>

 ## Функция ОбработатьФайлик_new_spec(ТЗ,Факт_или_эталон = 1) Экспорт                        

 <details> <summary> Код  </summary>
	//У нас два файлика new_spec_1, new_spec_2 в первом факт, во втором эталон
	ПутьКФайлу =  "\\dataserv1c\IT-отдел\Obmen\erp_ev\new_spec_"+Факт_или_эталон+".xml";       
	
	ЧтениеXML = Новый ЧтениеXML;
	ЧтениеXML.ОткрытьФайл(ПутьКФайлу);
	
	Пока ЧтениеXML.Прочитать() Цикл  
		Если ЧтениеXML.ТипУзла = ТипУзлаXML.НачалоЭлемента Тогда  //Определяем начало элемента			
			Если ЧтениеXML.Имя = "Материалы" или ЧтениеXML.ТипУзла=ТипУзлаXML.КонецЭлемента Тогда	
				Продолжить; 
			ИначеЕсли СтрНачинаетсяС(ЧтениеXML.Имя,"Значения") тогда   
				Отходы 		= Булево(ЧтениеXML.ПолучитьАтрибут(4));
				БЗ 			= Булево(ЧтениеXML.ПолучитьАтрибут(5));
				IDZAKAZA 	= Число (ЧтениеXML.ПолучитьАтрибут(6));
				Признак 	= Строка(ЧтениеXML.ПолучитьАтрибут(7));
				ВставитьСтрочкуТЗ_new_spec(ЧтениеXML,ТЗ);							
			КонецЕсли;
		КонецЕсли;  
	КонецЦикла;   
	ЧтениеXML.Закрыть();  
	Возврат Новый Структура("ТЗ,ОТХОДЫ,БЗ,IDZAKAZA,ПРИЗНАК",ТЗ,ОТХОДЫ,БЗ,IDZAKAZA,ПРИЗНАК);
</details>

 ## Функция ПолучитьДок(БЗ,IDZAKAZA)Экспорт

 <details> <summary> Код  </summary>
	Если БЗ тогда     
		Документ = ОбщийМодульИДЗАКИ.ПолучитьНужныйНамПБЗ(IDZAKAZA);		
	Иначе
		Документ = ОбщийМодульИДЗАКИ.ПолучитьНужныйНамЗНП(IDZAKAZA);
	КонецЕсли;                                                      
	Если Документ.Количество() тогда 
		Документ = Документ[0].Ссылка; 
	Иначе 
		Документ = Неопределено;
	КонецЕсли; 	  
	Возврат Документ; 
</details>	

 ## Функция ФормированиеТЗ_new_spec()Экспорт

 <details> <summary> Код  </summary>
	ТабЗнач = Новый ТаблицаЗначений;
	ТабЗнач.Колонки.Добавить("Код");                                       
	ТабЗнач.Колонки.Добавить("Номенклатура");    
	ТабЗнач.Колонки.Добавить("КоличествоУпаковок");                        
	ТабЗнач.Колонки.Добавить("Количество");                                
	ТабЗнач.Колонки.Добавить("Упаковка");                                  
	ТабЗнач.Колонки.Добавить("ПроизводитсяВПроцессе");                     
	ТабЗнач.Колонки.Добавить("ТребуетсяУказыватьСерии");
	ТабЗнач.Колонки.Добавить("Альтернативный");   
	ТабЗнач.Колонки.Добавить("СпособПолученияМатериалаРедактирование");          
	ТабЗнач.Колонки.Добавить("СпособПолученияМатериала");
	ТабЗнач.Колонки.Добавить("СтатьяКалькуляции"); 		
	ТабЗнач.Колонки.Добавить("ВидОперации"); 
	Возврат ТабЗнач
</details>

 ## Процедура ВставитьСтрочкуТЗ_new_spec(ЧтениеXML, ТЗ) Экспорт  

 <details> <summary> Код  </summary>
	НовСтр 											= ТЗ.Добавить();
	НовСтр.Код 										= ЧтениеXML.ПолучитьАтрибут(0);
	НовСтр.Номенклатура 							= Справочники.Номенклатура.НайтиПоКоду(НовСтр.Код);
	НовСтр.КоличествоУпаковок 						= ЧтениеXML.ПолучитьАтрибут(1);
	НовСтр.Количество 								= ЧтениеXML.ПолучитьАтрибут(1);
	НовСтр.Упаковка 								= НовСтр.Номенклатура.ЕдиницаИзмерения;
	
	НовСтр.ПроизводитсяВПроцессе					= Ложь;
	НовСтр.ТребуетсяУказыватьСерии 					= Ложь;
	НовСтр.Альтернативный 							= Ложь;                        
	НовСтр.СпособПолученияМатериала					= Перечисления.СпособыПолученияМатериаловВСпецификации.Обеспечивать;//30,06
	НовСтр.СпособПолученияМатериалаРедактирование	= Строка(НовСтр.СпособПолученияМатериала);  
	НовСтр.СтатьяКалькуляции 						= Справочники.СтатьиКалькуляции.НайтиПоНаименованию("Статья калькуляции по умолчанию").Ссылка;											
	НовСтр.ВидОперации                              = ЧтениеXML.ПолучитьАтрибут(3);

</details>

</details>
