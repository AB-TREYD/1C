## &НаКлиенте Процедура РаботаСоСпецификациями()

<details>
<summary> Код </summary>
  
  	Если Объект.Проведен и ПроверкаСпецификации=Ложь тогда	
  		Если Объект.Дата > Дата("20220901") тогда
  			Для Каждого Строка из Объект.Продукция Цикл   
  				Если не Пустаястрока(строка.Статус) тогда
  					
  					Если не (СтрНайти(НРег(Строка(Строка.Номенклатура)),"шина")>0 
  						или СтрНайти(НРег(строка(Строка.Номенклатура)),"пруток")>0 
  						или СтрНайти(НРег(строка(Строка.Номенклатура)),"канал медный")>0 
  						или СтрНайти(НРег(строка(Строка.Номенклатура)),"катанка")>0) тогда
  						//Отправка в анжелику
  						Если не Строка.idzak=""	тогда
  							ЗаказКлиента=ПолучитьЗаказКлиента(Объект.ДокументОснование); //Создаем номер счета для Анжелики
  							НомерСчета=СокрЛп(ЗаказКлиента)+"/"+Строка(Строка.НомерСтроки);
  							Если ПроверкаНаСуществованиеСпецификации(Строка.Номенклатура,Строка.IDZAK) Тогда                      //есть спецификаци
  								ОживлениеСпецификации(НомерСчета,строка.IDZak,Строка.Статус,Объект.Дата);                               
  							Иначе	                                                                            //нет спецификации
  								ДанныеДляФормы=СборДанныхДляЗаполненияСпецификации(НомерСчета,Строка.IDZAK, "Массив");	 			
  								//Параметры для формы
  								ПараметрыФормы = новый Структура;                                                                  
  								ПараметрыФормы.Вставить("Номенклатура",Строка.Номенклатура);
  								ПараметрыФормы.Вставить("МассивМатериалыИРаботы",ДанныеДляФормы);
  								ПараметрыФормы.Вставить("Тип", Объект.ТипПроизводственногоПроцесса);						
  								ПараметрыФормы.Вставить("IDZAK", Строка.IDZAK);				
  								ПараметрыФормы.Вставить("ДатаЗаказаНаПроизводство", Объект.Дата);				
  								ПолучитьФорму("Справочник.РесурсныеСпецификации.Форма.ФормаЭлемента",ПараметрыФормы);  //тут создается спецификация и либо все хорошо, либо она помечена удаление
  							КонецЕсли;	                                                                                                                                                                                                                      
  						КонецЕсли;	             
  					КонецЕсли;		
  				КонецЕсли;						
  				
  			КонецЦикла;
  		КонецЕсли;	
  				
  	КонецЕсли;   
  	Если Объект.Дата > Дата("20220901") тогда				
  		Для Каждого Строка из Объект.Продукция Цикл    
  			Если не (СтрНайти(НРег(Строка(Строка.Номенклатура)),"шина")>0
  				или СтрНайти(НРег(строка(Строка.Номенклатура)),"пруток")>0	
  				или СтрНайти(НРег(строка(Строка.Номенклатура)),"канал медный")>0 //20.11.23 
  				или СтрНайти(НРег(строка(Строка.Номенклатура)),"катанка")>0) тогда						
  				ВнесениеСпецификацииВЗаказ(Строка.Номенклатура, Строка.НомерСтроки,Строка.IDZAK);   //если не будет данных о эксперт класс или текущему исполнению тогда будет создана спецификация и после проверки помечена на удаление		  
  			КонецЕсли;					
  		КонецЦикла;	
  		ПроверитьНаличиеСпецификацииВЗаказе();
  		Если СравнитьСпецификациюКлиентССервером() тогда
  			ЭтотОбъект.Записать();
  		КонецЕсли;
  	КонецЕсли;                
	





</details>


## Функция ПроверкаНаСуществованиеСпецификации(Номенклатура, IDZak)		
<details>
<summary> Код </summary>

      
      	////Если Спецификации нет, тогда Возврат = Ложь; в основной функции реализуем ПолучитьФорму()
      	////Если Спецификация есть, тогда Возврат = Истина; в основной функции - новый код 
      	
      	Результат = Ложь;
      	Запрос = Новый Запрос;
      	Запрос.Текст = 
      	"ВЫБРАТЬ
      	|	РесурсныеСпецификации.Наименование КАК Наименование,
      	|	РесурсныеСпецификации.ПометкаУдаления КАК ПометкаУдаления,
      	|	РесурсныеСпецификации.Ссылка КАК Ссылка
      	|ИЗ
      	|	Справочник.РесурсныеСпецификации КАК РесурсныеСпецификации
      	|ГДЕ
      	|	РесурсныеСпецификации.СозданаАвтоматически = ИСТИНА
      	|	И РесурсныеСпецификации.Наименование = &Наименование
      	|	И РесурсныеСпецификации.IDzak = &IDzak";
      	Запрос.УстановитьПараметр("Наименование", Строка(Номенклатура));
      	Запрос.УстановитьПараметр("IDzak", Idzak);
      	РезультатЗапроса = Запрос.Выполнить();	
      	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();	
      	Если ВыборкаДетальныеЗаписи.Следующий() Тогда
      		Результат = Истина;           //Если СУЩЕСТВУЕТ НОВАЯ спецификация 
      	Иначе
      		Результат = Ложь;
      	КонецЕсли;	
      	Возврат Результат;
      КонецФункции // ()

</details>

## Процедура ОживлениеСпецификации(НомерСчета,IDZak,статус,НачалоДействия)		

<details>
<summary> Код </summary>


    	//+10.10.2022
    	Если не нрег(НСтр(СтрокаСоединенияИнформационнойБазы(), "Ref")) = "stavtzev_erp" тогда	
    	Иначе
    		Спецификация=Справочники.РесурсныеСпецификации.НайтиПоРеквизиту("IDZak", IDZak);
    		Спецификация=Спецификация.ПолучитьОбъект();  //+06,10
    		Если Спецификация.НачалоДействия=дата("0001.01.01 00:00:00") тогда
    			Спецификация.НачалоДействия=НачалоДействия;
    			ДатаДействияПравлена=Истина; 			
    		КонецЕсли;	
    		Если Спецификация.КонецДействия=дата("0001.01.01 00:00:00") тогда //+06,10
    			Если статус = Перечисления.СтатусыВПроизводстве.Изготовлен или статус = Перечисления.СтатусыВПроизводстве.НаИспытании тогда						
    				Спецификация.КонецДействия=ТекущаяДата();
    				ДатаДействияПравлена=Истина; 						
    			ИначеЕсли не ДатаДействияПравлена=Истина тогда			
    				ДатаДействияПравлена=Ложь;
    			КонецЕсли;			
    		Иначе
    			Если не (статус = Перечисления.СтатусыВПроизводстве.Изготовлен или статус = Перечисления.СтатусыВПроизводстве.НаИспытании) тогда						
    				Спецификация.КонецДействия=дата("0001.01.01 00:00:00");
    				ДатаДействияПравлена=Истина;			
    			КонецЕсли;			
    		КонецЕсли; //-06,10
    		
    		Если Спецификация.Статус=Перечисления.СтатусыСпецификаций.Закрыта или Спецификация.Статус=Перечисления.СтатусыСпецификаций.ВРазработке тогда        //Проблемная спецификация
    			
    			НетПроизводственнойСпецификации         =СпецификацияОбщийМодуль.ПроверитьЗаполненностьПроизводственной(Спецификация);
    			НетЭталоннойСпецификации                =СпецификацияОбщийМодуль.ПроверитьЗаполненностьЭталона(спецификация);				   			
    			//Тут решения
    			//Спецификация=Спецификация.ПолучитьОбъект();
    			//Производственый
    			Если НетПроизводственнойСпецификации тогда 
    				//поиск производственной
    				ТабЗнач=СборДанныхДляЗаполненияСпецификации(НомерСчета,idzak,"ТЗ");		       
    				Спецификация.МатериалыИУслуги.Очистить();		
    				Спецификация.МатериалыИУслуги.Загрузить(ТабЗнач);		
    			КонецЕсли;  
    			//Эталон
    			Если НетЭталоннойСпецификации тогда    
    				//поиск эталона
    				Запрос=("http://192.168.99.51/Stavtzev_EV/ru/hs/erp?a="+Строка(Спецификация.ОсновноеИзделиеНоменклатура)+"&b="+idzak+""+"&c=ЗапросСТребованиемНормативаЭталона");	
    				ТабЗнач=СпецификацияОбщийМодуль.ОбработкаЗапросаСпецификации(Запрос,"Эталонный",idzak);		
    				Если ТабЗнач.Количество()=0 и не ТабЗнач=неопределено тогда
    				иначе
    					ТабЗнач.Колонки.КоличествоУпаковок.Имя = "ЭталонныйНорматив";   
    					Спецификация.ВсеВОдномМатериалыИУслугиExpertClass.Очистить();
    					Спецификация.ВсеВОдномМатериалыИУслугиExpertClass.Загрузить(ТабЗнач);		
    				КонецЕсли;
    			КонецЕсли;  
    			//Проверка
    			Если СпецификацияОбщийМодуль.ПроверитьЗаполненностьПроизводственной(Спецификация)=ложь и СпецификацияОбщийМодуль.ПроверитьЗаполненностьЭталона(спецификация)=ложь тогда
    				Спецификация.ПометкаУдаления=Ложь;	                          
    				Спецификация.Записать();			
    				Если не Спецификация.ОсновноеИзделиеЭтап  =справочники.ЭтапыПроизводства.ПустаяСсылка() тогда
    					Спецификация.Статус=Перечисления.СтатусыСпецификаций.Действует;                             
    				Иначе	
    					Спецификация.Статус=Перечисления.СтатусыСпецификаций.ВРазработке;					
    				КонецЕсли;	           
    			Иначе
    				Если спецификация.ПометкаУдаления = ложь тогда
    					Спецификация.ПометкаУдаления = истина;
    				конецЕсли
    			КонецЕсли;      
    			Спецификация.Записать();			
    		Иначе
    			Если ДатаДействияПравлена=Истина тогда    //+06,10
    				Спецификация.Записать(); 
    			КонецЕсли;   	              //-06,10
    			
    			
    		КонецЕсли;
    	КонецЕсли;


</details>

## Функция СборДанныхДляЗаполненияСпецификации(НомерСчета,idzak, признак) экспорт     


<details>
<summary> Код </summary>

        	//+10.10.2022
        	Если не нрег(НСтр(СтрокаСоединенияИнформационнойБазы(), "Ref")) = "stavtzev_erp" тогда Возврат Неопределено КонецЕсли;	
        	//-10.10.2022
        	Данные=Новый структура;                             //Здесь заполняем спецификацию для текущего варианта исполнения
        	Данные.Вставить("НомерСчета",НомерСчета);    	
        	УстановитьПривилегированныйРежим(Истина);	
        	Запрос="http://192.168.99.51/Stavtzev_EV/ru/hs/erp?a="+idzak+"&b="+"0"+""+"&c=ЗапросСТребованиемПроизводственногоНорматива";
        	ТабЗнач=СпецификацияОбщийМодуль.ОбработкаЗапросаСпецификации(Запрос,"Производственный",Idzak);	
        	ЕСли ТабЗнач.Количество() > 0 Тогда
        		УстановитьПривилегированныйРежим(Ложь); 
        		МассивМатериалыИРаботы=Новый массив(20,13);
        		индекс=0;
        		Для каждого строка из ТабЗнач цикл		//Переделать под ТЧ.Загрузить(ТЗ.выгрузить())	
        			МассивМатериалыИРаботы[индекс][0]=строка.код;
        			МассивМатериалыИРаботы[индекс][1]=строка.номенклатура;
        			МассивМатериалыИРаботы[индекс][2]=строка.КоличествоУпаковок;  
        			МассивМатериалыИРаботы[индекс][3]=строка.Количество;                
        			МассивМатериалыИРаботы[индекс][4]=строка.Упаковка;
        			МассивМатериалыИРаботы[индекс][5]=строка.ПроизводитсяВПроцессе;
        			МассивМатериалыИРаботы[индекс][6]=строка.ТребуетсяУказыватьСерии;
        			МассивМатериалыИРаботы[индекс][7]=строка.Альтернативный;
        			МассивМатериалыИРаботы[индекс][8]=строка.СпособПолученияМатериалаРедактирование;
        			МассивМатериалыИРаботы[индекс][9]=строка.СтатьяКалькуляции;     
        			МассивМатериалыИРаботы[индекс][10]=строка.ВидОперации; //21,09
        			индекс=индекс+1;
        		КонецЦикла;      
        	Иначе                                             //Делаем пустышку
        		МассивМатериалыИРаботы=Новый массив(20,13);
        		индекс=0;				
        		МассивМатериалыИРаботы[индекс][0]="00000002585";
        		МассивМатериалыИРаботы[индекс][1]=Справочники.Номенклатура.НайтиПоКоду(МассивМатериалыИРаботы[индекс][0]).Ссылка;
        		МассивМатериалыИРаботы[индекс][2]=0.01;
        		МассивМатериалыИРаботы[индекс][3]=0.01;
        		МассивМатериалыИРаботы[индекс][4]=Справочники.УпаковкиЕдиницыИзмерения.НайтиПоНаименованию("кг");
        		МассивМатериалыИРаботы[индекс][5]=Ложь;
        		МассивМатериалыИРаботы[индекс][6]=Ложь;
        		МассивМатериалыИРаботы[индекс][7]=Ложь;
        		МассивМатериалыИРаботы[индекс][8]="Обеспечивать";
        		МассивМатериалыИРаботы[индекс][9]=Справочники.СтатьиКалькуляции.НайтиПоНаименованию("Статья калькуляции по умолчанию");
        	КонецЕсли;    
        	Если признак="ТЗ" тогда
        		Возврат ТабЗнач;
        	Иначе
        		Возврат МассивМатериалыИРаботы;
        	КонецЕсли;	
</details>

## Функция СравнитьСпецификациюКлиентССервером()

<details>
<summary> Код </summary>

    	Если Объект.Продукция.Количество()=Объект.Ссылка.Продукция.Количество() тогда
    		Для каждого Стр из Объект.Продукция цикл
    			Если не Стр.Спецификация=Объект.ссылка.Продукция[Стр.НомерСтроки-1].Спецификация тогда			
    				Возврат Истина; 
    			Иначе
    				Если не Объект.НаличиеСпецификации=Объект.Ссылка.НаличиеСпецификации тогда
    					Возврат Истина	
    				КонецЕсли;
    			КонецЕсли;
    		КонецЦикла;
    	Иначе
    		Возврат Истина;
    	КонецЕсли;
    	Возврат ложь;



</details>
