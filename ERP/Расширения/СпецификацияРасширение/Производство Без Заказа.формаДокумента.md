##  Функция ОтправкаБЗ(Структура)	//отправляет в анжелику заказ!	

<details>
  <summary>
    Код
  </summary>

      	Удачно=ложь;   
      	ВозвратныйIDZak="";
      	Если не Нрег(нСтр(СтрокаСоединенияИнформационнойБазы(), "Ref")) = "erp" тогда	
      	Иначе  
      		Если Объект.Подразделение.Наименование="Производство" 
      			или Объект.Подразделение.Наименование="Производство_1" 
      			или Объект.Подразделение.Наименование="ЦПМ"тогда     
      			//Для каждого строки из Объект.ВыходныеИзделия Цикл     
      			УстановитьПривилегированныйРежим(Истина);
      			Если СтрНайти(Структура.Номенклатура.ВидНоменклатуры.НаборСвойств.Наименование,"Готовая продукция") 
      				или  СтрНайти(Структура.Номенклатура.ВидНоменклатуры.НаборСвойств.Наименование,"Товар (б/х, б/с)")   
      				или стрНайти(нрег(Строка(Структура.Номенклатура.Гн_ВидКабеля)),"отходы") 
      				или стрНайти(нрег(Строка(Структура.Номенклатура)),"жгут") тогда	 //отходы //08,08,23
      				Дата=Структура.Дата;
      				УстановитьПривилегированныйРежим(Ложь);
      				Если не (СтрНайти(НРег(строка(Структура.Номенклатура)),"шина")>0 
      					или СтрНайти(НРег(строка(Структура.Номенклатура)),"пруток")>0  
      					или СтрНайти(НРег(строка(Структура.Номенклатура)),"канал медный")>0 //20.10.23
      					или СтрНайти(НРег(строка(Структура.Номенклатура)),"катанка")>0) тогда
      					УстановитьПривилегированныйРежим(Истина);
      					Если не Структура.Номер = "" Тогда     
      						
      						НомерДокумента = СокрЛП(Структура.Номер);			
      						БЗномер=СтрЗаменить(НомерДокумента,Сред(НомерДокумента,СтрНайти(НомерДокумента,"--"),4),"--БЗ");
      						Ном=БЗномер;
      						//Заполняем XML-файл...+26.10.2021
      						ФайликXML = Новый ЗаписьXML;
      						ФайликXML.ОткрытьФайл("\\192.168.99.2\obmen\anj.xml");
      						ФайликXML.ЗаписатьОбъявлениеXML();
      						НазваниеФайла = СтрЗаменить("ЗаказКлиента_" + Ном + "_Позиция_" + Ном + "__" + Структура.КодСтроки, " ", "");
      						ФайликXML.ЗаписатьНачалоЭлемента(НазваниеФайла);
      						ФайликXML.ЗаписатьНачалоЭлемента("СтрокаСостава");
      						ФайликXML.ЗаписатьАтрибут("Номенклатура",Строка(Структура.Номенклатура)); //а                      //0
      						ФайликXML.ЗаписатьАтрибут("ПроцентРучнойСкидки",""); //b						                   //1
      						ФайликXML.ЗаписатьАтрибут("НомерСчетаВАнжелике",Строка(СокрЛП(Ном)+"/"+Структура.КодСтроки)); //f  //2					
      						ФайликXML.ЗаписатьАтрибут("ДлинаЗаказа",Строка(Структура.КоличествоУпаковок)); //d  			   //3		
      						ФайликXML.ЗаписатьАтрибут("ДатаЗаказа",Строка(Дата)); //g						                   //4
      						ФайликXML.ЗаписатьАтрибут("Комментарий",""); //h						                           //5
      						ФайликXML.ЗаписатьАтрибут("Примечание",""); //i                                                    //6
      						ФайликXML.ЗаписатьАтрибут("Намотка",""); //j                                                       //7
      						ФайликXML.ЗаписатьАтрибут("ЕдиницаИзмерения",Строка(Структура.Номенклатура.ЕдиницаИзмерения)); //k //8      +07,10
      						ФайликXML.ЗаписатьАтрибут("Толеранс","");                                                          //9
      						ФайликXML.ЗаписатьАтрибут("ДатаВыпуска",Строка(Дата));                                             //10
      						ФайликXML.ЗаписатьАтрибут("ПроизводствоБезЗаказа","ПроизводствоБезЗаказа");                        //11
      						ФайликXML.ЗаписатьАтрибут("КомментарийНестандартнойКонструкции", "");                              //12 //Минайкин 23.06.23 Нестандартная конструкция
      						ФайликXML.ЗаписатьАтрибут("БулевоНестандартнойКонструкции", Строка("Ложь"));                       //13
      						
      						ПараметрыКабеля = ПолучениеПараметровКабеля(Структура.Номенклатура);
      						
      						//Минайкин 16.08.23 Передача в Expert V параметров кабеля, вместо номенклатуры
      						ФайликXML.ЗаписатьАтрибут("ВидКабеля",             Строка(ПараметрыКабеля.ВидКабеля));             // 14
      						ФайликXML.ЗаписатьАтрибут("МаркаКабеля",           Строка(ПараметрыКабеля.МаркаКабеля));           // 15
      						ФайликXML.ЗаписатьАтрибут("КоличествоЖил",         Строка(ПараметрыКабеля.КоличествоЖил));         // 16
      						ФайликXML.ЗаписатьАтрибут("Сечение",               Строка(ПараметрыКабеля.Сечение));               // 17
      						ФайликXML.ЗаписатьАтрибут("Напряжение",            Строка(ПараметрыКабеля.Напряжение));            // 18
      						ФайликXML.ЗаписатьАтрибут("Исполнение",            Строка(ПараметрыКабеля.Исполнение));            // 19
      						ФайликXML.ЗаписатьАтрибут("ВидИсполнения",         Строка(ПараметрыКабеля.ВидИсполнения));         // 20
      						ФайликXML.ЗаписатьАтрибут("NPE",                   Строка(ПараметрыКабеля.NPE));                   // 21
      						ФайликXML.ЗаписатьАтрибут("СечениеЭкрана",         Строка(ПараметрыКабеля.СечениеЭкрана));         // 22
      						ФайликXML.ЗаписатьАтрибут("Цвет",                  Строка(ПараметрыКабеля.Цвет));                  // 23
      						ФайликXML.ЗаписатьАтрибут("ПлюсовойКабель",        Строка(ПараметрыКабеля.ПлюсовойКабель));        // 24
      						ФайликXML.ЗаписатьАтрибут("ИсполнениеПлюсовой",    Строка(ПараметрыКабеля.ИсполнениеПлюсовой));    // 25
      						ФайликXML.ЗаписатьАтрибут("КоличествоЖилПлюсовой", Строка(ПараметрыКабеля.КоличествоЖилПлюсовой)); // 26
      						ФайликXML.ЗаписатьАтрибут("СечениеЖилыПлюсовой",   Строка(ПараметрыКабеля.СечениеЖилыПлюсовой));   // 27
      						ФайликXML.ЗаписатьАтрибут("Менеджер",   		   Строка(Структура.Менеджер));   				   // 28
      						
      						ФайликXML.ЗаписатьКонецЭлемента();		
      						ФайликXML.ЗаписатьКонецЭлемента();
      						СтрXML = ФайликXML.Закрыть(); 
      						Соединение = Новый HTTPСоединение("1s-1", 80, "Администратор","22170");
      						Текст = "/anjelika/ru/hs/zakaz";
      						Запрос = Новый HTTPЗапрос(Текст);
      						Результат = Соединение.Получить(Запрос);			                                        			
      						УстановитьПривилегированныйРежим(Ложь);	 					
      						ВозвратныйIDZak=СтрЗаменить(Результат.Заголовки.Получить("IDzak"),"?"," ");			
      					Иначе
      					КонецЕсли;	
      				КонецЕсли;                                 
      				Удачно=Истина;
      			КонецЕсли;
      		КонецЕсли; 
      	КонецЕсли;       
      	Результат=Новый структура;
      	Результат.Вставить("Удачно",Удачно);
      	Результат.Вставить("IDZak",ВозвратныйIDZak);
      	Возврат Результат;

</details>



## &Наклиенте Процедура ОтправитьВEV(СтрокаТЧ)

 
<details>
  <summary>
    Код
  </summary>


  
        МожноОтправлять=Истина;
        	//+Данилова 25.07              //кнопка работать не будет
        	//ТекущийКодСтроки=ЭтаФорма.Элементы.ВыходныеИзделия.ТекущиеДанные.НомерСтроки;  
        	ТекущийКодСтроки=СтрокаТЧ.НомерСтроки;
        	//-Данилова	
        	
        	Ответ=201; //нужен чтобы зайти ниже по условиям
        	Если Объект.ВыходныеИзделия[ТекущийКодСтроки-1].idzak<>"" тогда
        		
        		Ответ=УдалитьПроизводствоБезЗаказаИзEV(Объект.ВыходныеИзделия[ТекущийКодСтроки-1].idzak,Объект.ВыходныеИзделия[ТекущийКодСтроки-1].Номенклатура);	
        		Если Ответ=410 тогда       //Удалён или отсутствует        
        			ПараметрыОтбора = Новый Структура;
        			ПараметрыОтбора.Вставить("НомерСтроки", ТекущийКодСтроки);    
        			Строки=Объект.ВыходныеИзделия.НайтиСтроки(ПараметрыОтбора);
        			Строки[0].idzak="";
        			МожноОтправлять=Истина;
        		ИначеЕсли ответ=200 тогда //не удалён т.к. номенклатура совпадает
        			МожноОтправлять=Истина;  
        		Иначе
        			//всё остальное
        			МожноОтправлять=Ложь;  
        		КонецЕсли;
        	КонецЕсли;
        	Если МожноОтправлять тогда  
        		Если Ответ=200 тогда
        		иначе                  
        			Структ=Новый структура;
        			Структ.Вставить("КодСтроки",ТекущийКодСтроки);
        			Структ.Вставить("Номенклатура",Объект.ВыходныеИзделия[ТекущийКодСтроки-1].Номенклатура);
        			Структ.Вставить("idzak",Объект.ВыходныеИзделия[ТекущийКодСтроки-1].idzak);
        			Структ.Вставить("КоличествоУпаковок",Объект.ВыходныеИзделия[ТекущийКодСтроки-1].КоличествоУпаковок);
        			Структ.Вставить("Номер",Объект.Номер);
        			Структ.Вставить("Дата",Объект.Дата);
        			Структ.Вставить("Менеджер",Объект.Ответственный);
        			УдачноОтправлена=ОтправкаБЗ(Структ);    //отправка Заказа в ЕВ    
        			ПараметрыОтбора = Новый Структура;
        			ПараметрыОтбора.Вставить("НомерСтроки", ТекущийКодСтроки);    
        			Строки=Объект.ВыходныеИзделия.НайтиСтроки(ПараметрыОтбора);
        			Строки[0].idzak=УдачноОтправлена.idzak;
        			УдачноОтправлена=?(УдачноОтправлена.idzak<>"",Истина,ложь);  			
        		КонецЕсли;
        		Если ответ=200 или УдачноОтправлена тогда
        			РаботаСоСпецификациями(ТекущийКодСтроки); 
        			
        			Если  ПолучитьВидНоменклатурыССервера(СтрокаТЧ.Номенклатура) или стрНайти(нрег(Строка(СтрокаТЧ.Номенклатура)),"жгут") тогда      
        				Если не ИзменилсяСкладВМатериалыИРаботы тогда      
        					Объект.МатериалыИРаботы.Очистить();    //Стирает склад и не дает вписать его руками...
        					ДополнитьПоСпецификацииНаСервере("МатериалыИРаботы");
        				КонецЕсли;				
        			КонецЕсли;     
        			
        		иначе  
        		КонецЕсли; 
        	КонецЕсли;     
        КонецПроцедуры

</details>


## Функция ПолучитьВидНоменклатурыССервера(Номенклатура)     
	
Возвращает истина/ложь в зависимости от типа номенклатуры(если отходы то истина)

<details>
  <summary>
    Код
  </summary>

  
      УстановитьПривилегированныйРежим(Истина);
      
        Если стрНайти(нрег(Строка(Номенклатура.Гн_ВидКабеля)),"отходы")   тогда
          возврат истина
        иначе
          возврат ложь
        КонецЕсли;
      УстановитьПривилегированныйРежим(Ложь);

</details>


	

