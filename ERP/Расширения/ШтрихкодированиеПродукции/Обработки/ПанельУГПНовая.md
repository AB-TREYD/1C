
## &НаКлиенте Процедура СоздатьЗадание(Команда)

<details>
<summary> Код </summary>
  
	Если Не БезУпаковкиДляБухт И Не НовыйПаллет И ДоступныеПаллеты.Пустая() И  (Элементы.ГруппаУпаковок.Видимость) Тогда
		Сообщить("Необходимо выбрать упаковку");
	ИначеЕсли Не БезУпаковкиДляБухт И НовыйПаллет И КоличествоУпаковок < 1 тогда
		Сообщить("Количество упаковок не задано");
	Иначе
		Режим = РежимДиалогаВопрос.ДаНет;   
		стрВопрос  = СтрШаблон("Вы готовы создать %1 этикеток (%2 %3 [%4]) для %5%6?",
			Формат(НарезкаКоличество,"ЧДЦ=0"),Формат(НарезкаВсего,"ЧДЦ=3"),Строка(ЕдИзм),Строка(ТараНамотки),Строка(НарезкаНоменклатура),
		?(ТолКоличество = 0,"",СтрШаблон(" и %1 этикеток толеранса (%2 %3 [%4])?",
			Формат(ТолКоличество,"ЧДЦ=0"),Формат(ТолВсего,"ЧДЦ=3"),Строка(ТолЕдИзм),Строка(ТолТараНамотки))));		
		
		Ответ = Вопрос(стрВопрос, Режим, 0);
		Если Ответ = КодВозвратаДиалога.Да Тогда
			СоздатьЗаданияИУпаковки(); 
			Элементы.ГруппаНарезки.Видимость = Ложь;
		Иначе 
			Элементы.ГруппаНарезки.Видимость = Истина;
		КонецЕсли;
	КонецЕсли; 
	
	//+Минайкин Н. 20.03.24
	СозданиеДокументовПоСписаниюКатушки();	
	//-Минайкин Н. 20.03.24                
	
</details>

## Процедура СозданиеДокументовПоСписаниюКатушки()

<details>
<summary> Код </summary>
  
	УстановитьПривилегированныйРежим(Истина);
	Если    ДиаметрБарабана = Перечисления.Тара.Б8 
		Или ДиаметрБарабана = Перечисления.Тара.Б10
		Или ДиаметрБарабана = Перечисления.Тара.Б12
		Или ДиаметрБарабана = Перечисления.Тара.Б14
		Или ДиаметрБарабана = Перечисления.Тара.Б16
		Или ДиаметрБарабана = Перечисления.Тара.Б18
		Или ДиаметрБарабана = Перечисления.Тара.Б20
		Или ДиаметрБарабана = Перечисления.Тара.Б22 Тогда
		
		НоменклатураТекущегоБарабана = Справочники.Номенклатура.НайтиПоНаименованию("Комплект кабельных барабанов № " + СтрЗаменить(Строка(ДиаметрБарабана), "Б", ""));
		
		Если ПроверкаНаНаличиеДанныхБарабановВТоварахНаСкладах(НоменклатураТекущегоБарабана) Тогда
			
			ЗаказНаПриобретенияТовара = ПолучитьЗаказНаПриобритениеТовара(НоменклатураТекущегоБарабана);
			
			Если ЗаказНаПриобретенияТовара = Неопределено Тогда
				Сообщить("Для номенклатурной позиции " + Строка(НоменклатураТекущегоБарабана) + " не завёдено приобретение товаров и услуг");			
			Иначе 		
				СоздатьДокументПеремещенияТовара(НоменклатураТекущегоБарабана, ЗаказНаПриобретенияТовара);
				
				СоздатьДокументВнутреннегоПотребления(НоменклатураТекущегоБарабана);
			КонецЕсли; 
			
		Иначе
			СоздатьДокументВнутреннегоПотребления(НоменклатураТекущегоБарабана);
		КонецЕсли;
	КонецЕсли;
	УстановитьПривилегированныйРежим(Ложь);
	                     
</details>

## Процедура СоздатьДокументВнутреннегоПотребления(НоменклатураТекущегоБарабана)

<details>
<summary> Код </summary>
  
	НовыйДокументПотребления = Документы.ВнутреннееПотребление.СоздатьДокумент();
	
	НовыйДокументПотребления.Дата = ТекущаяДата() + 1;
	
	НовыйДокументПотребления.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.СписаниеТоваровПоТребованию;
	НовыйДокументПотребления.Организация           = Справочники.Организации.НайтиПоНаименованию("КЗ ""ЭКСПЕРТ-КАБЕЛЬ""");
	НовыйДокументПотребления.Подразделение         = Справочники.СтруктураПредприятия.НайтиПоНаименованию("Производство");
	НовыйДокументПотребления.Склад                 = Справочники.Склады.НайтиПоНаименованию("Склад НЗП УГП");
	НовыйДокументПотребления.Ответственный         = Пользователи.ТекущийПользователь();
	
	НоваяСтрокаТЧ = НовыйДокументПотребления.Товары.Добавить();
	
	НоваяСтрокаТЧ.Номенклатура       = НоменклатураТекущегоБарабана;
	НоваяСтрокаТЧ.КоличествоУпаковок = Число(1);
	НоваяСтрокаТЧ.Упаковка           = Справочники.УпаковкиЕдиницыИзмерения.НайтиПоНаименованию("Шт"); 
	НоваяСтрокаТЧ.СтатьяРасходов     = ПланыВидовХарактеристик.СтатьиРасходов.НайтиПоНаименованию("Вспомогательные материалы (счет 26)"); 
	
	НовыйДокументПотребления.Записать(РежимЗаписиДокумента.Проведение);
	                     
</details>

## Процедура СоздатьДокументПеремещенияТовара(НоменклатураТекущегоБарабана, ЗаказНаПриобретенияТовара)

<details>
<summary> Код </summary>
  
	НовыйДокументПеремещенииТовара = Документы.ПеремещениеТоваров.СоздатьДокумент(); 
	
	НовыйДокументПеремещенииТовара.Заполнить(ЗаказНаПриобретенияТовара); 
	
	НовыйДокументПеремещенииТовара.Дата = ТекущаяДата(); 
	
	НовыйДокументПеремещенииТовара.ДокументОснование = ЗаказНаПриобретенияТовара; 
	
	НовыйДокументПеремещенииТовара.СкладПолучатель  = Справочники.Склады.НайтиПоНаименованию("Склад НЗП УГП"); 
	НовыйДокументПеремещенииТовара.СкладОтправитель = Справочники.Склады.НайтиПоНаименованию("Склад непроизводственных материалов");
	НовыйДокументПеремещенииТовара.Организация      = Справочники.Организации.НайтиПоНаименованию("КЗ ""ЭКСПЕРТ-КАБЕЛЬ""");
	НовыйДокументПеремещенииТовара.Дп_Отправил      = Пользователи.ТекущийПользователь();
	НовыйДокументПеремещенииТовара.Дп_Получил       = Пользователи.ТекущийПользователь(); 
	
	НоваяСтрокаТЧ = НовыйДокументПеремещенииТовара.Товары.Добавить();
	
	НоваяСтрокаТЧ.Номенклатура       = НоменклатураТекущегоБарабана;
	НоваяСтрокаТЧ.КоличествоУпаковок = Число(1);
	НоваяСтрокаТЧ.Упаковка           = Справочники.УпаковкиЕдиницыИзмерения.НайтиПоНаименованию("Шт");  	
	
	НовыйДокументПеремещенииТовара.Записать(РежимЗаписиДокумента.Проведение);
 
</details>

## Функция ПолучитьЗаказНаПриобритениеТовара(НоменклатураТекущегоБарабана)

<details>
<summary> Код </summary>
  
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ПриобретениеТоваровУслуг.Ссылка КАК Ссылка
	|ИЗ
	|	Документ.ПриобретениеТоваровУслуг КАК ПриобретениеТоваровУслуг
	|ГДЕ
	|	ПриобретениеТоваровУслуг.Товары.Номенклатура = &Номенклатура
	|	И ПриобретениеТоваровУслуг.Дата >= &Дата";
	
	Запрос.УстановитьПараметр("Номенклатура", НоменклатураТекущегоБарабана);
	Запрос.УстановитьПараметр("Дата", ДобавитьМесяц(ТекущаяДата(), -3));
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		
		Отбор = Новый Структура();
		
		Отбор.Вставить("Номенклатура", НоменклатураТекущегоБарабана);
		
		НайденноеЗначение = ВыборкаДетальныеЗаписи.Ссылка.Товары.НайтиСтроки(Отбор);
		
		Запрос2 = Новый Запрос;
		Запрос2.Текст = 
		"ВЫБРАТЬ
		|	СвязанныеДокументы.Ссылка КАК Ссылка
		|ИЗ
		|	КритерийОтбора.СвязанныеДокументы(&Значение) КАК СвязанныеДокументы
		|ГДЕ
		|   ТИПЗНАЧЕНИЯ(СвязанныеДокументы.Ссылка) = &ТипСсылки";
		
		Запрос2.УстановитьПараметр("Значение", ВыборкаДетальныеЗаписи.Ссылка);   
		Запрос2.УстановитьПараметр("ТипСсылки", Тип("ДокументСсылка.ПеремещениеТоваров"));
		
		РезультатЗапроса2 = Запрос2.Выполнить();
		
		ВыборкаДетальныеЗаписи2 = РезультатЗапроса2.Выбрать();
		
		КоличествоЗаказовНаПеремещениеСДаннымБарабаном = Новый Массив;
		
		Пока ВыборкаДетальныеЗаписи2.Следующий() Цикл
			
			Для каждого ТЧТоваров из ВыборкаДетальныеЗаписи2.Ссылка.Товары Цикл
				
				Если СтрНайти(ТЧТоваров.Номенклатура, НоменклатураТекущегоБарабана) Тогда
					КоличествоЗаказовНаПеремещениеСДаннымБарабаном.Добавить(ВыборкаДетальныеЗаписи2.Ссылка);
					Прервать;
				КонецЕсли;
				
			КонецЦикла;
			
		КонецЦикла;
		
		Если НайденноеЗначение[0].КоличествоУпаковок - КоличествоЗаказовНаПеремещениеСДаннымБарабаном.Количество() > 0 Тогда 
			Возврат ВыборкаДетальныеЗаписи.Ссылка;
		КонецЕсли;
		
	КонецЦикла;
	
	Возврат Неопределено;
	                     
</details>

## ПроверкаНаНаличиеДанныхБарабановВТоварахНаСкладах(НоменклатураТекущегоБарабана)

<details>
<summary> Код </summary>
  
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ТоварыНаСкладахОстаткиИОбороты.Склад КАК Склад,
		|	ТоварыНаСкладахОстаткиИОбороты.Номенклатура КАК Номенклатура,
		|	ТоварыНаСкладахОстаткиИОбороты.ВНаличииНачальныйОстаток КАК ВНаличииНачальныйОстаток,
		|	ТоварыНаСкладахОстаткиИОбороты.ВНаличииКонечныйОстаток КАК ВНаличииКонечныйОстаток,
		|	ТоварыНаСкладахОстаткиИОбороты.ВНаличииПриход КАК ВНаличииПриход,
		|	ТоварыНаСкладахОстаткиИОбороты.ВНаличииРасход КАК ВНаличииРасход
		|ИЗ
		|	РегистрНакопления.ТоварыНаСкладах.ОстаткиИОбороты КАК ТоварыНаСкладахОстаткиИОбороты
		|ГДЕ
		|	ТоварыНаСкладахОстаткиИОбороты.Номенклатура = &Номенклатура
		|	И ТоварыНаСкладахОстаткиИОбороты.Склад = &Склад";
	
	Запрос.УстановитьПараметр("Номенклатура", НоменклатураТекущегоБарабана);
	Запрос.УстановитьПараметр("Склад",  Справочники.Склады.НайтиПоНаименованию("Склад НЗП УГП"));
	
	РезультатЗапроса = Запрос.Выполнить();                                                   
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		
		Если ВыборкаДетальныеЗаписи.ВНаличииКонечныйОстаток = 0 Тогда
			Возврат Истина;
		Иначе
			Возврат Ложь;
		КонецЕсли;
		
	КонецЦикла;
 
</details>
